{"version":3,"file":"index-Dw5fUlKF.js","sources":["../../src/engine/world/map.ts","../../src/engine/systems/pathfinding.ts","../../src/engine/world/indices.ts","../../src/engine/world/validation.ts","../../src/engine/systems/economy.ts","../../src/engine/systems/needs.ts","../../src/engine/systems/social.ts","../../src/engine/world/inventory.ts","../../src/engine/dna.ts","../../src/engine/systems/chemistry.ts","../../src/engine/world/itemAnalyzer.ts","../../src/engine/world/items.ts","../../src/engine/systems/crafting.ts","../../src/engine/systems/chemistryEvaluation.ts","../../src/engine/world/stockpile.ts","../../src/engine/GameEngine.ts","../../src/ui/GameUI.ts","../../src/main.ts"],"sourcesContent":["/**\n * World map with grid-based tile system\n */\n\nexport enum TileType {\n  Road = 'road',\n  Building = 'building',\n  Water = 'water',\n}\n\nexport interface Tile {\n  type: TileType;\n  walkable: boolean;\n}\n\nexport interface Vec2 {\n  x: number;\n  y: number;\n}\n\nexport interface POI {\n  id: string;\n  name: string;\n  pos: Vec2;\n  footprint?: Vec2; // Optional size (width, height)\n}\n\nexport class WorldMap {\n  readonly width: number;\n  readonly height: number;\n  private tiles: Tile[][];\n  private pois: POI[];\n\n  constructor(width: number, height: number) {\n    this.width = width;\n    this.height = height;\n    this.tiles = [];\n    this.pois = [];\n    this.initializeGrid();\n  }\n\n  private initializeGrid(): void {\n    // Initialize all tiles as roads (walkable)\n    for (let y = 0; y < this.height; y++) {\n      const row: Tile[] = [];\n      for (let x = 0; x < this.width; x++) {\n        row.push({\n          type: TileType.Road,\n          walkable: true,\n        });\n      }\n      this.tiles.push(row);\n    }\n  }\n\n  /**\n   * Generate a simple procedural city layout\n   */\n  generateCity(): void {\n    // Create a simple city with roads and buildings\n    // Main roads (horizontal and vertical)\n    const mainRoadInterval = 8;\n    \n    // Place buildings in a grid pattern with roads between\n    for (let y = 0; y < this.height; y++) {\n      for (let x = 0; x < this.width; x++) {\n        // Main roads\n        if (x % mainRoadInterval === 0 || y % mainRoadInterval === 0) {\n          this.setTile(x, y, TileType.Road, true);\n        }\n        // Create some buildings in blocks\n        else if (\n          (x % mainRoadInterval > 1 && x % mainRoadInterval < mainRoadInterval - 1) &&\n          (y % mainRoadInterval > 1 && y % mainRoadInterval < mainRoadInterval - 1)\n        ) {\n          // 70% chance of building in the interior - use deterministic pattern\n          const hash = (x * 73 + y * 31) % 10;\n          if (hash < 7) {\n            this.setTile(x, y, TileType.Building, false);\n          }\n        }\n      }\n    }\n\n    // Add water/blocked areas on edges (deterministic positions)\n    const waterPositions = [\n      [2, 3], [5, 1], [1, 6], [4, 2], [6, 5],\n      [3, 4], [7, 0], [0, 7], [2, 1], [5, 6]\n    ];\n    \n    for (const [dx, dy] of waterPositions) {\n      this.setTile(dx, dy, TileType.Water, false);\n      this.setTile(this.width - 1 - dx, this.height - 1 - dy, TileType.Water, false);\n    }\n\n    // Initialize POIs\n    this.initializePOIs();\n  }\n\n  private initializePOIs(): void {\n    // Place POIs at strategic locations on roads\n    this.pois = [\n      {\n        id: 'guild-hall',\n        name: 'Guild Hall',\n        pos: { x: 32, y: 32 }, // Center of map\n        footprint: { x: 2, y: 2 },\n      },\n      {\n        id: 'tavern',\n        name: 'Tavern',\n        pos: { x: 16, y: 16 },\n        footprint: { x: 2, y: 2 },\n      },\n      {\n        id: 'market',\n        name: 'Market',\n        pos: { x: 48, y: 16 },\n        footprint: { x: 3, y: 3 },\n      },\n      {\n        id: 'mine',\n        name: 'Mine',\n        pos: { x: 8, y: 48 },\n        footprint: { x: 2, y: 2 },\n      },\n      {\n        id: 'forest',\n        name: 'Forest',\n        pos: { x: 56, y: 48 },\n        footprint: { x: 3, y: 3 },\n      },\n    ];\n\n    // Ensure POI locations are walkable (including footprint area)\n    this.pois.forEach((poi) => {\n      const width = poi.footprint?.x || 1;\n      const height = poi.footprint?.y || 1;\n      \n      for (let dy = 0; dy < height; dy++) {\n        for (let dx = 0; dx < width; dx++) {\n          this.setTile(poi.pos.x + dx, poi.pos.y + dy, TileType.Road, true);\n        }\n      }\n    });\n  }\n\n  getTile(x: number, y: number): Tile | null {\n    if (!this.isInBounds(x, y)) {\n      return null;\n    }\n    return this.tiles[y][x];\n  }\n\n  setTile(x: number, y: number, type: TileType, walkable: boolean): void {\n    if (!this.isInBounds(x, y)) {\n      return;\n    }\n    this.tiles[y][x] = { type, walkable };\n  }\n\n  isWalkable(x: number, y: number): boolean {\n    const tile = this.getTile(x, y);\n    return tile !== null && tile.walkable;\n  }\n\n  isInBounds(x: number, y: number): boolean {\n    return x >= 0 && x < this.width && y >= 0 && y < this.height;\n  }\n\n  getPOIs(): POI[] {\n    return [...this.pois];\n  }\n\n  getPOI(id: string): POI | undefined {\n    return this.pois.find((poi) => poi.id === id);\n  }\n}\n","/**\n * A* pathfinding system for grid-based navigation\n */\n\nimport type { WorldMap, Vec2 } from '../world/map';\n\ninterface PathNode {\n  pos: Vec2;\n  parent: PathNode | null;\n  g: number; // Cost from start\n  h: number; // Heuristic to goal\n  f: number; // Total cost (g + h)\n}\n\n/**\n * Manhattan distance heuristic for 4-directional movement\n */\nfunction manhattanDistance(a: Vec2, b: Vec2): number {\n  return Math.abs(a.x - b.x) + Math.abs(a.y - b.y);\n}\n\n/**\n * Check if two positions are equal\n */\nfunction posEquals(a: Vec2, b: Vec2): boolean {\n  return a.x === b.x && a.y === b.y;\n}\n\n/**\n * Create a unique key for a position\n */\nfunction posKey(pos: Vec2): string {\n  return `${pos.x},${pos.y}`;\n}\n\n/**\n * Find path from start to goal using A* algorithm\n * @param start Starting position\n * @param goal Goal position\n * @param map World map with tile information\n * @returns Array of positions representing the path, or empty array if no path found\n */\nexport function findPath(start: Vec2, goal: Vec2, map: WorldMap): Vec2[] {\n  // If start equals goal, return empty path\n  if (posEquals(start, goal)) {\n    return [];\n  }\n\n  // If goal is not walkable, return empty path\n  if (!map.isWalkable(goal.x, goal.y)) {\n    return [];\n  }\n\n  const openSet = new Map<string, PathNode>();\n  const closedSet = new Set<string>();\n\n  // Initialize start node\n  const startNode: PathNode = {\n    pos: start,\n    parent: null,\n    g: 0,\n    h: manhattanDistance(start, goal),\n    f: manhattanDistance(start, goal),\n  };\n\n  openSet.set(posKey(start), startNode);\n\n  // 4-directional movement (up, down, left, right)\n  const directions = [\n    { x: 0, y: -1 }, // Up\n    { x: 0, y: 1 },  // Down\n    { x: -1, y: 0 }, // Left\n    { x: 1, y: 0 },  // Right\n  ];\n\n  while (openSet.size > 0) {\n    // Find node with lowest f score\n    let current: PathNode | null = null;\n    let lowestF = Infinity;\n\n    for (const node of openSet.values()) {\n      if (node.f < lowestF) {\n        lowestF = node.f;\n        current = node;\n      }\n    }\n\n    if (!current) {\n      break;\n    }\n\n    // Check if we reached the goal\n    if (posEquals(current.pos, goal)) {\n      return reconstructPath(current);\n    }\n\n    // Move current from open to closed\n    const currentKey = posKey(current.pos);\n    openSet.delete(currentKey);\n    closedSet.add(currentKey);\n\n    // Check all neighbors\n    for (const dir of directions) {\n      const neighborPos = {\n        x: current.pos.x + dir.x,\n        y: current.pos.y + dir.y,\n      };\n\n      const neighborKey = posKey(neighborPos);\n\n      // Skip if already evaluated or not walkable\n      if (closedSet.has(neighborKey)) {\n        continue;\n      }\n\n      if (!map.isWalkable(neighborPos.x, neighborPos.y)) {\n        continue;\n      }\n\n      // Calculate costs\n      const tentativeG = current.g + 1; // Cost of 1 for each step\n\n      const existingNode = openSet.get(neighborKey);\n\n      if (existingNode) {\n        // If we found a better path to this node, update it\n        if (tentativeG < existingNode.g) {\n          existingNode.parent = current;\n          existingNode.g = tentativeG;\n          existingNode.f = tentativeG + existingNode.h;\n        }\n      } else {\n        // Add new node to open set\n        const h = manhattanDistance(neighborPos, goal);\n        const newNode: PathNode = {\n          pos: neighborPos,\n          parent: current,\n          g: tentativeG,\n          h: h,\n          f: tentativeG + h,\n        };\n        openSet.set(neighborKey, newNode);\n      }\n    }\n  }\n\n  // No path found\n  return [];\n}\n\n/**\n * Reconstruct path from goal node by following parent pointers\n */\nfunction reconstructPath(node: PathNode): Vec2[] {\n  const path: Vec2[] = [];\n  let current: PathNode | null = node;\n\n  while (current !== null) {\n    path.unshift(current.pos);\n    current = current.parent;\n  }\n\n  // Remove the start position (NPC is already there)\n  if (path.length > 0) {\n    path.shift();\n  }\n\n  return path;\n}\n\n/**\n * Check if a path is still valid (all tiles are still walkable)\n */\nexport function isPathValid(path: Vec2[], map: WorldMap): boolean {\n  for (const pos of path) {\n    if (!map.isWalkable(pos.x, pos.y)) {\n      return false;\n    }\n  }\n  return true;\n}\n","/**\n * Phase 2: World indices for fast queries\n * \n * This module provides spatial and inventory indices to avoid O(N) scans:\n * - entitiesByCell: spatial index for neighbor/witness queries\n * - sellersByItem: inventory-driven seller lookup\n * - entitiesByPoi: entities grouped by POI (optional, for future use)\n */\n\nimport type { EntityId, ItemId, PoiId, CellId } from '../types';\nimport type { Vec2 } from './map';\n\n/**\n * WorldIndices manages all game indices for fast lookups\n * These indices are non-serializable and can be rebuilt from world state\n */\nexport class WorldIndices {\n  private mapWidth: number;\n  \n  // Spatial index: entities by cell\n  private entitiesByCell: Map<CellId, Set<EntityId>>;\n  \n  // Inventory index: sellers by item\n  private sellersByItem: Map<ItemId, Set<EntityId>>;\n  \n  // POI index: entities by POI (optional for now)\n  private entitiesByPoi: Map<PoiId, Set<EntityId>>;\n\n  constructor(mapWidth: number) {\n    this.mapWidth = mapWidth;\n    this.entitiesByCell = new Map();\n    this.sellersByItem = new Map();\n    this.entitiesByPoi = new Map();\n  }\n\n  /**\n   * Convert 2D coordinates to numeric cellId for spatial indexing\n   */\n  getCellId(x: number, y: number): CellId {\n    return x + y * this.mapWidth;\n  }\n\n  /**\n   * Convert cellId back to 2D coordinates\n   */\n  getCellPos(cellId: CellId): Vec2 {\n    return {\n      x: cellId % this.mapWidth,\n      y: Math.floor(cellId / this.mapWidth),\n    };\n  }\n\n  // ============================================================\n  // Spatial Index Operations\n  // ============================================================\n\n  /**\n   * Register entity at a specific cell\n   */\n  addEntityToCell(entityId: EntityId, pos: Vec2): void {\n    const cellId = this.getCellId(pos.x, pos.y);\n    let entities = this.entitiesByCell.get(cellId);\n    \n    if (!entities) {\n      entities = new Set();\n      this.entitiesByCell.set(cellId, entities);\n    }\n    \n    entities.add(entityId);\n  }\n\n  /**\n   * Remove entity from a specific cell\n   */\n  removeEntityFromCell(entityId: EntityId, pos: Vec2): void {\n    const cellId = this.getCellId(pos.x, pos.y);\n    const entities = this.entitiesByCell.get(cellId);\n    \n    if (entities) {\n      entities.delete(entityId);\n      \n      // Clean up empty sets\n      if (entities.size === 0) {\n        this.entitiesByCell.delete(cellId);\n      }\n    }\n  }\n\n  /**\n   * Move entity from one cell to another\n   */\n  moveEntity(entityId: EntityId, fromPos: Vec2, toPos: Vec2): void {\n    // Only update if position actually changed\n    if (fromPos.x === toPos.x && fromPos.y === toPos.y) {\n      return;\n    }\n    \n    this.removeEntityFromCell(entityId, fromPos);\n    this.addEntityToCell(entityId, toPos);\n  }\n\n  /**\n   * Get all entities in a specific cell\n   */\n  getEntitiesInCell(pos: Vec2): Set<EntityId> {\n    const cellId = this.getCellId(pos.x, pos.y);\n    return this.entitiesByCell.get(cellId) || new Set();\n  }\n\n  /**\n   * Get all entities within a radius (Manhattan distance)\n   * Useful for neighbor queries, witness detection, etc.\n   */\n  getEntitiesInRadius(center: Vec2, radius: number): Set<EntityId> {\n    const result = new Set<EntityId>();\n    \n    // Scan cells in bounding box\n    for (let dy = -radius; dy <= radius; dy++) {\n      for (let dx = -radius; dx <= radius; dx++) {\n        const x = center.x + dx;\n        const y = center.y + dy;\n        \n        // Check Manhattan distance\n        const distance = Math.abs(dx) + Math.abs(dy);\n        if (distance <= radius) {\n          const entities = this.getEntitiesInCell({ x, y });\n          entities.forEach((entityId) => result.add(entityId));\n        }\n      }\n    }\n    \n    return result;\n  }\n\n  // ============================================================\n  // Inventory Index Operations\n  // ============================================================\n\n  /**\n   * Register entity as seller of a specific item\n   */\n  addSeller(entityId: EntityId, itemId: ItemId): void {\n    let sellers = this.sellersByItem.get(itemId);\n    \n    if (!sellers) {\n      sellers = new Set();\n      this.sellersByItem.set(itemId, sellers);\n    }\n    \n    sellers.add(entityId);\n  }\n\n  /**\n   * Unregister entity as seller of a specific item\n   */\n  removeSeller(entityId: EntityId, itemId: ItemId): void {\n    const sellers = this.sellersByItem.get(itemId);\n    \n    if (sellers) {\n      sellers.delete(entityId);\n      \n      // Clean up empty sets\n      if (sellers.size === 0) {\n        this.sellersByItem.delete(itemId);\n      }\n    }\n  }\n\n  /**\n   * Get all sellers of a specific item\n   */\n  getSellersOfItem(itemId: ItemId): Set<EntityId> {\n    return this.sellersByItem.get(itemId) || new Set();\n  }\n\n  /**\n   * Update seller index when inventory changes\n   * Should be called by inventory mutation helpers\n   */\n  updateSellerIndex(entityId: EntityId, itemId: ItemId, newQuantity: number, oldQuantity: number): void {\n    // If item quantity went from 0 to positive, add as seller\n    if (oldQuantity === 0 && newQuantity > 0) {\n      this.addSeller(entityId, itemId);\n    }\n    // If item quantity went from positive to 0, remove as seller\n    else if (oldQuantity > 0 && newQuantity === 0) {\n      this.removeSeller(entityId, itemId);\n    }\n  }\n\n  // ============================================================\n  // POI Index Operations (Optional for Phase 2)\n  // ============================================================\n\n  /**\n   * Register entity at a POI\n   */\n  addEntityToPOI(entityId: EntityId, poiId: PoiId): void {\n    let entities = this.entitiesByPoi.get(poiId);\n    \n    if (!entities) {\n      entities = new Set();\n      this.entitiesByPoi.set(poiId, entities);\n    }\n    \n    entities.add(entityId);\n  }\n\n  /**\n   * Remove entity from a POI\n   */\n  removeEntityFromPOI(entityId: EntityId, poiId: PoiId): void {\n    const entities = this.entitiesByPoi.get(poiId);\n    \n    if (entities) {\n      entities.delete(entityId);\n      \n      // Clean up empty sets\n      if (entities.size === 0) {\n        this.entitiesByPoi.delete(poiId);\n      }\n    }\n  }\n\n  /**\n   * Get all entities at a specific POI\n   */\n  getEntitiesAtPOI(poiId: PoiId): Set<EntityId> {\n    return this.entitiesByPoi.get(poiId) || new Set();\n  }\n\n  // ============================================================\n  // Utility Methods\n  // ============================================================\n\n  /**\n   * Clear all indices\n   */\n  clear(): void {\n    this.entitiesByCell.clear();\n    this.sellersByItem.clear();\n    this.entitiesByPoi.clear();\n  }\n\n  /**\n   * Get debug info about index sizes\n   */\n  getDebugInfo(): {\n    cellCount: number;\n    itemCount: number;\n    poiCount: number;\n    totalCellEntities: number;\n    totalItemSellers: number;\n    totalPoiEntities: number;\n  } {\n    let totalCellEntities = 0;\n    this.entitiesByCell.forEach((entities) => {\n      totalCellEntities += entities.size;\n    });\n\n    let totalItemSellers = 0;\n    this.sellersByItem.forEach((sellers) => {\n      totalItemSellers += sellers.size;\n    });\n\n    let totalPoiEntities = 0;\n    this.entitiesByPoi.forEach((entities) => {\n      totalPoiEntities += entities.size;\n    });\n\n    return {\n      cellCount: this.entitiesByCell.size,\n      itemCount: this.sellersByItem.size,\n      poiCount: this.entitiesByPoi.size,\n      totalCellEntities,\n      totalItemSellers,\n      totalPoiEntities,\n    };\n  }\n}\n","/**\n * Phase 2: Development validation for world indices\n * \n * These functions check that indices are consistent with entity state.\n * They can be invoked during development to catch indexing bugs.\n */\n\nimport type { NPC } from '../types';\nimport type { WorldIndices } from './indices';\nimport type { WorldMap } from './map';\n\nexport interface ValidationResult {\n  valid: boolean;\n  errors: string[];\n}\n\n/**\n * Validate that spatial indices match actual entity positions\n */\nexport function validateSpatialIndex(\n  npcs: NPC[],\n  indices: WorldIndices\n): ValidationResult {\n  const errors: string[] = [];\n\n  // Build expected entity positions from actual NPC data\n  const expectedCells = new Map<number, Set<string>>();\n  \n  for (const npc of npcs) {\n    const cellId = indices.getCellId(npc.pos.x, npc.pos.y);\n    let entities = expectedCells.get(cellId);\n    \n    if (!entities) {\n      entities = new Set();\n      expectedCells.set(cellId, entities);\n    }\n    \n    entities.add(npc.id);\n  }\n\n  // Check each cell in index\n  const indexCells = new Set<number>();\n  \n  for (const npc of npcs) {\n    const cellId = indices.getCellId(npc.pos.x, npc.pos.y);\n    indexCells.add(cellId);\n    \n    const indexedEntities = indices.getEntitiesInCell(npc.pos);\n    const expectedEntities = expectedCells.get(cellId) || new Set();\n    \n    // Check if all expected entities are in index\n    for (const entityId of expectedEntities) {\n      if (!indexedEntities.has(entityId)) {\n        errors.push(\n          `Spatial index missing entity ${entityId} at cell (${npc.pos.x}, ${npc.pos.y})`\n        );\n      }\n    }\n    \n    // Check if all indexed entities exist\n    for (const entityId of indexedEntities) {\n      if (!expectedEntities.has(entityId)) {\n        errors.push(\n          `Spatial index has extra entity ${entityId} at cell (${npc.pos.x}, ${npc.pos.y})`\n        );\n      }\n    }\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n  };\n}\n\n/**\n * Validate that inventory indices match actual entity inventories\n */\nexport function validateInventoryIndex(\n  npcs: NPC[],\n  indices: WorldIndices\n): ValidationResult {\n  const errors: string[] = [];\n\n  // Build expected sellers from actual inventory data\n  const expectedSellers = new Map<string, Set<string>>();\n  \n  for (const npc of npcs) {\n    if (npc.inventory) {\n      for (const [itemId, quantity] of npc.inventory.entries()) {\n        if (quantity > 0) {\n          let sellers = expectedSellers.get(itemId);\n          \n          if (!sellers) {\n            sellers = new Set();\n            expectedSellers.set(itemId, sellers);\n          }\n          \n          sellers.add(npc.id);\n        }\n      }\n    }\n  }\n\n  // Check that all expected sellers are indexed\n  for (const [itemId, expectedSet] of expectedSellers.entries()) {\n    const indexedSet = indices.getSellersOfItem(itemId);\n    \n    for (const entityId of expectedSet) {\n      if (!indexedSet.has(entityId)) {\n        errors.push(\n          `Inventory index missing seller ${entityId} for item ${itemId}`\n        );\n      }\n    }\n  }\n\n  // Check that all indexed sellers actually have the item\n  for (const npc of npcs) {\n    if (npc.inventory) {\n      for (const [itemId, quantity] of npc.inventory.entries()) {\n        const indexedSellers = indices.getSellersOfItem(itemId);\n        \n        if (quantity > 0 && !indexedSellers.has(npc.id)) {\n          errors.push(\n            `Entity ${npc.id} has item ${itemId} but is not in seller index`\n          );\n        }\n        \n        if (quantity === 0 && indexedSellers.has(npc.id)) {\n          errors.push(\n            `Entity ${npc.id} has 0 of item ${itemId} but is in seller index`\n          );\n        }\n      }\n    }\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n  };\n}\n\n/**\n * Validate all indices\n */\nexport function validateIndices(\n  npcs: NPC[],\n  indices: WorldIndices,\n  _map: WorldMap\n): ValidationResult {\n  const spatialResult = validateSpatialIndex(npcs, indices);\n  const inventoryResult = validateInventoryIndex(npcs, indices);\n\n  return {\n    valid: spatialResult.valid && inventoryResult.valid,\n    errors: [...spatialResult.errors, ...inventoryResult.errors],\n  };\n}\n\n/**\n * Log validation results to console (development only)\n */\nexport function logValidationResults(result: ValidationResult): void {\n  if (result.valid) {\n    console.log('✓ All indices are valid');\n  } else {\n    console.error('✗ Index validation failed:');\n    result.errors.forEach((error) => console.error(`  - ${error}`));\n  }\n}\n","/**\n * Phase 3: Economy system with closed economy and gold tracking\n * \n * This module provides gold transfer mechanisms and invariant validation\n * to ensure total gold in the economy remains constant.\n */\n\nimport type { NPC, GameState, EntityId } from '../types';\n\n/**\n * Entity that can hold gold (NPC, player, city, or guild)\n */\nexport type GoldHolder = 'city' | 'guild' | 'player' | EntityId;\n\n/**\n * Transfer gold between entities in a closed economy\n * This is the single pathway for all gold transfers\n * \n * @param state Game state\n * @param from Source entity (NPC id, 'city', 'guild', or 'player')\n * @param to Target entity (NPC id, 'city', 'guild', or 'player')\n * @param amount Amount of gold to transfer (must be positive)\n * @param reason Description of the transfer for logging\n * @returns true if transfer was successful, false if insufficient funds\n */\nexport function transferGold(\n  state: GameState,\n  from: GoldHolder,\n  to: GoldHolder,\n  amount: number,\n  _reason: string\n): boolean {\n  if (amount <= 0) {\n    return true;\n  }\n\n  // Get current balances\n  const fromBalance = getGoldBalance(state, from);\n  const toBalance = getGoldBalance(state, to);\n\n  // Check if source has enough gold\n  if (fromBalance < amount) {\n    return false;\n  }\n\n  // Perform transfer\n  setGoldBalance(state, from, fromBalance - amount);\n  setGoldBalance(state, to, toBalance + amount);\n\n  return true;\n}\n\n/**\n * Get gold balance for an entity\n */\nfunction getGoldBalance(state: GameState, holder: GoldHolder): number {\n  if (holder === 'city') {\n    return state.cityTreasury;\n  } else if (holder === 'guild') {\n    return state.guildTreasury || 0;\n  } else if (holder === 'player') {\n    return state.player.gold;\n  } else {\n    // Find NPC by ID\n    const npc = state.npcs.find((n) => n.id === holder);\n    return npc ? npc.money : 0;\n  }\n}\n\n/**\n * Set gold balance for an entity\n */\nfunction setGoldBalance(state: GameState, holder: GoldHolder, amount: number): void {\n  if (holder === 'city') {\n    state.cityTreasury = amount;\n  } else if (holder === 'guild') {\n    if (state.guildTreasury !== undefined) {\n      state.guildTreasury = amount;\n    }\n  } else if (holder === 'player') {\n    state.player.gold = amount;\n  } else {\n    // Find NPC by ID\n    const npc = state.npcs.find((n) => n.id === holder);\n    if (npc) {\n      npc.money = amount;\n    }\n  }\n}\n\n/**\n * Calculate total gold in the economy\n */\nexport function calculateTotalGold(state: GameState): number {\n  let total = state.cityTreasury;\n  \n  if (state.guildTreasury !== undefined) {\n    total += state.guildTreasury;\n  }\n  \n  total += state.player.gold;\n  \n  for (const npc of state.npcs) {\n    total += npc.money;\n  }\n  \n  return total;\n}\n\n/**\n * Validate economy invariants (development mode)\n * Check that total gold remains constant\n */\nexport function validateEconomyInvariants(\n  state: GameState,\n  expectedTotal: number\n): { valid: boolean; actual: number; expected: number; diff: number } {\n  const actualTotal = calculateTotalGold(state);\n  const diff = actualTotal - expectedTotal;\n  const valid = Math.abs(diff) < 0.01; // Allow for floating point errors\n  \n  if (!valid) {\n    console.error(`[Economy] Gold mismatch! Expected: ${expectedTotal}, Actual: ${actualTotal}, Diff: ${diff}`);\n  }\n  \n  return {\n    valid,\n    actual: actualTotal,\n    expected: expectedTotal,\n    diff,\n  };\n}\n\n/**\n * Initialize economy with distributed gold\n * Called during world generation\n * \n * @param state Game state\n * @param cityTreasuryMin Minimum city treasury (5000-10000)\n * @param cityTreasuryMax Maximum city treasury\n * @param random Random number generator\n */\nexport function initializeEconomy(\n  state: GameState,\n  cityTreasuryMin: number,\n  cityTreasuryMax: number,\n  random: { nextInt: (min: number, max: number) => number }\n): void {\n  // Initialize city treasury\n  state.cityTreasury = random.nextInt(cityTreasuryMin, cityTreasuryMax);\n  \n  // Initialize guild treasury (optional)\n  if (state.guildTreasury !== undefined) {\n    state.guildTreasury = 0;\n  }\n  \n  // Note: NPC gold is already initialized in GameEngine.generateInitialNPCs\n  // Player gold is already initialized in GameEngine.createInitialState\n  \n  console.log(`[Economy] Initialized with city treasury: ${state.cityTreasury} gold`);\n  console.log(`[Economy] Total economy gold: ${calculateTotalGold(state)} gold`);\n}\n\n/**\n * Work action: consume input item, produce output item\n * No gold generation from work\n * \n * @param npc NPC performing work\n * @param inputItem Item consumed by work (e.g., \"tempo\")\n * @param outputItem Item produced by work\n * @param inputQuantity Quantity of input item consumed\n * @param outputQuantity Quantity of output item produced\n * @param hasInput Whether NPC has the input item\n * @param inventoryAdd Function to add items to inventory\n * @param inventoryRemove Function to remove items from inventory\n * @returns true if work was successful\n */\nexport function performWork(\n  npc: NPC,\n  inputItem: string,\n  outputItem: string,\n  inputQuantity: number,\n  outputQuantity: number,\n  hasInput: boolean,\n  inventoryAdd: (entity: NPC, itemId: string, quantity: number) => void,\n  inventoryRemove: (entity: NPC, itemId: string, quantity: number) => boolean\n): boolean {\n  // Check if NPC has input item (if required)\n  if (inputQuantity > 0 && !hasInput) {\n    return false;\n  }\n  \n  // Consume input item\n  if (inputQuantity > 0) {\n    const success = inventoryRemove(npc, inputItem, inputQuantity);\n    if (!success) {\n      return false;\n    }\n  }\n  \n  // Produce output item\n  inventoryAdd(npc, outputItem, outputQuantity);\n  \n  return true;\n}\n","/**\n * Phase 3: NPC needs system\n * \n * This module manages NPC needs (hunger, social, fun) that drive behavior.\n * Needs are clamped between 0 and 100.\n */\n\nimport type { NPC } from '../types';\nimport type { MacroSnapshot } from '../dna';\n\nexport interface Needs {\n  hunger: number;\n  social: number;\n  fun: number;\n}\n\n/**\n * Initialize needs for an NPC (default to 50 for all needs)\n */\nexport function initializeNeeds(npc: NPC): void {\n  if (!npc.needs) {\n    npc.needs = {\n      hunger: 50,\n      social: 50,\n      fun: 50,\n    };\n  }\n}\n\n/**\n * Ensure NPC has needs initialized\n */\nexport function ensureNeeds(npc: NPC): Needs {\n  if (!npc.needs) {\n    initializeNeeds(npc);\n  }\n  return npc.needs!;\n}\n\n/**\n * Clamp a need value between 0 and 100\n */\nfunction clampNeed(value: number): number {\n  return Math.max(0, Math.min(100, value));\n}\n\n/**\n * Modify a need value by a delta and clamp\n */\nexport function modifyNeed(npc: NPC, needType: keyof Needs, delta: number): void {\n  const needs = ensureNeeds(npc);\n  needs[needType] = clampNeed(needs[needType] + delta);\n}\n\n/**\n * Set a need value directly (clamped)\n */\nexport function setNeed(npc: NPC, needType: keyof Needs, value: number): void {\n  const needs = ensureNeeds(npc);\n  needs[needType] = clampNeed(value);\n}\n\n/**\n * Get a need value\n */\nexport function getNeed(npc: NPC, needType: keyof Needs): number {\n  const needs = ensureNeeds(npc);\n  return needs[needType];\n}\n\n/**\n * Get the most urgent need for an NPC\n * Returns the need type with the lowest value\n */\nexport function getMostUrgentNeed(npc: NPC): keyof Needs {\n  const needs = ensureNeeds(npc);\n  \n  let minNeed: keyof Needs = 'hunger';\n  let minValue = needs.hunger;\n  \n  if (needs.social < minValue) {\n    minNeed = 'social';\n    minValue = needs.social;\n  }\n  \n  if (needs.fun < minValue) {\n    minNeed = 'fun';\n    minValue = needs.fun;\n  }\n  \n  return minNeed;\n}\n\n/**\n * Check if any need is critical (below threshold)\n */\nexport function hasCriticalNeed(npc: NPC, threshold: number = 20): boolean {\n  const needs = ensureNeeds(npc);\n  return needs.hunger < threshold || needs.social < threshold || needs.fun < threshold;\n}\n\n/**\n * Apply need decay over time (passive degradation)\n * Called periodically to simulate needs deteriorating\n */\nexport function applyNeedDecay(npc: NPC, hungerDecay: number, socialDecay: number, funDecay: number): void {\n  modifyNeed(npc, 'hunger', -hungerDecay);\n  modifyNeed(npc, 'social', -socialDecay);\n  modifyNeed(npc, 'fun', -funDecay);\n}\n\n/**\n * Satisfy a need by performing an action\n * This is called when an NPC performs an action that fulfills a need\n */\nexport function satisfyNeed(npc: NPC, needType: keyof Needs, amount: number): void {\n  modifyNeed(npc, needType, amount);\n}\n\n/**\n * Synchronize need meters from a chemistry-derived macro snapshot (0..1 signals).\n */\nexport function syncNeedsFromMacro(npc: NPC, macro: MacroSnapshot): void {\n  const needs = ensureNeeds(npc);\n  const hungerSatisfaction = 1 - macro.hungerSignal; // hungerSignal high => low satisfaction\n  const socialSatisfaction = clampNeed((0.5 * (1 - macro.stress) + 0.5 * macro.mood) * 100);\n  needs.hunger = clampNeed(hungerSatisfaction * 100);\n  needs.fun = clampNeed(macro.mood * 100);\n  needs.social = socialSatisfaction;\n}\n\n/**\n * Get need status as a string for debugging\n */\nexport function getNeedStatus(npc: NPC): string {\n  const needs = ensureNeeds(npc);\n  return `Hunger: ${needs.hunger.toFixed(0)}, Social: ${needs.social.toFixed(0)}, Fun: ${needs.fun.toFixed(0)}`;\n}\n","/**\n * Phase 3: Social system for NPC relations\n * \n * This module manages relationships between NPCs.\n * Relations are stored in a sparse map with values typically between -100 and 100.\n */\n\nimport type { GameState, EntityId } from '../types';\n\n/**\n * Get relation value between two entities\n * Returns 0 if no relation exists (neutral)\n */\nexport function getRelation(\n  state: GameState,\n  entityId1: EntityId,\n  entityId2: EntityId\n): number {\n  if (!state.relations) {\n    return 0;\n  }\n  \n  // Search through the map\n  for (const [mapKey, innerMap] of state.relations.entries()) {\n    if (mapKey === entityId1 || mapKey === entityId2) {\n      const otherId = mapKey === entityId1 ? entityId2 : entityId1;\n      return innerMap.get(otherId) || 0;\n    }\n  }\n  \n  return 0;\n}\n\n/**\n * Set relation value between two entities\n * Value is typically clamped between -100 and 100\n */\nexport function setRelation(\n  state: GameState,\n  entityId1: EntityId,\n  entityId2: EntityId,\n  value: number\n): void {\n  // Clamp value\n  value = Math.max(-100, Math.min(100, value));\n  \n  // Ensure relations map exists\n  if (!state.relations) {\n    state.relations = new Map();\n  }\n  \n  // Get or create inner map for entityId1\n  let innerMap = state.relations.get(entityId1);\n  if (!innerMap) {\n    innerMap = new Map();\n    state.relations.set(entityId1, innerMap);\n  }\n  \n  // Set the relation\n  innerMap.set(entityId2, value);\n  \n  // Also set the reverse relation for symmetry\n  let reverseMap = state.relations.get(entityId2);\n  if (!reverseMap) {\n    reverseMap = new Map();\n    state.relations.set(entityId2, reverseMap);\n  }\n  reverseMap.set(entityId1, value);\n}\n\n/**\n * Modify relation value between two entities by a delta\n */\nexport function modifyRelation(\n  state: GameState,\n  entityId1: EntityId,\n  entityId2: EntityId,\n  delta: number\n): void {\n  const currentValue = getRelation(state, entityId1, entityId2);\n  setRelation(state, entityId1, entityId2, currentValue + delta);\n}\n\n/**\n * Check if two entities have a positive relationship\n */\nexport function areFriendly(\n  state: GameState,\n  entityId1: EntityId,\n  entityId2: EntityId,\n  threshold: number = 20\n): boolean {\n  return getRelation(state, entityId1, entityId2) >= threshold;\n}\n\n/**\n * Check if two entities have a negative relationship\n */\nexport function areHostile(\n  state: GameState,\n  entityId1: EntityId,\n  entityId2: EntityId,\n  threshold: number = -20\n): boolean {\n  return getRelation(state, entityId1, entityId2) <= threshold;\n}\n\n/**\n * Perform a social interaction between two NPCs\n * Updates their relationship based on the interaction type\n * \n * @param state Game state\n * @param npc1Id First NPC\n * @param npc2Id Second NPC\n * @param interactionType Type of interaction\n * @returns Relation delta applied\n */\nexport function performSocialInteraction(\n  state: GameState,\n  npc1Id: EntityId,\n  npc2Id: EntityId,\n  interactionType: 'chat' | 'trade' | 'conflict' | 'help'\n): number {\n  let delta = 0;\n  \n  switch (interactionType) {\n    case 'chat':\n      delta = 2; // Small positive increase\n      break;\n    case 'trade':\n      delta = 5; // Moderate positive increase\n      break;\n    case 'conflict':\n      delta = -10; // Negative decrease\n      break;\n    case 'help':\n      delta = 8; // Large positive increase\n      break;\n  }\n  \n  // Apply some randomness (-1 to +1)\n  delta += Math.random() * 2 - 1;\n  \n  modifyRelation(state, npc1Id, npc2Id, delta);\n  \n  return delta;\n}\n\n/**\n * Get all entities that have a relationship with the given entity\n */\nexport function getRelatedEntities(\n  state: GameState,\n  entityId: EntityId\n): Array<{ entityId: EntityId; relation: number }> {\n  if (!state.relations) {\n    return [];\n  }\n  \n  const innerMap = state.relations.get(entityId);\n  if (!innerMap) {\n    return [];\n  }\n  \n  const result: Array<{ entityId: EntityId; relation: number }> = [];\n  for (const [otherId, relation] of innerMap.entries()) {\n    result.push({ entityId: otherId, relation });\n  }\n  \n  return result;\n}\n","/**\n * Phase 2: Centralized inventory mutation helpers\n * \n * All inventory changes should go through these helpers to ensure\n * indices stay consistent with entity inventories.\n */\n\nimport type { ItemId, Inventory, NPC } from '../types';\nimport type { WorldIndices } from './indices';\n\n/**\n * Initialize inventory for an entity if it doesn't exist\n */\nexport function ensureInventory(entity: NPC): Inventory {\n  if (!entity.inventory) {\n    entity.inventory = new Map();\n  }\n  return entity.inventory;\n}\n\n/**\n * Add items to entity inventory and update indices\n * @param entity - The NPC entity\n * @param itemId - The item identifier\n * @param quantity - Amount to add (must be positive)\n * @param indices - World indices to update\n */\nexport function inventoryAdd(\n  entity: NPC,\n  itemId: ItemId,\n  quantity: number,\n  indices: WorldIndices\n): void {\n  if (quantity <= 0) {\n    return;\n  }\n\n  const inventory = ensureInventory(entity);\n  const oldQuantity = inventory.get(itemId) || 0;\n  const newQuantity = oldQuantity + quantity;\n  \n  inventory.set(itemId, newQuantity);\n  indices.updateSellerIndex(entity.id, itemId, newQuantity, oldQuantity);\n}\n\n/**\n * Remove items from entity inventory and update indices\n * @param entity - The NPC entity\n * @param itemId - The item identifier\n * @param quantity - Amount to remove (must be positive)\n * @param indices - World indices to update\n * @returns true if removal was successful, false if insufficient quantity\n */\nexport function inventoryRemove(\n  entity: NPC,\n  itemId: ItemId,\n  quantity: number,\n  indices: WorldIndices\n): boolean {\n  if (quantity <= 0) {\n    return true;\n  }\n\n  const inventory = ensureInventory(entity);\n  const oldQuantity = inventory.get(itemId) || 0;\n  \n  if (oldQuantity < quantity) {\n    return false; // Insufficient quantity\n  }\n\n  const newQuantity = oldQuantity - quantity;\n  \n  if (newQuantity === 0) {\n    inventory.delete(itemId);\n  } else {\n    inventory.set(itemId, newQuantity);\n  }\n  \n  indices.updateSellerIndex(entity.id, itemId, newQuantity, oldQuantity);\n  return true;\n}\n\n/**\n * Set item quantity in entity inventory and update indices\n * @param entity - The NPC entity\n * @param itemId - The item identifier\n * @param quantity - New quantity (negative values are clamped to 0)\n * @param indices - World indices to update\n */\nexport function inventorySet(\n  entity: NPC,\n  itemId: ItemId,\n  quantity: number,\n  indices: WorldIndices\n): void {\n  // Clamp negative quantities to 0\n  if (quantity < 0) {\n    quantity = 0;\n  }\n\n  const inventory = ensureInventory(entity);\n  const oldQuantity = inventory.get(itemId) || 0;\n  \n  if (quantity === 0) {\n    inventory.delete(itemId);\n  } else {\n    inventory.set(itemId, quantity);\n  }\n  \n  indices.updateSellerIndex(entity.id, itemId, quantity, oldQuantity);\n}\n\n/**\n * Get item quantity from entity inventory\n * @param entity - The NPC entity\n * @param itemId - The item identifier\n * @returns quantity of the item\n */\nexport function inventoryGet(entity: NPC, itemId: ItemId): number {\n  if (!entity.inventory) {\n    return 0;\n  }\n  return entity.inventory.get(itemId) || 0;\n}\n\n/**\n * Check if entity has at least a certain quantity of an item\n * @param entity - The NPC entity\n * @param itemId - The item identifier\n * @param quantity - Required quantity\n * @returns true if entity has at least the required quantity\n */\nexport function inventoryHas(entity: NPC, itemId: ItemId, quantity: number): boolean {\n  return inventoryGet(entity, itemId) >= quantity;\n}\n\n/**\n * Transfer items between two entities\n * @param from - Source entity\n * @param to - Target entity\n * @param itemId - The item identifier\n * @param quantity - Amount to transfer\n * @param indices - World indices to update\n * @returns true if transfer was successful, false if insufficient quantity\n */\nexport function inventoryTransfer(\n  from: NPC,\n  to: NPC,\n  itemId: ItemId,\n  quantity: number,\n  indices: WorldIndices\n): boolean {\n  if (quantity <= 0) {\n    return true;\n  }\n\n  if (!inventoryHas(from, itemId, quantity)) {\n    return false;\n  }\n\n  // Remove from source\n  inventoryRemove(from, itemId, quantity, indices);\n  \n  // Add to target\n  inventoryAdd(to, itemId, quantity, indices);\n  \n  return true;\n}\n\n/**\n * Get all items in entity inventory\n * @param entity - The NPC entity\n * @returns array of [itemId, quantity] pairs\n */\nexport function inventoryGetAll(entity: NPC): [ItemId, number][] {\n  if (!entity.inventory) {\n    return [];\n  }\n  return Array.from(entity.inventory.entries());\n}\n\n/**\n * Clear all items from entity inventory and update indices\n * @param entity - The NPC entity\n * @param indices - World indices to update\n */\nexport function inventoryClear(entity: NPC, indices: WorldIndices): void {\n  if (!entity.inventory) {\n    return;\n  }\n\n  // Update indices for all items\n  for (const [itemId, oldQuantity] of entity.inventory.entries()) {\n    indices.updateSellerIndex(entity.id, itemId, 0, oldQuantity);\n  }\n\n  entity.inventory.clear();\n}\n","/**\n * Lightweight chemistry / DNA sandbox\n */\n\nexport type Substance = string;\nexport type Mix = Record<Substance, number>;\n\nexport const EPS = 1e-9;\n\n/* =========================\n   Mix helpers\n========================= */\n\nexport function mixGet(mix: Mix, key: Substance): number {\n  return mix[key] ?? 0;\n}\n\nexport function mixAdd(mix: Mix, key: Substance, value: number): void {\n  if (Math.abs(value) < 1e-12) return;\n  const next = (mix[key] ?? 0) + value;\n  if (next <= EPS) {\n    delete mix[key];\n  } else {\n    mix[key] = next;\n  }\n}\n\nexport function mixScale(mix: Mix, scale: number): Mix {\n  const out: Mix = {};\n  for (const [k, v] of Object.entries(mix)) {\n    const next = v * scale;\n    if (next > EPS) out[k] = next;\n  }\n  return out;\n}\n\nexport function mixMerge(base: Mix, delta: Mix): Mix {\n  const out: Mix = { ...base };\n  for (const [k, v] of Object.entries(delta)) {\n    mixAdd(out, k, v);\n  }\n  return out;\n}\n\nexport function mixTotal(mix: Mix): number {\n  return Object.values(mix).reduce((acc, v) => acc + v, 0);\n}\n\nexport function clamp(x: number, lo: number, hi: number): number {\n  return Math.max(lo, Math.min(hi, x));\n}\n\n/* =========================\n   Reaction system\n========================= */\n\nexport interface ReactionContext {\n  mix: Mix;\n  temperature?: number;\n  pH?: number;\n  catalysts?: Mix;\n  tags?: Record<string, number>;\n}\n\ntype Condition = (ctx: ReactionContext) => number;\n\nexport class ReactionRule {\n  readonly inputs: Mix;\n  readonly outputs: Mix;\n  readonly rate: number;\n  readonly condition: Condition;\n\n  constructor(opts: { inputs: Mix; outputs: Mix; rate: number; condition?: Condition }) {\n    this.inputs = opts.inputs;\n    this.outputs = opts.outputs;\n    this.rate = opts.rate;\n    this.condition = opts.condition ?? (() => 1);\n  }\n\n  apply(ctx: ReactionContext, dt: number): void {\n    const cond = clamp(this.condition(ctx), 0, 3);\n    if (cond <= 0) return;\n\n    let limit = Number.POSITIVE_INFINITY;\n    for (const [k, need] of Object.entries(this.inputs)) {\n      if (need <= 0) continue;\n      const available = mixGet(ctx.mix, k);\n      limit = Math.min(limit, available / need);\n    }\n\n    if (!Number.isFinite(limit) || limit <= 0) return;\n\n    const extent = this.rate * dt * cond * limit;\n    if (extent <= 0) return;\n\n    for (const [k, need] of Object.entries(this.inputs)) {\n      mixAdd(ctx.mix, k, -need * extent);\n    }\n    for (const [k, out] of Object.entries(this.outputs)) {\n      mixAdd(ctx.mix, k, out * extent);\n    }\n  }\n}\n\n/* =========================\n   Conditions helpers\n========================= */\n\nexport function temperatureWindow(lo: number, hi: number): Condition {\n  return (ctx) =>\n    ctx.temperature !== undefined && ctx.temperature >= lo && ctx.temperature <= hi ? 1 : 0;\n}\n\nexport function catalystBoost(catalyst: Substance, strength: number): Condition {\n  return (ctx) => {\n    const boost = mixGet(ctx.catalysts ?? {}, catalyst);\n    return clamp(1 + strength * boost, 0, 3);\n  };\n}\n\nexport function tagThreshold(tag: string, threshold: number, slope = 10): Condition {\n  return (ctx) => {\n    const val = ctx.tags?.[tag] ?? 0;\n    return 1 / (1 + Math.exp(-slope * (val - threshold)));\n  };\n}\n\n/* =========================\n   DNA entities\n========================= */\n\nexport interface DnaItem {\n  name: string;\n  mix: Mix;\n  structure?: Record<string, number>;\n}\n\nexport interface DnaNpc {\n  name: string;\n  body: Mix;\n  stomach?: Mix;\n  blood?: Mix;\n  energy?: number;\n  pain?: number;\n  mood?: number;\n  focus?: number;\n  hunger?: number;\n  thirst?: number;\n  social?: number;\n}\n\n/* =========================\n   Metabolism\n========================= */\n\nexport function ingest(npc: DnaNpc, item: DnaItem, amount = 1): void {\n  npc.stomach = mixMerge(npc.stomach ?? {}, mixScale(item.mix, amount));\n}\n\nexport function tickMetabolism(npc: DnaNpc, reactions: ReactionRule[], dt: number): void {\n  const ctx: ReactionContext = {\n    mix: npc.stomach ?? {},\n    temperature: mixGet(npc.body, 'TEMP'),\n    pH: mixGet(npc.body, 'PH'),\n    catalysts: Object.fromEntries(\n      Object.entries(npc.body).filter(([k]) => k.startsWith('ENZ_')),\n    ),\n  };\n\n  for (const reaction of reactions) {\n    reaction.apply(ctx, dt);\n  }\n\n  npc.stomach = ctx.mix;\n\n  const absorbedFraction = clamp(0.1 * dt, 0, 0.5);\n  const absorbed = mixScale(npc.stomach, absorbedFraction);\n\n  npc.stomach = mixMerge(npc.stomach, mixScale(absorbed, -1));\n  npc.body = mixMerge(npc.body, absorbed);\n\n  deriveMacroStates(npc, dt);\n}\n\nfunction deriveMacroStates(npc: DnaNpc, dt: number): void {\n  const glu = mixGet(npc.body, 'GLU');\n  const atp = mixGet(npc.body, 'ATP');\n  const ser = mixGet(npc.body, 'SER');\n  const water = mixGet(npc.body, 'H2O');\n  const o2 = mixGet(npc.body, 'O2');\n\n  const oxidativeStress = mixGet(npc.body, 'OX_STRESS') + 0.5 * mixGet(npc.body, 'OXIDIZER');\n  const hydrationLoad = Math.max(0, 0.3 - water) + mixGet(npc.body, 'DEHYDRATION_SIGNAL');\n  const oxygenDebt = Math.max(0, 0.3 - o2);\n  const phStress = Math.max(\n    0,\n    mixGet(npc.body, 'PH_ACID') + mixGet(npc.body, 'PH_BASE') + mixGet(npc.body, 'PH_SHIFT') - mixGet(npc.body, 'PH_BUFFER'),\n  );\n  const chelationStress = mixGet(npc.body, 'CHELATED_METAL');\n\n  const stressChems =\n    mixGet(npc.body, 'STRESS') +\n    mixGet(npc.body, 'CORT') +\n    mixGet(npc.body, 'ADREN') +\n    oxidativeStress +\n    phStress +\n    hydrationLoad +\n    chelationStress;\n\n  const socialBond = mixGet(npc.body, 'SOCIAL_BOND');\n  const dopa = mixGet(npc.body, 'DOPA');\n\n  npc.energy = clamp(\n    (npc.energy ?? 0.5) + (0.05 * atp + 0.02 * glu - 0.04 * oxygenDebt - 0.04 * phStress - 0.03 * hydrationLoad) * dt,\n    0,\n    1,\n  );\n  npc.pain = clamp(\n    (npc.pain ?? 0) + (0.05 * oxidativeStress + 0.04 * phStress + 0.04 * hydrationLoad + 0.02 * chelationStress) * dt,\n    0,\n    1,\n  );\n  npc.mood = clamp(\n    (npc.mood ?? 0.5) + (0.04 * ser - 0.02 * stressChems - 0.03 * phStress - 0.02 * hydrationLoad) * dt,\n    0,\n    1,\n  );\n  npc.focus = clamp((npc.focus ?? 0.5) + (0.04 * dopa - 0.03 * stressChems) * dt, 0, 1);\n  npc.hunger = clamp((npc.hunger ?? 0.5) + (0.03 - 0.05 * glu - 0.04 * atp) * dt, 0, 1);\n  npc.thirst = clamp((npc.thirst ?? 0.5) + (0.03 + 0.05 * hydrationLoad - 0.08 * water) * dt, 0, 1);\n  npc.social = clamp((npc.social ?? 0.5) + (0.04 * socialBond - 0.02 * stressChems) * dt, 0, 1);\n}\n\n/* =========================\n   Reactor (crafting / world)\n========================= */\n\nexport function runReactor(\n  itemMix: Mix,\n  options: { temperature?: number; catalysts?: Mix; tags?: Record<string, number>; steps?: number; dt?: number },\n  reactions: ReactionRule[],\n): Mix {\n  const ctx: ReactionContext = {\n    mix: { ...itemMix },\n    temperature: options.temperature,\n    catalysts: options.catalysts,\n    tags: options.tags,\n  };\n\n  const steps = options.steps ?? 10;\n  const dt = options.dt ?? 1;\n\n  for (let i = 0; i < steps; i++) {\n    for (const reaction of reactions) {\n      reaction.apply(ctx, dt);\n    }\n  }\n\n  return ctx.mix;\n}\n\n/* =========================\n   Macro snapshot (read-only)\n========================= */\n\nexport interface MacroSnapshot {\n  energy: number;\n  pain: number;\n  mood: number;\n  focus: number;\n  hungerSignal: number;\n  thirstSignal: number;\n  stress: number;\n}\n\nexport function deriveMacroSnapshot(body: Mix): MacroSnapshot {\n  const glu = mixGet(body, 'GLU');\n  const atp = mixGet(body, 'ATP');\n  const ser = mixGet(body, 'SER');\n  const water = mixGet(body, 'H2O');\n  const o2 = mixGet(body, 'O2');\n\n  const oxidativeStress = mixGet(body, 'OX_STRESS') + 0.5 * mixGet(body, 'OXIDIZER');\n  const hydrationLoad = Math.max(0, 0.3 - water) + mixGet(body, 'DEHYDRATION_SIGNAL');\n  const oxygenDebt = Math.max(0, 0.3 - o2);\n  const phStress = Math.max(\n    0,\n    mixGet(body, 'PH_ACID') + mixGet(body, 'PH_BASE') + mixGet(body, 'PH_SHIFT') - mixGet(body, 'PH_BUFFER'),\n  );\n  const chelationStress = mixGet(body, 'CHELATED_METAL');\n\n  const stressChems =\n    mixGet(body, 'STRESS') +\n    mixGet(body, 'CORT') +\n    mixGet(body, 'ADREN') +\n    oxidativeStress +\n    phStress +\n    hydrationLoad +\n    chelationStress;\n  const dopa = mixGet(body, 'DOPA');\n\n  return {\n    energy: clamp(0.5 + (0.05 * atp + 0.02 * glu - 0.04 * oxygenDebt - 0.04 * phStress - 0.03 * hydrationLoad), 0, 1),\n    pain: clamp(0.05 * oxidativeStress + 0.04 * phStress + 0.04 * hydrationLoad + 0.02 * chelationStress, 0, 1),\n    mood: clamp(0.5 + (0.04 * ser - 0.02 * stressChems - 0.03 * phStress - 0.02 * hydrationLoad), 0, 1),\n    focus: clamp(0.5 + (0.04 * dopa - 0.03 * stressChems), 0, 1),\n    hungerSignal: clamp(0.5 + (0.03 - 0.05 * glu - 0.04 * atp), 0, 1),\n    thirstSignal: clamp(0.5 + (0.03 + 0.05 * hydrationLoad - 0.08 * water), 0, 1),\n    stress: clamp(stressChems, 0, 1),\n  };\n}\n\n/* =========================\n   Reaction libraries\n========================= */\n\nexport const SUBSTANCES: Substance[] = [\n  // Atmosphere and basics\n  'H2O',\n  'O2',\n  'CO2',\n  'N2',\n  'TEMP',\n  'PH',\n  'HUMIDADE',\n  'D',\n  'Y',\n\n  // Homeostasis helpers\n  'PH_BUFFER',\n  'PH_ACID',\n  'PH_BASE',\n  'PH_SHIFT',\n  'OXIDIZER',\n  'OX_STRESS',\n  'CHELATOR',\n  'CHELATED_METAL',\n  'DEHYDRATION_SIGNAL',\n\n  // Minerals and geology\n  'SILICA',\n  'MINERAL_DUST',\n  'SALT',\n  'CLAY',\n  'LIMESTONE',\n  'ASH',\n\n  // Metals and ores\n  'IRON',\n  'CARBON',\n  'ORE_FE',\n  'ORE_CU',\n  'ORE_SN',\n  'ORE_COAL',\n  'ORE_AU',\n  'PIG_IRON',\n  'BRONZE',\n  'STEEL',\n  'SLAG',\n\n  // Fuels\n  'COAL',\n  'CHAR',\n  'OIL',\n\n  // Biological basics\n  'GLU',\n  'FRUCT',\n  'FIBER',\n  'RESIN',\n  'FAT',\n  'PROTEIN',\n  'AMARGO',\n  'DOCE',\n  'UMAMI',\n  'BIO_MASS',\n\n  // Signaling and metabolism\n  'ATP',\n  'SER',\n  'DOPA',\n  'CORT',\n  'ADREN',\n  'STRESS',\n  'SOCIAL_BOND',\n  'ENZ_X',\n  'ENZ_METAL',\n];\n\nexport const REACTIONS_WORLD: ReactionRule[] = [\n  new ReactionRule({\n    inputs: { H2O: 0.5 },\n    outputs: { HUMIDADE: 0.5 },\n    rate: 0.05,\n    condition: tagThreshold('rainfall', 0.6),\n  }),\n  new ReactionRule({ inputs: { MINERAL_DUST: 1, H2O: 0.2 }, outputs: { SALT: 0.3 }, rate: 0.05 }),\n];\n\nexport const REACTIONS_BODY: ReactionRule[] = [\n  new ReactionRule({ inputs: { GLU: 1, O2: 1 }, outputs: { ATP: 1, CO2: 1 }, rate: 0.2 }),\n  new ReactionRule({ inputs: { FRUCT: 1, O2: 1 }, outputs: { ATP: 0.8, CO2: 1 }, rate: 0.18 }),\n  new ReactionRule({ inputs: { ATP: 1 }, outputs: { TEMP: 0.02 }, rate: 0.1 }),\n  new ReactionRule({ inputs: { ATP: 1, OXIDIZER: 0.4 }, outputs: { OX_STRESS: 0.6, CO2: 0.4 }, rate: 0.12 }),\n  new ReactionRule({ inputs: { IRON: 0.3, CHELATOR: 0.4 }, outputs: { CHELATED_METAL: 0.6 }, rate: 0.08 }),\n  new ReactionRule({ inputs: { H2O: 1, SALT: 0.4 }, outputs: { DEHYDRATION_SIGNAL: 0.6 }, rate: 0.1 }),\n  new ReactionRule({ inputs: { PH: 0.1, PH_ACID: 0.5 }, outputs: { PH_SHIFT: 0.5 }, rate: 0.1 }),\n  new ReactionRule({ inputs: { PH: 0.1, PH_BASE: 0.5 }, outputs: { PH_SHIFT: 0.5 }, rate: 0.1 }),\n  new ReactionRule({ inputs: { PH_SHIFT: 0.5, PH_BUFFER: 0.5 }, outputs: {}, rate: 0.6 }),\n  new ReactionRule({ inputs: { OXIDIZER: 0.4, PH_BUFFER: 0.4 }, outputs: { OX_STRESS: 0.2 }, rate: 0.2 }),\n];\n\nexport const REACTIONS_SOCIAL: ReactionRule[] = [\n  new ReactionRule({\n    inputs: { SER: 0.2, DOPA: 0.2 },\n    outputs: { SOCIAL_BOND: 0.4 },\n    rate: 0.08,\n    condition: tagThreshold('trust', 0.5),\n  }),\n];\n\nexport const REACTIONS_LIBRARY = {\n  SUBSTANCES,\n  REACTIONS_WORLD,\n  REACTIONS_BODY,\n  REACTIONS_SOCIAL,\n};\n\nexport type ReactionLibrary = typeof REACTIONS_LIBRARY;\n\nexport function flattenReactions(library: ReactionLibrary): ReactionRule[] {\n  return [...library.REACTIONS_WORLD, ...library.REACTIONS_BODY, ...library.REACTIONS_SOCIAL];\n}\n\n/* Backward compatibility */\nexport const SAMPLE_REACTIONS: ReactionRule[] = [...REACTIONS_BODY];\n","import type { MacroSnapshot, Mix, ReactionRule } from '../dna';\nimport { deriveMacroSnapshot, tickMetabolism } from '../dna';\nimport type { NPC } from '../types';\n\nexport interface ChemistryState {\n  body: Mix;\n  stomach: Mix;\n  blood: Mix;\n  lastMacro?: MacroSnapshot;\n}\n\nexport function ensureChemistry(npc: NPC): ChemistryState {\n  if (!npc.chemistry) {\n    npc.chemistry = {\n      body: { GLU: 0.5, H2O: 0.5, O2: 0.5, TEMP: 0.5, PH: 0.5 },\n      stomach: {},\n      blood: {},\n    };\n  }\n  npc.chemistry.body ??= { GLU: 0.5, H2O: 0.5, O2: 0.5, TEMP: 0.5, PH: 0.5 };\n  npc.chemistry.stomach ??= {};\n  npc.chemistry.blood ??= {};\n  return npc.chemistry as ChemistryState;\n}\n\nexport function tickNpcChemistry(npc: NPC, reactions: ReactionRule[], dtSeconds: number): MacroSnapshot {\n  const chemistry = ensureChemistry(npc);\n  const dnaNpc = {\n    name: npc.name,\n    body: chemistry.body,\n    stomach: chemistry.stomach,\n    blood: chemistry.blood,\n  };\n\n  tickMetabolism(dnaNpc, reactions, dtSeconds);\n\n  chemistry.body = dnaNpc.body;\n  chemistry.stomach = dnaNpc.stomach ?? chemistry.stomach;\n  chemistry.blood = dnaNpc.blood ?? chemistry.blood;\n\n  const macro = deriveMacroSnapshot(chemistry.body);\n  chemistry.lastMacro = macro;\n  return macro;\n}\n","import { EPS, mixTotal, type Mix } from '../dna';\nimport type { ItemId } from '../types';\n\nconst TAG_THRESHOLD = 0.05;\n\nfunction relevantEntries(mix: Mix): [string, number][] {\n  return Object.entries(mix).filter(([, v]) => v > EPS);\n}\n\nexport function normalizeMix(mix: Mix): Mix {\n  const filtered: Mix = {};\n  for (const [k, v] of relevantEntries(mix)) {\n    filtered[k] = v;\n  }\n\n  const total = mixTotal(filtered);\n  if (total <= EPS) return {};\n\n  const normalized: Mix = {};\n  for (const [k, v] of Object.entries(filtered)) {\n    normalized[k] = v / total;\n  }\n  return normalized;\n}\n\nexport function mixSignature(mix: Mix): string {\n  const normalized = normalizeMix(mix);\n  const parts = Object.entries(normalized)\n    .sort(([a], [b]) => a.localeCompare(b))\n    .map(([k, v]) => `${k}:${(Math.round(v * 1000) / 1000).toFixed(3)}`);\n  return parts.length ? parts.join('|') : 'empty';\n}\n\nfunction hasRelevant(mix: Mix, predicate: (entry: [string, number]) => boolean): boolean {\n  return relevantEntries(mix).some(predicate);\n}\n\nfunction proportion(mix: Mix, keys: string[]): number {\n  const normalized = normalizeMix(mix);\n  return keys.reduce((acc, key) => acc + (normalized[key] ?? 0), 0);\n}\n\nexport function analyzeMix(mix: Mix): {\n  tags: string[];\n  traits: Record<string, number>;\n  canonicalName: string;\n  displayName: string;\n  signature: string;\n} {\n  const normalized = normalizeMix(mix);\n  const tags: string[] = [];\n\n  const ore = hasRelevant(normalized, ([k, v]) => k.startsWith('ORE_') && v > TAG_THRESHOLD);\n  const metal = hasRelevant(normalized, ([k, v]) => ['IRON', 'FE', 'CU', 'SN', 'AU'].includes(k) && v > TAG_THRESHOLD);\n  const fiberShare = proportion(normalized, ['FIBER']);\n  const resinShare = proportion(normalized, ['RESIN']);\n  const wood = resinShare > 0.1 || (fiberShare > 0.25 && resinShare > 0.05);\n  const fiber = fiberShare > TAG_THRESHOLD;\n  const stone = !ore && hasRelevant(normalized, ([k, v]) => ['SILICA', 'MINERAL_DUST'].includes(k) && v > TAG_THRESHOLD);\n  const hydration = proportion(normalized, ['H2O']);\n  const food = hasRelevant(normalized, ([k, v]) => ['GLU', 'FRUCT', 'UMAMI', 'FAT', 'PROTEIN'].includes(k) && v > TAG_THRESHOLD);\n  const drink = hydration > 0.2;\n  const fuel = hasRelevant(normalized, ([k, v]) => ['CARBON', 'COAL', 'ORE_COAL'].includes(k) && v > TAG_THRESHOLD);\n  const reactive = hasRelevant(normalized, ([k, v]) =>\n    ['OXIDIZER', 'PH_ACID', 'PH_BASE', 'CHELATOR'].includes(k) && v > TAG_THRESHOLD,\n  );\n  const balancer = hasRelevant(normalized, ([k, v]) => k === 'PH_BUFFER' && v > TAG_THRESHOLD);\n  const forgedMarker = normalized.FORGED ?? 0;\n  const refinedMarker = normalized.REFINED ?? 0;\n\n  if (ore) tags.push('ore');\n  if (metal) tags.push('metal');\n  if (wood) tags.push('wood');\n  else if (fiber) tags.push('fiber');\n  if (stone) tags.push('stone');\n  if (food) tags.push('food');\n  if (drink) tags.push('drink');\n  if (fuel) tags.push('fuel');\n  if (reactive) tags.push('reactive');\n  if (balancer) tags.push('balancing');\n  if (food || wood) tags.push('organic');\n  if (ore || stone || metal) tags.push('inorganic');\n  if (forgedMarker > TAG_THRESHOLD) {\n    tags.push('forged');\n    if (!tags.includes('tool')) tags.push('tool');\n  }\n  if (refinedMarker > TAG_THRESHOLD) {\n    tags.push('refined');\n    if (!tags.includes('material')) tags.push('material');\n  }\n\n  const calories = proportion(normalized, ['GLU', 'FRUCT', 'FAT', 'PROTEIN']);\n  const bitterness = proportion(normalized, ['AMARGO']);\n  const umami = proportion(normalized, ['UMAMI']);\n  const mineralness = proportion(normalized, ['SILICA', 'MINERAL_DUST', 'SALT', 'SLAG']);\n  const metalness = proportion(normalized, [\n    'IRON',\n    'FE',\n    'CU',\n    'SN',\n    'AU',\n    'ORE_FE',\n    'ORE_CU',\n    'ORE_SN',\n    'ORE_AU',\n    'ORE_COAL',\n  ]);\n\n  const oxidizingPower = proportion(normalized, ['OXIDIZER']);\n  const acidityPotential = proportion(normalized, ['PH_ACID']);\n  const basicityPotential = proportion(normalized, ['PH_BASE']);\n  const chelatingPower = proportion(normalized, ['CHELATOR']);\n  const bufferingPower = proportion(normalized, ['PH_BUFFER']);\n  const osmoticLoad = proportion(normalized, ['SALT']);\n  const reactivity = oxidizingPower + acidityPotential + basicityPotential + chelatingPower + osmoticLoad;\n\n  const traits = {\n    hydration,\n    calories,\n    bitterness,\n    umami,\n    mineralness,\n    metalness,\n    oxidizingPower,\n    acidityPotential,\n    basicityPotential,\n    chelatingPower,\n    bufferingPower,\n    osmoticLoad,\n    reactivity,\n  } satisfies Record<string, number>;\n\n  const oreEntries = Object.entries(normalized).filter(([k]) => k.startsWith('ORE_'));\n  const dominantOre = oreEntries.length\n    ? oreEntries.reduce((best, current) => (current[1] > best[1] ? current : best))[0]\n    : undefined;\n  const metalCandidates = ['FE', 'IRON', 'CU', 'SN', 'AU', 'ORE_FE', 'ORE_CU', 'ORE_SN', 'ORE_AU'];\n  const dominantMetalEntry = Object.entries(normalized)\n    .filter(([k]) => metalCandidates.includes(k))\n    .reduce<[string, number] | null>((best, current) => {\n      if (!best || current[1] > best[1]) return current;\n      return best;\n    }, null);\n  const dominantMetal = dominantMetalEntry?.[0];\n\n  const oreNameMap: Record<string, string> = {\n    ORE_FE: 'Iron Ore',\n    ORE_CU: 'Copper Ore',\n    ORE_SN: 'Tin Ore',\n    ORE_AU: 'Gold Ore',\n  };\n\n  const metalNameMap: Record<string, string> = {\n    FE: 'Iron',\n    IRON: 'Iron',\n    CU: 'Copper',\n    SN: 'Tin',\n    AU: 'Gold',\n    ORE_FE: 'Iron',\n    ORE_CU: 'Copper',\n    ORE_SN: 'Tin',\n    ORE_AU: 'Gold',\n  };\n\n  let canonicalName = 'Material';\n  if (forgedMarker > TAG_THRESHOLD && (tags.includes('metal') || tags.includes('ore'))) {\n    const metalName = dominantMetal ? metalNameMap[dominantMetal] ?? 'Metal' : 'Metal';\n    canonicalName = `${metalName} Tool`;\n  } else if (refinedMarker > TAG_THRESHOLD && (tags.includes('ore') || tags.includes('metal'))) {\n    const metalName = dominantMetal ? metalNameMap[dominantMetal] ?? 'Metal' : 'Metal';\n    canonicalName = dominantMetal ? `${metalName} Ingot` : 'Refined Metal';\n  } else if (tags.includes('ore')) {\n    canonicalName = dominantOre ? oreNameMap[dominantOre] ?? 'Ore' : 'Ore';\n  } else if (tags.includes('wood')) {\n    canonicalName = 'Wood';\n  } else if (tags.includes('stone')) {\n    canonicalName = 'Stone';\n  } else if (tags.includes('drink')) {\n    canonicalName = traits.hydration > 0.7 && (normalized.H2O ?? 0) > 0.7 ? 'Water' : 'Drink';\n  } else if (tags.includes('food')) {\n    canonicalName = 'Food';\n  } else if (tags.includes('fuel')) {\n    canonicalName = 'Fuel';\n  }\n\n  const qualifiers: string[] = [];\n  if (traits.mineralness > 0.35 && tags.includes('drink')) qualifiers.push('brackish');\n  if (traits.mineralness > 0.35 && (tags.includes('ore') || tags.includes('metal'))) qualifiers.push('impure');\n  if (traits.calories > 0.45 && tags.includes('food')) qualifiers.push('nutritious');\n  if (traits.reactivity > 0.35) qualifiers.push('reactive');\n\n  const displayName = qualifiers.length ? `${canonicalName} (${qualifiers.join(', ')})` : canonicalName;\n\n  return {\n    tags,\n    traits,\n    canonicalName,\n    displayName,\n    signature: mixSignature(mix),\n  };\n}\n\nexport interface AnalyzableItem {\n  id: ItemId | string;\n  name: string;\n  mix: Mix;\n  tags?: string[];\n  traits?: Record<string, number>;\n  canonicalName?: string;\n  displayName?: string;\n  signature?: string;\n}\n\nexport function applyAnalysisToItem<T extends AnalyzableItem>(item: T): T {\n  const analysis = analyzeMix(item.mix);\n  // TODO: In modular crafting, downstream systems can lean on tags/traits/signature to unlock recipes and learning.\n  return {\n    ...item,\n    ...analysis,\n    name: analysis.displayName,\n  };\n}\n","import type { Mix } from '../dna';\nimport { mixMerge } from '../dna';\nimport { applyAnalysisToItem } from './itemAnalyzer';\nimport type { ItemId } from '../types';\n\nexport interface ItemDefinition {\n  id: ItemId;\n  name: string;\n  mix: Mix;\n  tags?: string[];\n  traits?: Record<string, number>;\n  canonicalName?: string;\n  displayName?: string;\n  signature?: string;\n}\n\n/**\n * Registry that maps ItemId -> Mix. Items are defined by their chemical DNA, not by a static template.\n */\nexport class ItemRegistry {\n  private items: Map<ItemId, ItemDefinition> = new Map();\n  private counter = 0;\n\n  constructor(seedItems?: ItemDefinition[]) {\n    seedItems?.forEach((item) => {\n      const analyzed = applyAnalysisToItem(item);\n      this.items.set(analyzed.id, { ...analyzed, mix: { ...analyzed.mix } });\n    });\n  }\n\n  register(id: ItemId, name: string, mix: Mix): ItemId {\n    const analyzed = applyAnalysisToItem({ id, name, mix });\n    this.items.set(id, { ...analyzed, mix: { ...analyzed.mix } });\n    return id;\n  }\n\n  spawnFromMix(name: string, mix: Mix): ItemId {\n    this.counter += 1;\n    const id = `${name.toLowerCase().replace(/\\s+/g, '-')}-${this.counter}` as ItemId;\n    return this.register(id, name, mix);\n  }\n\n  getItem(id: ItemId): ItemDefinition | undefined {\n    const item = this.items.get(id);\n    return item ? { ...item, mix: { ...item.mix } } : undefined;\n  }\n\n  getMix(id: ItemId): Mix | undefined {\n    const item = this.items.get(id);\n    return item ? { ...item.mix } : undefined;\n  }\n\n  mergeItemMix(id: ItemId, delta: Mix): void {\n    const item = this.items.get(id);\n    if (!item) return;\n    item.mix = mixMerge(item.mix, delta);\n  }\n\n  list(): ItemDefinition[] {\n    return Array.from(this.items.values()).map((item) => ({ ...item, mix: { ...item.mix } }));\n  }\n}\n\nexport function createSeedItemRegistry(): ItemRegistry {\n  const seedItems: ItemDefinition[] = [\n    { id: 'berry-red', name: 'Red Berry', mix: { GLU: 0.6, FRUCT: 0.4, DOCE: 0.2, H2O: 0.5 } },\n    { id: 'ore-iron', name: 'Iron Ore', mix: { ORE_FE: 1, MINERAL_DUST: 0.1 } },\n    { id: 'ore-copper', name: 'Copper Ore', mix: { ORE_CU: 1, MINERAL_DUST: 0.1 } },\n    { id: 'water-flask', name: 'Canteen', mix: { H2O: 1 } },\n    { id: 'raw-wood', name: 'Wood', mix: { FIBER: 0.6, RESIN: 0.3, H2O: 0.2 } },\n    { id: 'raw-stone', name: 'Stone', mix: { SILICA: 0.5, MINERAL_DUST: 0.4 } },\n    { id: 'raw-coal', name: 'Coal', mix: { CARBON: 0.5, ORE_COAL: 0.5, COAL: 0.3 } },\n    { id: 'raw-salt', name: 'Salt', mix: { SALT: 0.8 } },\n    { id: 'raw-water', name: 'Water', mix: { H2O: 1 } },\n    { id: 'raw-wool', name: 'Raw Wool', mix: { FIBER: 0.7, PROTEIN: 0.2, H2O: 0.1 } },\n    { id: 'raw-cotton', name: 'Cotton Bale', mix: { FIBER: 0.8, H2O: 0.15 } },\n    { id: 'raw-leather', name: 'Raw Leather', mix: { PROTEIN: 0.6, FAT: 0.2, FIBER: 0.1, H2O: 0.1 } },\n    { id: 'raw-herb', name: 'Aromatic Herbs', mix: { GLU: 0.2, H2O: 0.4, PH_BUFFER: 0.1, UMAMI: 0.1 } },\n    { id: 'raw-grain', name: 'Grains', mix: { GLU: 0.5, FIBER: 0.3, H2O: 0.1 } },\n  ];\n\n  return new ItemRegistry(seedItems);\n}\n","import { mixAdd, mixMerge, mixScale, runReactor, type Mix, type ReactionRule } from '../dna';\nimport type { CraftProcess } from '../types';\nimport type { ItemDefinition, ItemRegistry } from '../world/items';\n\nexport function combineMixes(items: ItemDefinition[], weights?: number[]): Mix {\n  if (items.length === 0) return {};\n  const normalizedWeights = weights && weights.length === items.length\n    ? weights\n    : new Array(items.length).fill(1);\n  const weightSum = normalizedWeights.reduce((acc, w) => acc + Math.max(w, 0), 0) || items.length;\n\n  return items.reduce<Mix>((acc, item, idx) => {\n    const weight = Math.max(normalizedWeights[idx] ?? 1, 0) / weightSum;\n    const scaled = mixScale(item.mix, weight);\n    return mixMerge(acc, scaled);\n  }, {});\n}\n\nexport function processOptions(process: CraftProcess): {\n  temperature?: number;\n  tags?: Record<string, number>;\n  catalysts?: Mix;\n  steps?: number;\n  dt?: number;\n} {\n  switch (process) {\n    case 'forge':\n      return { temperature: 0.9, tags: { heat: 1 }, steps: 8, dt: 0.8 };\n    case 'cook':\n      return { temperature: 0.65, tags: { heat: 0.6, wet: 0.2 }, steps: 6, dt: 0.6 };\n    case 'brew':\n      return { temperature: 0.55, tags: { wet: 1 }, steps: 10, dt: 0.5 };\n    case 'refine':\n      return { temperature: 0.75, tags: { heat: 0.8, oxidize: 0.5 }, steps: 7, dt: 0.7 };\n    default:\n      return {};\n  }\n}\n\ninterface RandomLike {\n  choice<T>(array: T[]): T;\n  next?(): number;\n}\n\nexport function craftOnce(\n  random: RandomLike,\n  itemRegistry: ItemRegistry,\n  reactions: ReactionRule[],\n  inputs: ItemDefinition[],\n  process: CraftProcess,\n  labelHint: string,\n  weights?: number[],\n): string {\n  const combined = combineMixes(inputs, weights);\n  // TODO: Replace FORGED/REFINED markers with richer reaction pathways (ore -> ingot -> tool modular).\n  if (process === 'forge') {\n    mixAdd(combined, 'FORGED', 0.1);\n  } else if (process === 'refine') {\n    mixAdd(combined, 'REFINED', 0.1);\n  }\n  const options = processOptions(process);\n  const variation = typeof random?.choice === 'function' && 'next' in random ? random.next!() : Math.random();\n  const reactedMix = runReactor(\n    combined,\n    { ...options, tags: { ...(options.tags ?? {}), variation } },\n    reactions,\n  );\n  const label = labelHint || `${process} craft`;\n  return itemRegistry.spawnFromMix(label, reactedMix);\n}\n","import {\n  deriveMacroSnapshot,\n  tickMetabolism,\n  type MacroSnapshot,\n  type Mix,\n  type ReactionRule,\n  type Substance,\n} from '../dna';\n\nexport interface IngestionSimulationResult {\n  before: MacroSnapshot;\n  after: MacroSnapshot;\n  essentialDelta: Record<string, number>;\n  notes: string[];\n}\n\nexport function simulateIngestion(\n  body: Mix,\n  item: Mix,\n  reactions: ReactionRule[],\n  steps = 5,\n  dt = 0.5,\n): IngestionSimulationResult {\n  const before = deriveMacroSnapshot(body);\n  const working = {\n    name: 'ingestion-sim',\n    body: { ...body },\n    stomach: { ...item },\n    blood: {},\n  };\n\n  for (let i = 0; i < steps; i++) {\n    tickMetabolism(working, reactions, dt);\n  }\n\n  const after = deriveMacroSnapshot(working.body);\n  const essentialKeys: Substance[] = ['ATP', 'H2O', 'O2', 'GLU', 'PH', 'TEMP'];\n  const essentialDelta: Record<string, number> = {};\n\n  for (const key of essentialKeys) {\n    essentialDelta[key] = (working.body[key] ?? 0) - (body[key] ?? 0);\n  }\n\n  const notes: string[] = [];\n  if (essentialDelta.H2O > 0.05) notes.push('positive hydration');\n  if (essentialDelta.H2O < -0.05) notes.push('reduced hydration');\n  if (essentialDelta.ATP > 0.05) notes.push('increased potential energy');\n  if (essentialDelta.O2 < -0.05) notes.push('oxygen consumed');\n  if (essentialDelta.PH < -0.05) notes.push('acidifying tendency');\n  if (essentialDelta.PH > 0.05) notes.push('alkalizing tendency');\n\n  // TODO: future NPC learning loop can score items based on deltas and observed macro changes.\n  return { before, after, essentialDelta, notes };\n}\n","import type { ItemId, PoiId } from '../types';\nimport type { ItemDefinition, ItemRegistry } from './items';\n\ninterface RandomLike {\n  choice<T>(array: T[]): T;\n  next?(): number;\n}\n\nexport type Stockpile = Record<ItemId, number>;\nexport type StockpilesByPoi = Record<PoiId, Stockpile>;\n\nexport function stockHas(stock: Stockpile, itemId: ItemId, qty: number): boolean {\n  return (stock[itemId] ?? 0) >= qty;\n}\n\nexport function stockAdd(stock: Stockpile, itemId: ItemId, qty: number): void {\n  if (qty <= 0) return;\n  stock[itemId] = (stock[itemId] ?? 0) + qty;\n}\n\nexport function stockRemove(stock: Stockpile, itemId: ItemId, qty: number): boolean {\n  if (!stockHas(stock, itemId, qty)) return false;\n  const next = (stock[itemId] ?? 0) - qty;\n  if (next <= 0) {\n    delete stock[itemId];\n  } else {\n    stock[itemId] = next;\n  }\n  return true;\n}\n\nexport function stockPickByTag(\n  stock: Stockpile,\n  itemRegistry: ItemRegistry,\n  tag: string,\n  random: RandomLike,\n): ItemDefinition | null {\n  const candidates = itemRegistry\n    .list()\n    .filter((item) => item.tags?.includes(tag) && stockHas(stock, item.id, 1));\n\n  if (candidates.length === 0) return null;\n\n  return random.choice(candidates);\n}\n\nexport function getPoiStockpile(stockpilesByPoi: StockpilesByPoi, poiId: PoiId): Stockpile {\n  if (!stockpilesByPoi[poiId]) {\n    stockpilesByPoi[poiId] = {};\n  }\n  return stockpilesByPoi[poiId];\n}\n","/**\n * Core game engine - manages game state and logic\n */\n\nimport type {\n  GameState,\n  Player,\n  Quest,\n  NPC,\n  ReportLogEntry,\n  Family,\n  Caste,\n  Stats,\n  ItemId,\n  CraftIntent,\n  CraftProcess,\n  PoiId,\n} from './types';\nimport { WorldMap, type POI } from './world/map';\nimport { findPath, isPathValid } from './systems/pathfinding';\nimport { WorldIndices } from './world/indices';\nimport { validateIndices, logValidationResults } from './world/validation';\nimport { transferGold, calculateTotalGold, validateEconomyInvariants, initializeEconomy } from './systems/economy';\nimport { modifyNeed, satisfyNeed, syncNeedsFromMacro } from './systems/needs';\nimport { performSocialInteraction } from './systems/social';\nimport { inventoryAdd, inventoryRemove, inventoryHas } from './world/inventory';\nimport { tickNpcChemistry } from './systems/chemistry';\nimport { mixMerge, REACTIONS_BODY, REACTIONS_LIBRARY, runReactor, flattenReactions, type Mix } from './dna';\nimport { createSeedItemRegistry, ItemRegistry, type ItemDefinition } from './world/items';\nimport { mixSignature } from './world/itemAnalyzer';\nimport { craftOnce } from './systems/crafting';\nimport { simulateIngestion } from './systems/chemistryEvaluation';\nimport { getPoiStockpile, stockAdd, stockHas, stockPickByTag, stockRemove, type Stockpile, type StockpilesByPoi } from './world/stockpile';\n\n// Constants for simulation\nconst SECONDS_PER_DAY = 1200; // 20 minutes per day\nconst ACTION_TICK_INTERVAL = 2000; // 2 seconds in milliseconds\nconst MAX_REPORT_LOG_LINES = 500;\n\n// --- Talents -------------------------------------------------\nconst JOB_TALENTS: Record<string, string[]> = {\n  Blacksmith: ['forge'],\n  Artisan: ['craft'],\n  Tailor: ['tailor'],\n  Builder: ['build'],\n  Weaver: ['weave'],\n  Lumberjack: ['harvest_wood'],\n  Farmer: ['grow_food'],\n  Rancher: ['raise_animals'],\n  Fisher: ['fish'],\n  Hunter: ['hunt'],\n  Miner: ['mine_ore'],\n  Alchemist: ['alchemy'],\n  Herbalist: ['alchemy'],\n  Merchant: ['trade'],\n  Guard: ['security'],\n  Soldier: ['security'],\n  Aristocrat: ['influence'],\n  Politician: ['influence'],\n  Patron: ['influence'],\n};\n\nfunction withUnique<T>(items: T[]): T[] {\n  return Array.from(new Set(items));\n}\n\nfunction talentsForJob(job: string): string[] {\n  return JOB_TALENTS[job] ?? [];\n}\n// ------------------------------------------------------------\n\n\n// Simple seeded random number generator for deterministic simulation\nclass Random {\n  private seed: number;\n\n  constructor(seed: number = Date.now()) {\n    this.seed = seed;\n  }\n\n  next(): number {\n    this.seed = (this.seed * 9301 + 49297) % 233280;\n    return this.seed / 233280;\n  }\n\n  nextInt(min: number, max: number): number {\n    return Math.floor(this.next() * (max - min + 1)) + min;\n  }\n\n  choice<T>(array: T[]): T {\n    if (array.length === 0) {\n      throw new Error('Cannot choose from empty array');\n    }\n    return array[Math.floor(this.next() * array.length)];\n  }\n}\n\nexport class GameEngine {\n  private state: GameState;\n  private listeners: Set<(state: GameState) => void> = new Set();\n  private lastActionTick: number = 0;\n  private random: Random;\n  // Phase 2: World indices for fast queries\n  private indices: WorldIndices;\n  // Phase 3: Track initial economy gold for invariant checks\n  private initialEconomyGold: number = 0;\n  private itemRegistry: ItemRegistry;\n  private timeSinceLastItemSynthesis = 0;\n  private lastMarketFluctuationDay = -1;\n  private stockpilesByPoi: StockpilesByPoi;\n\n  constructor() {\n    this.random = new Random();\n    this.itemRegistry = createSeedItemRegistry();\n    this.stockpilesByPoi = {};\n    this.state = this.createInitialState();\n    this.initializeStockpiles();\n    // Initialize indices after state creation\n    this.indices = new WorldIndices(this.state.worldMap.width);\n    this.rebuildIndices();\n    // Initialize economy and track initial gold\n    initializeEconomy(this.state, 5000, 10000, this.random);\n    this.initialEconomyGold = calculateTotalGold(this.state);\n    console.log(`[GameEngine] Economy initialized with ${this.initialEconomyGold} total gold`);\n  }\n\n  private createInitialState(): GameState {\n    const player: Player = {\n      name: 'Guild Master',\n      gold: 100,\n      level: 1,\n      experience: 0,\n    };\n\n    const quests: Quest[] = [\n      {\n        id: 'quest-1',\n        title: 'Welcome to the Guild',\n        description: 'Complete your first quest to begin your journey.',\n        reward: 50,\n        completed: false,\n      },\n      {\n        id: 'quest-2',\n        title: 'Gather Resources',\n        description: 'Collect resources to expand your guild.',\n        reward: 100,\n        completed: false,\n      },\n    ];\n\n    // Initialize world map (64x64) and generate city\n    const worldMap = new WorldMap(64, 64);\n    worldMap.generateCity();\n\n    // 1. Generate families first\n    const families = this.generateFamilies(20);\n\n    // 2. Initialize NPCs using the families\n    const npcs = this.generateInitialNPCs(100, worldMap, families);\n\n    const reportLog: ReportLogEntry[] = [\n      {\n        timestamp: 0,\n        message: 'Welcome to ProjectGM. The guild is ready to begin.',\n      },\n    ];\n\n    return {\n      player,\n      quests,\n      currentTime: 0,\n      day: 1,\n      timeOfDaySec: 0,\n      simRunning: false,\n      reportLog,\n      families, // Add generated families to state\n      npcs,\n      worldMap,\n      cityTreasury: 0, // Will be initialized by initializeEconomy\n      relations: new Map(),\n      guildTreasury: 0,\n    };\n  }\n\n  private initializeStockpiles(): void {\n    const catalog = this.itemRegistry.list();\n\n    const baseSeeds: Record<string, number> = {\n      wood: 30,\n      stone: 30,\n      ore: 18,\n      fuel: 16,\n      drink: 40,\n      food: 34,\n      organic: 14,\n      fiber: 20,\n      balancing: 8,\n      metal: 12,\n    };\n\n    const poiSeeds: Record<PoiId, Record<string, number>> = {\n      'guild-hall': { ...baseSeeds },\n      market: { ...baseSeeds, fiber: 26 },\n      mine: { ...baseSeeds, ore: 40, metal: 20, stone: 42, fuel: 24 },\n      forest: { ...baseSeeds, wood: 55, drink: 30, organic: 40, fiber: 35 },\n      tavern: { ...baseSeeds, food: 50, drink: 60, wood: 12, stone: 10, fiber: 18 },\n    };\n\n    for (const [poiId, seeds] of Object.entries(poiSeeds)) {\n      const stockpile: Stockpile = getPoiStockpile(this.stockpilesByPoi, poiId);\n      for (const item of catalog) {\n        if (!item.tags) continue;\n        for (const tag of item.tags) {\n          const qty = seeds[tag];\n          if (qty) {\n            stockAdd(stockpile, item.id, qty);\n          }\n        }\n      }\n    }\n\n    // TODO: expand to regional depots/biomes and NPC logistics when maps diversify.\n  }\n\n  // Generate families with distributed castes\n  private generateFamilies(count: number): Family[] {\n    const surnames = [\n      'Silva', 'Cavalcanti', 'Lins', 'Holanda', 'Barros',\n      'Melo', 'Albuquerque', 'Santos', 'Oliveira', 'Souza',\n      'Costa', 'Ferreira', 'Rodrigues', 'Nascimento', 'Lima'\n    ];\n\n    const families: Family[] = [];\n\n    for (let i = 0; i < count; i++) {\n      // Weight distribution: fewer nobles, more commoners\n      const rand = this.random.next();\n      let caste: Caste = 'commoner';\n\n      if (rand > 0.90) caste = 'noble'; // 10% Nobles\n      else if (rand > 0.75) caste = 'merchant'; // 15% Merchants\n      else if (rand > 0.60) caste = 'artisan'; // 15% Artisans\n      // 60% Commoners\n\n      families.push({\n        id: `fam-${i}`,\n        surname: this.random.choice(surnames),\n        caste,\n      });\n    }\n    return families;\n  }\n\n  // Generate stats based on caste\n  private generateStats(caste: Caste): Stats {\n    // Base roll 3-10\n    const roll = () => this.random.nextInt(3, 10);\n    const stats: Stats = {\n      strength: roll(),\n      vitality: roll(),\n      dexterity: roll(),\n      wisdom: roll(),\n      intelligence: roll(),\n      charisma: roll()\n    };\n\n    // Caste bonus\n    switch (caste) {\n      case 'noble':\n        stats.charisma += 3;\n        stats.intelligence += 2;\n        break;\n      case 'artisan':\n        stats.dexterity += 3;\n        stats.wisdom += 1;\n        break;\n      case 'commoner':\n        stats.strength += 2;\n        stats.vitality += 2;\n        break;\n      case 'merchant':\n        stats.charisma += 2;\n        stats.wisdom += 2;\n        break;\n    }\n    return stats;\n  }\n\n  private generateInitialNPCs(count: number, worldMap: WorldMap, families: Family[]): NPC[] {\n    const firstNames = [\n      'John', 'Mary', 'Peter', 'Anna', 'Charles', 'Beatrice',\n      'Luke', 'Julia', 'Raphael', 'Camille', 'Fernando', 'Isabella',\n      'Gabriel', 'Larissa', 'Matthew', 'Sophie', 'Bruno', 'Amanda',\n      'Diego', 'Leticia',\n    ];\n\n    const traits = [\n      'Brave', 'Cautious', 'Greedy', 'Generous', 'Skilled',\n      'Lucky', 'Hardworking', 'Lazy', 'Clever', 'Naive',\n    ];\n\n    const npcs: NPC[] = [];\n    \n    for (let i = 0; i < count; i++) {\n      const firstName = this.random.choice(firstNames);\n      \n      // a) Choose family\n      const family = this.random.choice(families);\n\n      // b) Generate stats and reputation\n      const stats = this.generateStats(family.caste);\n      const reputation = family.caste === 'noble' ? 50 : 0;\n\n      // c) Define job based on caste/stats\n      let job = 'Unemployed';\n\n      if (family.caste === 'noble') {\n        job = this.random.choice(['Aristocrat', 'Politician', 'Patron']);\n      } else if (family.caste === 'artisan' || stats.dexterity > 7) {\n        job = this.random.choice(['Blacksmith', 'Artisan', 'Tailor', 'Builder', 'Weaver']);\n      } else if (family.caste === 'merchant' || stats.charisma > 7) {\n        job = 'Merchant';\n      } else {\n        // Commoners or others\n        if (stats.strength > 7) job = this.random.choice(['Guard', 'Soldier', 'Lumberjack']);\n        else if (stats.wisdom > 7) job = this.random.choice(['Alchemist', 'Herbalist']);\n        else if (stats.dexterity > 7) job = this.random.choice(['Hunter', 'Lumberjack']);\n        else job = this.random.choice(['Farmer', 'Rancher', 'Fisher', 'Miner']);\n      }\n\n      // Define initial money based on caste\n      let initialMoney = 0;\n      switch(family.caste) {\n        case 'noble': initialMoney = this.random.nextInt(300, 800); break;\n        case 'merchant': initialMoney = this.random.nextInt(100, 400); break;\n        case 'artisan': initialMoney = this.random.nextInt(50, 150); break;\n        default: initialMoney = this.random.nextInt(5, 50); break;\n      }\n\n      const npcTraits: string[] = [];\n      const traitCount = this.random.nextInt(1, 3);\n      for (let j = 0; j < traitCount; j++) {\n        const trait = this.random.choice(traits);\n        if (!npcTraits.includes(trait)) {\n          npcTraits.push(trait);\n        }\n      }\n\n      // Place NPCs on walkable tiles only\n      let x = this.random.nextInt(0, worldMap.width - 1);\n      let y = this.random.nextInt(0, worldMap.height - 1);\n      \n      // Find a walkable position\n      let attempts = 0;\n      while (!worldMap.isWalkable(x, y) && attempts < 100) {\n        x = this.random.nextInt(0, worldMap.width - 1);\n        y = this.random.nextInt(0, worldMap.height - 1);\n        attempts++;\n      }\n\n      // Fallback to (0,0) which is guaranteed walkable by map generation\n      if (!worldMap.isWalkable(x, y)) {\n        x = 0;\n        y = 0;\n      }\n\n      npcs.push({\n        id: `npc-${i + 1}`,\n        name: `${firstName} ${family.surname}`, // Use family surname\n        familyId: family.id,\n        caste: family.caste,\n        reputation: reputation,\n        stats: stats,\n        talents: withUnique([\n        ...talentsForJob(job),\n        // A bit of natural variance: very strong NPCs might also learn harvesting/mining basics\n        ...(stats.strength > 8 ? ['harvest_wood'] : []),\n        ...(stats.wisdom > 8 ? ['alchemy'] : []),\n        ...(stats.dexterity > 8 ? ['craft'] : []),\n      ]),\n        pos: { x, y },\n        money: initialMoney,\n        job: job,\n        traits: npcTraits,\n        needs: {\n          hunger: this.random.nextInt(40, 60),\n          social: this.random.nextInt(40, 60),\n          fun: this.random.nextInt(40, 60),\n        },\n      });\n    }\n\n    return npcs;\n  }\n\n  /**\n   * Subscribe to state changes\n   */\n  subscribe(listener: (state: GameState) => void): () => void {\n    this.listeners.add(listener);\n    return () => this.listeners.delete(listener);\n  }\n\n  /**\n   * Notify all listeners of state change\n   */\n  private notify(): void {\n    this.listeners.forEach((listener) => listener(this.state));\n  }\n\n  /**\n   * Get current game state\n   */\n  getState(): GameState {\n    return { ...this.state };\n  }\n\n  /**\n   * Phase 2: Rebuild all indices from current world state\n   * Can be called after loading saved state or for debugging\n   */\n  private rebuildIndices(): void {\n    this.indices.clear();\n\n    // Rebuild spatial index\n    for (const npc of this.state.npcs) {\n      this.indices.addEntityToCell(npc.id, npc.pos);\n    }\n\n    // Rebuild inventory index\n    for (const npc of this.state.npcs) {\n      if (npc.inventory) {\n        for (const [itemId, quantity] of npc.inventory.entries()) {\n          if (quantity > 0) {\n            this.indices.addSeller(npc.id, itemId);\n          }\n        }\n      }\n    }\n\n    // Debug: Log index info in development\n    const debugInfo = this.indices.getDebugInfo();\n    console.log('[Phase 2] Indices rebuilt:', debugInfo);\n  }\n\n  /**\n   * Phase 2: Validate indices consistency (development only)\n   * Can be called manually for debugging\n   */\n  validateIndices(): void {\n    const result = validateIndices(\n      this.state.npcs,\n      this.indices,\n      this.state.worldMap\n    );\n    logValidationResults(result);\n  }\n\n  /**\n   * Phase 2: Get entities near a position (for witness/neighbor queries)\n   */\n  getEntitiesNearPosition(x: number, y: number, radius: number): NPC[] {\n    const entityIds = this.indices.getEntitiesInRadius({ x, y }, radius);\n    return this.state.npcs.filter((npc) => entityIds.has(npc.id));\n  }\n\n  /**\n   * Phase 2: Get NPCs selling a specific item\n   */\n  getSellersOfItem(itemId: string): NPC[] {\n    const sellerIds = this.indices.getSellersOfItem(itemId);\n    return this.state.npcs.filter((npc) => sellerIds.has(npc.id));\n  }\n\n  /**\n   * Start the simulation\n   */\n  start(): void {\n    if (!this.state.simRunning) {\n      this.state.simRunning = true;\n      this.addReportLog('Simulation started.');\n      this.notify();\n    }\n  }\n\n  /**\n   * Stop the simulation\n   */\n  stop(): void {\n    if (this.state.simRunning) {\n      this.state.simRunning = false;\n      this.addReportLog('Simulation paused.');\n      this.notify();\n    }\n  }\n\n  /**\n   * Toggle simulation on/off\n   */\n  toggle(): void {\n    if (this.state.simRunning) {\n      this.stop();\n    } else {\n      this.start();\n    }\n  }\n\n  /**\n   * Add entry to report log with capping\n   */\n  private addReportLog(message: string): void {\n    this.state.reportLog.push({\n      timestamp: this.state.currentTime,\n      message,\n    });\n\n    // Cap log at MAX_REPORT_LOG_LINES\n    if (this.state.reportLog.length > MAX_REPORT_LOG_LINES) {\n      this.state.reportLog = this.state.reportLog.slice(-MAX_REPORT_LOG_LINES);\n    }\n\n    // Notify listeners of the new log entry\n    this.notify();\n  }\n\n  /**\n   * Execute a batch of world actions (1-8 actions)\n   */\n  private executeWorldActions(): void {\n    const actionCount = this.random.nextInt(1, 8);\n\n    for (let i = 0; i < actionCount; i++) {\n      this.executeRandomAction();\n    }\n  }\n\n  /**\n   * Execute a single random world action\n   */\n  private executeRandomAction(): void {\n    const actionType = this.random.nextInt(0, 5);\n\n    switch (actionType) {\n      case 0: // NPC movement\n        this.actionNPCMovement();\n        break;\n      case 1: // NPC trade/buy\n        this.actionNPCTrade();\n        break;\n      case 2: // NPC work\n        this.actionNPCWork();\n        break;\n      case 3: // NPC eat (satisfy hunger)\n        this.actionNPCEat();\n        break;\n      case 4: // Random encounter (social) or guild event\n        if (this.random.next() < 0.5) {\n          this.actionRandomEncounter();\n        } else {\n          this.actionGuildEvent();\n        }\n        break;\n      case 5: // Market fluctuation\n        this.actionMarketFluctuation();\n        break;\n    }\n  }\n\n  /**\n   * Check if NPC is at a specific POI location (within footprint area)\n   */\n  private isNPCAtPOI(npc: NPC, poi: POI): boolean {\n    const width = poi.footprint?.x || 1;\n    const height = poi.footprint?.y || 1;\n    \n    return (\n      npc.pos.x >= poi.pos.x &&\n      npc.pos.x < poi.pos.x + width &&\n      npc.pos.y >= poi.pos.y &&\n      npc.pos.y < poi.pos.y + height\n    );\n  }\n\n  private getPOIForPosition(pos: { x: number; y: number }): POI | undefined {\n    return this.state.worldMap.getPOIs().find((poi) => {\n      const width = poi.footprint?.x || 1;\n      const height = poi.footprint?.y || 1;\n\n      return (\n        pos.x >= poi.pos.x &&\n        pos.x < poi.pos.x + width &&\n        pos.y >= poi.pos.y &&\n        pos.y < poi.pos.y + height\n      );\n    });\n  }\n\n  private resolveDefaultPoiId(): PoiId {\n    return (\n      this.state.worldMap.getPOI('market')?.id ||\n      this.state.worldMap.getPOI('guild-hall')?.id ||\n      this.state.worldMap.getPOIs()[0]?.id ||\n      'guild-hall'\n    );\n  }\n\n  private getNpcPoi(npc: NPC): POI | undefined {\n    return this.getPOIForPosition(npc.pos);\n  }\n\n  private getNpcStockpile(npc: NPC): { stockpile: Stockpile; poiId: PoiId } {\n    const poi = this.getNpcPoi(npc);\n    const poiId = poi?.id ?? this.resolveDefaultPoiId();\n    return { stockpile: getPoiStockpile(this.stockpilesByPoi, poiId), poiId };\n  }\n\n  /**\n   * Move NPC one step along its path, or set a new target if needed\n   */\n  private actionNPCMovement(): void {\n    if (this.state.npcs.length === 0) return;\n\n    const npc = this.random.choice(this.state.npcs);\n    \n    // If NPC has a current path, move along it\n    if (npc.currentPath && npc.currentPath.length > 0) {\n      const nextPos = npc.currentPath[0];\n      \n      // Verify the path is still valid\n      if (!isPathValid(npc.currentPath, this.state.worldMap)) {\n        // Path is blocked, recompute\n        npc.currentPath = undefined;\n        return;\n      }\n\n      // Phase 2: Update spatial index before moving\n      const oldPos = { x: npc.pos.x, y: npc.pos.y };\n      \n      // Move to next position\n      npc.pos = { x: nextPos.x, y: nextPos.y };\n      npc.currentPath.shift();\n\n      // Phase 2: Update spatial index after moving\n      this.indices.moveEntity(npc.id, oldPos, npc.pos);\n\n      // Check if NPC reached their target\n      if (npc.currentPath.length === 0 && npc.targetPos) {\n        const pois = this.state.worldMap.getPOIs();\n        const targetPOI = pois.find(poi => \n          poi.pos.x === npc.targetPos!.x && poi.pos.y === npc.targetPos!.y\n        );\n        \n        if (targetPOI) {\n          this.addReportLog(`${npc.name} arrived at ${targetPOI.name}.`);\n        }\n        \n        npc.targetPos = undefined;\n        npc.currentPath = undefined;\n      }\n    } else {\n      // NPC doesn't have a path - occasionally set a random destination\n      if (this.random.next() < 0.3) {\n        const pois = this.state.worldMap.getPOIs();\n        const targetPOI = this.random.choice(pois);\n        \n        // Only set target if not already there\n        if (!this.isNPCAtPOI(npc, targetPOI)) {\n          npc.targetPos = { x: targetPOI.pos.x, y: targetPOI.pos.y };\n          const path = findPath(npc.pos, npc.targetPos, this.state.worldMap);\n          \n          if (path.length > 0) {\n            npc.currentPath = path;\n          } else {\n            // No path found, clear target\n            npc.targetPos = undefined;\n          }\n        }\n      }\n    }\n  }\n\n  private actionNPCTrade(): void {\n    if (this.state.npcs.length < 2) return;\n\n    const marketPOI = this.state.worldMap.getPOI('market');\n    const tavernPOI = this.state.worldMap.getPOI('tavern');\n\n    // Prefer trades at Market/Tavern.\n    const tradePoi = marketPOI ?? tavernPOI;\n    if (!tradePoi) return;\n\n    const buyer = this.random.choice(this.state.npcs);\n\n    // If buyer isn't at a trade place, send them there sometimes.\n    const buyerAtTradePoi = this.isNPCAtPOI(buyer, tradePoi);\n    if (!buyerAtTradePoi) {\n      if (this.random.next() < 0.4 && !buyer.targetPos) {\n        buyer.targetPos = { x: tradePoi.pos.x, y: tradePoi.pos.y };\n        const path = findPath(buyer.pos, buyer.targetPos, this.state.worldMap);\n        buyer.currentPath = path.length > 0 ? path : undefined;\n        if (!buyer.currentPath) buyer.targetPos = undefined;\n      }\n      return;\n    }\n\n    // Pick what the buyer is looking for.\n    const hunger = buyer.needs?.hunger ?? 50;\n    const desiredTags = hunger < 55 ? ['food', 'drink'] : this.random.next() < 0.6 ? ['tool'] : ['material'];\n\n    // Find potential sellers at the same POI.\n    const sellers = this.state.npcs.filter((n) => n.id !== buyer.id && this.isNPCAtPOI(n, tradePoi));\n    if (sellers.length === 0) return;\n\n    // Try NPC-to-NPC sale first.\n    for (let attempt = 0; attempt < 6; attempt++) {\n      const seller = this.random.choice(sellers);\n      const sellerCatalog = this.itemRegistry\n        .list()\n        .filter((it) => it.tags?.some((t) => desiredTags.includes(t)) && inventoryHas(seller, it.id, 1));\n      if (sellerCatalog.length === 0) continue;\n\n      const item = this.random.choice(sellerCatalog);\n      const tagForPrice = item.tags?.find((t) => desiredTags.includes(t)) ?? desiredTags[0];\n      const poiId = tradePoi.id;\n      const base = tagForPrice === 'tool' ? 25 : tagForPrice === 'material' ? 15 : 10;\n      const price = Math.max(1, Math.round(base * this.getPriceMultiplier(poiId, tagForPrice)));\n      if (buyer.money < price) continue;\n\n      const paid = transferGold(this.state, buyer.id, seller.id, price, 'trade');\n      if (!paid) continue;\n\n      inventoryRemove(seller, item.id, 1, this.indices);\n      inventoryAdd(buyer, item.id, 1, this.indices);\n\n      this.addReportLog(`${buyer.name} bought ${item.name} from ${seller.name} for ${price} coins.`);\n      performSocialInteraction(this.state, buyer.id, seller.id, 'trade');\n      satisfyNeed(buyer, 'hunger', desiredTags.includes('food') || desiredTags.includes('drink') ? 8 : 2);\n      return;\n    }\n\n    // Fallback: buy from POI stockpile (\"market\") if available (city treasury as seller).\n    const poiId = tradePoi.id;\n    const stockpile = getPoiStockpile(this.stockpilesByPoi, poiId);\n    const candidates = desiredTags\n      .map((tag) => stockPickByTag(stockpile, this.itemRegistry, tag, this.random))\n      .filter((x): x is any => Boolean(x));\n    if (candidates.length === 0) return;\n\n    const item = this.random.choice(candidates);\n\n    const tagForPrice = item.tags?.find((t: string) => desiredTags.includes(t)) ?? desiredTags[0];\n    const base = tagForPrice === 'tool' ? 25 : tagForPrice === 'material' ? 15 : 10;\n    const price = Math.max(1, Math.round(base * this.getPriceMultiplier(poiId, tagForPrice)));\n    if (buyer.money < price) return;\n\n    const paid = transferGold(this.state, buyer.id, 'city', price, 'trade');\n    if (!paid) return;\n\n    stockRemove(stockpile, item.id, 1);\n    inventoryAdd(buyer, item.id, 1, this.indices);\n\n    this.addReportLog(`${buyer.name} purchased ${item.name} at ${tradePoi.name} for ${price} coins.`);\n    satisfyNeed(buyer, 'hunger', desiredTags.includes('food') || desiredTags.includes('drink') ? 6 : 1);\n  }\n\n  private getCraftProfileForJob(job: string):\n    | { intent: CraftIntent; process: CraftProcess; requiredTags: string[][]; optionalTags?: string[][]; requiredTalent?: string }\n    | null {\n    switch (job) {\n      case 'Blacksmith':\n        return {\n          requiredTalent: 'forge',\n          intent: this.random.next() > 0.6 ? 'weapon' : 'tool',\n          process: 'forge',\n          requiredTags: [['metal', 'ore'], ['fuel'], ['wood', 'organic', 'fiber']],\n          optionalTags: [['metal', 'ore'], ['wood', 'organic']],\n        };\n      case 'Artisan':\n        return {\n          requiredTalent: 'craft',\n          intent: this.random.next() > 0.55 ? 'tool' : 'material',\n          process: 'refine',\n          requiredTags: [['wood', 'fiber', 'organic'], ['wood', 'fiber', 'organic'], ['stone', 'wood']],\n          optionalTags: [['fuel'], ['organic', 'fiber']],\n        };\n      case 'Tailor':\n        return {\n          requiredTalent: 'tailor',\n          intent: 'material',\n          process: 'cook',\n          requiredTags: [['fiber'], ['fiber', 'organic']],\n          optionalTags: [['organic', 'material'], ['fiber']],\n        };\n      case 'Builder':\n        return {\n          requiredTalent: 'build',\n          intent: this.random.next() > 0.4 ? 'material' : 'tool',\n          process: 'refine',\n          requiredTags: [['stone'], ['wood', 'organic'], ['wood', 'fiber', 'organic']],\n          optionalTags: [['fuel'], ['stone', 'wood']],\n        };\n      case 'Weaver':\n        return {\n          requiredTalent: 'weave',\n          intent: 'material',\n          process: 'cook',\n          requiredTags: [['fiber'], ['fiber', 'organic']],\n          optionalTags: [['organic', 'fiber']],\n        };\n      case 'Lumberjack':\n        return {\n          requiredTalent: 'harvest_wood',\n          intent: 'material',\n          process: 'refine',\n          requiredTags: [['wood'], ['wood', 'organic']],\n          optionalTags: [['fuel', 'wood'], ['organic']],\n        };\n      case 'Farmer':\n        return {\n          requiredTalent: 'grow_food',\n          intent: 'food',\n          process: 'cook',\n          requiredTags: [['food', 'organic'], ['drink']],\n          optionalTags: [['food', 'organic'], ['drink', 'organic']],\n        };\n      case 'Rancher':\n        return {\n          requiredTalent: 'raise_animals',\n          intent: this.random.next() > 0.5 ? 'food' : 'drink',\n          process: this.random.next() > 0.4 ? 'cook' : 'brew',\n          requiredTags: [['food', 'organic'], ['drink'], ['fiber', 'organic']],\n          optionalTags: [['organic'], ['fiber', 'organic']],\n        };\n      case 'Alchemist':\n      case 'Herbalist':\n        return {\n          requiredTalent: 'alchemy',\n          intent: this.random.next() > 0.5 ? 'medicine' : 'drink',\n          process: 'brew',\n          requiredTags: [['organic'], ['balancing', 'drink', 'medicine', 'organic']],\n          optionalTags: [['drink', 'medicine', 'organic'], ['balancing', 'organic']],\n        };\n      case 'Miner':\n        return {\n          requiredTalent: 'mine_ore',\n          intent: 'material',\n          process: 'refine',\n          requiredTags: [['ore', 'stone'], ['stone']],\n          optionalTags: [['fuel']],\n        };\n      case 'Hunter':\n        return {\n          requiredTalent: 'hunt',\n          intent: this.random.next() > 0.4 ? 'food' : 'material',\n          process: 'cook',\n          requiredTags: [['organic'], ['food', 'organic']],\n          optionalTags: [['fiber'], ['drink', 'organic']],\n        };\n      case 'Fisher':\n        return {\n          requiredTalent: 'fish',\n          intent: 'food',\n          process: 'cook',\n          requiredTags: [['food', 'drink', 'organic'], ['food', 'organic']],\n          optionalTags: [['drink', 'organic']],\n        };\n      default:\n        return null;\n    }\n  }\n\n  private countSelection(selections: { definition: ItemDefinition; source: 'inventory' | 'stockpile' }[], itemId: ItemId, source: 'inventory' | 'stockpile'): number {\n    return selections.filter((s) => s.definition.id === itemId && s.source === source).length;\n  }\n\n  private pickIngredient(\n    npc: NPC,\n    tagOptions: string[],\n    selections: { definition: ItemDefinition; source: 'inventory' | 'stockpile' }[],\n    stockpile: Stockpile,\n    allowReuse = false,\n  ): { definition: ItemDefinition; source: 'inventory' | 'stockpile' } | null {\n    const catalog = this.itemRegistry.list();\n    const usedIds = allowReuse ? [] : selections.map((s) => s.definition.id);\n    const matches = catalog.filter(\n      (item) => item.tags?.some((tag) => tagOptions.includes(tag)) && !usedIds.includes(item.id),\n    );\n\n    const avoidOre = tagOptions.includes('stone') && !tagOptions.includes('ore');\n    const prioritized = avoidOre ? matches.filter((item) => !item.tags?.includes('ore')) : matches;\n    const pool = prioritized.length > 0 ? prioritized : matches;\n\n    const invPool = pool.filter((item) =>\n      inventoryHas(npc, item.id, 1 + this.countSelection(selections, item.id, 'inventory')),\n    );\n    if (invPool.length > 0) {\n      return { definition: this.random.choice(invPool), source: 'inventory' };\n    }\n\n    const stockPool = pool.filter((item) =>\n      stockHas(stockpile, item.id, 1 + this.countSelection(selections, item.id, 'stockpile')),\n    );\n    if (stockPool.length > 0) {\n      return { definition: this.random.choice(stockPool), source: 'stockpile' };\n    }\n\n    return null;\n  }\n\n  private acquireInputs(\n    npc: NPC,\n    requiredTags: string[][],\n    optionalTags: string[][] = [],\n    stockpile?: Stockpile,\n  ): { definition: ItemDefinition; source: 'inventory' | 'stockpile' }[] | null {\n    const selections: { definition: ItemDefinition; source: 'inventory' | 'stockpile' }[] = [];\n    const targetStockpile = stockpile ?? this.getNpcStockpile(npc).stockpile;\n\n    for (const tagOptions of requiredTags) {\n      const choice = this.pickIngredient(npc, tagOptions, selections, targetStockpile);\n      if (!choice) {\n        return null;\n      }\n      selections.push(choice);\n    }\n\n    for (const tagOptions of optionalTags) {\n      if (selections.length >= 3) break;\n      const choice = this.pickIngredient(npc, tagOptions, selections, targetStockpile);\n      if (choice) selections.push(choice);\n    }\n\n    if (selections.length < 2) {\n      for (const tagOptions of requiredTags) {\n        const duplicate = this.pickIngredient(npc, tagOptions, selections, targetStockpile, true);\n        if (duplicate) {\n          selections.push(duplicate);\n          break;\n        }\n      }\n    }\n\n    return selections.length >= 2 ? selections : null;\n  }\n\n  private performGatheringJob(\n    npc: NPC,\n    stockpile: Stockpile,\n    poiId: PoiId,\n  ): boolean {\n    const jobConfig: Partial<Record<NPC['job'], { sourcePoi: PoiId; tags: string[][]; activity: string }>> = {\n      Miner: { sourcePoi: 'mine', tags: [['ore', 'metal', 'stone', 'fuel']], activity: 'hauled resources from' },\n      Lumberjack: { sourcePoi: 'forest', tags: [['wood']], activity: 'felled timber in' },\n      Farmer: { sourcePoi: 'market', tags: [['food', 'organic'], ['drink']], activity: 'collected produce at' },\n      Rancher: { sourcePoi: 'market', tags: [['fiber', 'food', 'organic']], activity: 'brought ranch goods from' },\n      Fisher: { sourcePoi: 'tavern', tags: [['food', 'drink', 'organic']], activity: 'hauled a catch from' },\n      Hunter: { sourcePoi: 'forest', tags: [['organic', 'food', 'fiber']], activity: 'returned with game from' },\n    };\n\n    const config = npc.job ? jobConfig[npc.job] : undefined;\n    if (!config) return false;\n\n    const sourceStockpile = getPoiStockpile(this.stockpilesByPoi, config.sourcePoi);\n    const sourcePoiName = this.state.worldMap.getPOI(config.sourcePoi)?.name ?? config.sourcePoi;\n    const tagPool = withUnique(config.tags.flat());\n    let picked: ItemDefinition | null = null;\n\n    const attemptedTags = new Set<string>();\n    while (attemptedTags.size < tagPool.length && !picked) {\n      const tag = this.random.choice(tagPool.filter((t) => !attemptedTags.has(t)));\n      attemptedTags.add(tag);\n      picked = stockPickByTag(sourceStockpile, this.itemRegistry, tag, this.random);\n    }\n\n    if (!picked) {\n      return false;\n    }\n\n    stockRemove(sourceStockpile, picked.id, 1);\n    stockAdd(stockpile, picked.id, 1);\n    const described = picked.displayName ?? picked.name ?? picked.id;\n    this.addReportLog(`${npc.name} ${config.activity} ${sourcePoiName} and stocked ${described} at ${poiId}.`);\n\n    modifyNeed(npc, 'hunger', -5);\n    modifyNeed(npc, 'fun', -2);\n    return true;\n  }\n\n  private collectFromStockpile(npc: NPC, tags: string[][], stockpile: Stockpile, poiId: PoiId): void {\n    const flattened = tags.flat();\n    const tag = this.random.choice(flattened);\n    const picked = stockPickByTag(stockpile, this.itemRegistry, tag, this.random);\n    if (!picked) return;\n\n    stockRemove(stockpile, picked.id, 1);\n    inventoryAdd(npc, picked.id, 1, this.indices);\n    this.addReportLog(\n      `${npc.name} collected ${picked.displayName ?? picked.name} from the local stockpile (${poiId}).`,\n    );\n  }\n\n  private matchItemBySignature(\n    npc: NPC,\n    signature: string,\n    selections: { definition: ItemDefinition; source: 'inventory' | 'stockpile' }[],\n    stockpile: Stockpile,\n  ): { definition: ItemDefinition; source: 'inventory' | 'stockpile' } | null {\n    const candidates = this.itemRegistry\n      .list()\n      .filter((item) => item.signature === signature || mixSignature(item.mix) === signature);\n\n    const inv = candidates.filter((item) =>\n      inventoryHas(npc, item.id, 1 + this.countSelection(selections, item.id, 'inventory')),\n    );\n    if (inv.length > 0) {\n      return { definition: this.random.choice(inv), source: 'inventory' };\n    }\n\n    const stock = candidates.filter((item) =>\n      stockHas(stockpile, item.id, 1 + this.countSelection(selections, item.id, 'stockpile')),\n    );\n    if (stock.length > 0) {\n      return { definition: this.random.choice(stock), source: 'stockpile' };\n    }\n\n    return null;\n  }\n\n  private pickLearnedRecipe(\n    npc: NPC,\n    intent: CraftIntent,\n    process: CraftProcess,\n    stockpile: Stockpile,\n  ): { inputs: { definition: ItemDefinition; source: 'inventory' | 'stockpile' }[]; weights?: number[] } | null {\n    const recipes = (npc.learnedRecipes ?? [])\n      .filter((r) => r.intent === intent && r.process === process)\n      .sort((a, b) => b.score - a.score);\n\n    for (const recipe of recipes) {\n      const selections: { definition: ItemDefinition; source: 'inventory' | 'stockpile' }[] = [];\n      let valid = true;\n      for (const signature of recipe.inputSignatures) {\n        const choice = this.matchItemBySignature(npc, signature, selections, stockpile);\n        if (!choice) {\n          valid = false;\n          break;\n        }\n        selections.push(choice);\n      }\n\n      if (valid && selections.length >= 2) {\n        return { inputs: selections, weights: recipe.weights };\n      }\n    }\n\n    return null;\n  }\n\n  private rememberRecipe(\n    npc: NPC,\n    intent: CraftIntent,\n    process: CraftProcess,\n    inputs: ItemDefinition[],\n    weights: number[] | undefined,\n    score: number,\n  ): void {\n    const inputSignatures = inputs.map((input) => input.signature ?? mixSignature(input.mix));\n    npc.learnedRecipes ??= [];\n    // TODO: allow recipe exchange between NPCs and job specializations to bias selections.\n\n    const existing = npc.learnedRecipes.find(\n      (r) =>\n        r.intent === intent &&\n        r.process === process &&\n        r.inputSignatures.length === inputSignatures.length &&\n        r.inputSignatures.every((sig, idx) => sig === inputSignatures[idx]),\n    );\n\n    if (existing) {\n      if (score > existing.score) {\n        existing.score = score;\n        existing.weights = weights ?? existing.weights;\n      }\n      return;\n    }\n\n    npc.learnedRecipes.push({ intent, process, inputSignatures, weights, score });\n  }\n\n  private chooseWeights(count: number, requiredCount: number): number[] {\n    const weights: number[] = [];\n    for (let i = 0; i < count; i++) {\n      const emphasis = i < requiredCount ? 0.5 + 0.4 * this.random.next() : 0.1 + 0.4 * this.random.next();\n      weights.push(Number(emphasis.toFixed(3)));\n    }\n    return weights;\n  }\n\n  private scoreResult(intent: CraftIntent, npcBodyMix: Mix, craftedItem: ItemDefinition): number {\n    if (intent === 'food' || intent === 'drink' || intent === 'medicine') {\n      const sim = simulateIngestion(npcBodyMix, craftedItem.mix, flattenReactions(REACTIONS_LIBRARY), 20, 1);\n      const energyGain = sim.after.energy - sim.before.energy;\n      const hungerRelief = sim.before.hungerSignal - sim.after.hungerSignal;\n      const thirstRelief = sim.before.thirstSignal - sim.after.thirstSignal;\n      const essentialPenalty =\n        Math.max(0, -sim.essentialDelta.ATP) +\n        Math.max(0, -sim.essentialDelta.H2O) +\n        Math.max(0, Math.abs(sim.essentialDelta.PH) - 0.05) +\n        Math.max(0, sim.essentialDelta.O2 < -0.05 ? -sim.essentialDelta.O2 : 0);\n      return energyGain * 2 + hungerRelief + thirstRelief - essentialPenalty;\n    }\n\n    const traits = craftedItem.traits ?? {};\n    const slagPenalty = (craftedItem.mix.SLAG ?? 0) + (craftedItem.mix.MINERAL_DUST ?? 0);\n    const stability = 1 - (traits.reactivity ?? 0);\n    const metalness = traits.metalness ?? 0;\n    const mineralness = traits.mineralness ?? 0;\n\n    if (intent === 'weapon' || intent === 'tool') {\n      return 1.2 * metalness + 0.8 * stability - 0.5 * slagPenalty;\n    }\n\n    return mineralness + 0.5 * stability - 0.4 * slagPenalty;\n  }\n\n  private actionNPCWork(): void {\n    if (this.state.npcs.length === 0) return;\n\n    const npc = this.random.choice(this.state.npcs);\n    let profile = this.getCraftProfileForJob(npc.job);\n\n    // Talent gate: if an NPC lacks the core talent for a job, they simply can't do that work.\n    if (profile?.requiredTalent && !npc.talents?.includes(profile.requiredTalent)) {\n      return;\n    }\n\n    if (!profile) return;\n\n    // Determine work location based on job\n    let requiredPOI: POI | undefined;\n    if (npc.job === 'Miner') {\n      requiredPOI = this.state.worldMap.getPOI('mine');\n    } else if (\n      npc.job === 'Hunter' ||\n      npc.job === 'Fisher' ||\n      npc.job === 'Farmer' ||\n      npc.job === 'Rancher' ||\n      npc.job === 'Lumberjack'\n    ) {\n      requiredPOI = this.state.worldMap.getPOI('forest');\n    } else if (npc.job === 'Merchant') {\n      requiredPOI = this.state.worldMap.getPOI('market');\n    }\n\n    const currentPoi = this.getNpcPoi(npc) ?? this.state.worldMap.getPOI('market');\n    const poiId = (requiredPOI ?? currentPoi)?.id ?? this.resolveDefaultPoiId();\n    const stockpile = getPoiStockpile(this.stockpilesByPoi, poiId);\n\n    const foodScarcity = this.computeLocalScarcity(poiId, 'food');\n    const drinkScarcity = this.computeLocalScarcity(poiId, 'drink');\n    const toolScarcity = this.computeLocalScarcity(poiId, 'tool');\n    const materialScarcity = this.computeLocalScarcity(poiId, 'material');\n\n    if (profile.intent === 'weapon' && toolScarcity > 0.6) {\n      profile = { ...profile, intent: 'tool' };\n    } else if (profile.intent === 'tool' || profile.intent === 'material') {\n      if (toolScarcity > materialScarcity + 0.2) {\n        profile = { ...profile, intent: 'tool', process: profile.process };\n      } else if (materialScarcity > toolScarcity + 0.2) {\n        profile = { ...profile, intent: 'material', process: profile.process };\n      }\n    } else if (profile.intent === 'food' && drinkScarcity > 0.65 && drinkScarcity > foodScarcity) {\n      profile = { ...profile, intent: 'drink', process: 'brew', requiredTags: [['drink']] };\n    }\n\n    // Check if NPC is at required location (if any)\n    if (requiredPOI && !this.isNPCAtPOI(npc, requiredPOI)) {\n      // NPC needs to move to work location first\n      if (!npc.targetPos) {\n        npc.targetPos = { x: requiredPOI.pos.x, y: requiredPOI.pos.y };\n        const path = findPath(npc.pos, npc.targetPos, this.state.worldMap);\n        if (path.length > 0) {\n          npc.currentPath = path;\n        } else {\n          npc.targetPos = undefined;\n        }\n      }\n      return;\n    }\n\n    const learned = this.pickLearnedRecipe(npc, profile.intent, profile.process, stockpile);\n    let selections = learned?.inputs ?? null;\n    let weights = learned?.weights;\n\n    if (!selections) {\n      selections = this.acquireInputs(npc, profile.requiredTags, profile.optionalTags ?? [], stockpile);\n      if (selections) {\n        weights = this.chooseWeights(selections.length, profile.requiredTags.length);\n      }\n    }\n\n    if (!selections) {\n      if (this.performGatheringJob(npc, stockpile, poiId)) {\n        return;\n      }\n      this.collectFromStockpile(npc, profile.requiredTags, stockpile, poiId);\n      return;\n    }\n\n    const inputs = selections.map((s) => s.definition);\n    if (inputs.length < 2) {\n      if (this.performGatheringJob(npc, stockpile, poiId)) {\n        return;\n      }\n      this.collectFromStockpile(npc, profile.requiredTags, stockpile, poiId);\n      return;\n    }\n\n    for (const selection of selections) {\n      if (selection.source === 'inventory') {\n        inventoryRemove(npc, selection.definition.id, 1, this.indices);\n      } else {\n        stockRemove(stockpile, selection.definition.id, 1);\n      }\n    }\n\n    const craftedId = craftOnce(\n      this.random,\n      this.itemRegistry,\n      flattenReactions(REACTIONS_LIBRARY),\n      inputs,\n      profile.process,\n      profile.process === 'forge'\n        ? 'Forge product'\n        : profile.process === 'refine'\n          ? 'Refined material'\n          : `${profile.intent} ${profile.process}`,\n      weights,\n    );\n\n    stockAdd(stockpile, craftedId, 1);\n    const giveToNpc = this.random.next() > 0.7;\n    if (giveToNpc) {\n      stockRemove(stockpile, craftedId, 1);\n      inventoryAdd(npc, craftedId, 1, this.indices);\n    }\n    const craftedDef = this.itemRegistry.getItem(craftedId);\n\n    if (craftedDef) {\n      const score = this.scoreResult(profile.intent, npc.chemistry?.body ?? {}, craftedDef);\n      if (score > 0.2) {\n        this.rememberRecipe(npc, profile.intent, profile.process, inputs, weights, score);\n      }\n\n      this.addReportLog(\n        `${npc.name} worked as a ${npc.job} and produced ${craftedDef.displayName ?? craftedDef.name}, storing it at ${poiId}.`,\n      );\n    }\n\n    // Work makes you hungry\n    modifyNeed(npc, 'hunger', -5);\n\n    // Decay fun need (work is not fun)\n    modifyNeed(npc, 'fun', -2);\n  }\n\n  /**\n   * NPC eats food to satisfy hunger\n   */\n  private actionNPCEat(): void {\n    if (this.state.npcs.length === 0) return;\n\n    const npc = this.random.choice(this.state.npcs);\n\n    const consumableCatalog = this.itemRegistry.list().filter((item) => this.isEdible(item));\n    let consumed = false;\n    const { stockpile, poiId } = this.getNpcStockpile(npc);\n    const ownedConsumable = consumableCatalog.find((item) => inventoryHas(npc, item.id, 1));\n\n    if (ownedConsumable) {\n      const isDrink = ownedConsumable.tags?.includes('drink');\n      const verb = isDrink ? 'drank' : 'ate';\n      inventoryRemove(npc, ownedConsumable.id, 1, this.indices);\n      satisfyNeed(npc, 'hunger', 30);\n      this.addReportLog(`${npc.name} ${verb} ${this.describeItem(ownedConsumable.id)}.`);\n      consumed = true;\n    } else {\n      const availableInStock = consumableCatalog.filter((item) => stockHas(stockpile, item.id, 1));\n\n      if (availableInStock.length > 0) {\n        const picked = this.random.choice(availableInStock);\n        const isDrink = picked.tags?.includes('drink');\n        const verb = isDrink ? 'drank' : 'ate';\n        stockRemove(stockpile, picked.id, 1);\n        satisfyNeed(npc, 'hunger', 25);\n        this.addReportLog(`${npc.name} ${verb} ${this.describeItem(picked.id)} at ${poiId}.`);\n        consumed = true;\n      } else {\n        const marketPOI = this.state.worldMap.getPOI('market');\n\n        // If at market, buy food from city or another NPC\n        if (marketPOI && this.isNPCAtPOI(npc, marketPOI)) {\n          const scarcityTag = this.random.next() > 0.5 ? 'food' : 'drink';\n          const priceMultiplier = this.getPriceMultiplier(poiId, scarcityTag);\n          const foodCost = Math.round(this.random.nextInt(5, 15) * priceMultiplier);\n\n          // Try to buy from city treasury (representing shops)\n          const success = transferGold(this.state, npc.id, 'city', foodCost, 'buy food');\n\n          if (success) {\n            const purchasedFood = this.ensureProceduralItemId('food', (item) =>\n              consumableCatalog.includes(item),\n            );\n            inventoryAdd(npc, purchasedFood, 1, this.indices);\n            this.addReportLog(\n              `${npc.name} bought ${this.describeItem(purchasedFood)} for ${foodCost} coins.`,\n            );\n\n            // Consume it immediately\n            inventoryRemove(npc, purchasedFood, 1, this.indices);\n            satisfyNeed(npc, 'hunger', 25);\n            consumed = true;\n          }\n        } else if (marketPOI && !npc.targetPos) {\n          // Move to market to buy food\n          npc.targetPos = { x: marketPOI.pos.x, y: marketPOI.pos.y };\n          const path = findPath(npc.pos, npc.targetPos, this.state.worldMap);\n          if (path.length > 0) {\n            npc.currentPath = path;\n          } else {\n            npc.targetPos = undefined;\n          }\n        }\n      }\n    }\n    if (!consumed) {\n      this.addReportLog(`${npc.name} could not find food or drink.`);\n    }\n  }\n\n  private actionGuildEvent(): void {\n    const events = [\n      'A new adventurer arrived at the guild.',\n      'The guild received an anonymous donation.',\n      'A rumor of distant treasures spreads through the tavern.',\n      'The guild council met to discuss new contracts.',\n      'Local merchants report increased sales.',\n    ];\n    const event = this.random.choice(events);\n    this.addReportLog(event);\n  }\n\n  private actionRandomEncounter(): void {\n    if (this.state.npcs.length === 0) return;\n\n    const npc = this.random.choice(this.state.npcs);\n    \n    // Check if NPC is at Tavern for social encounters\n    const tavernPOI = this.state.worldMap.getPOI('tavern');\n    if (tavernPOI && this.isNPCAtPOI(npc, tavernPOI)) {\n      // Social encounter at tavern - find another NPC nearby\n      const nearbyNPCs = this.getEntitiesNearPosition(npc.pos.x, npc.pos.y, 3);\n      const otherNPCs = nearbyNPCs.filter((n) => n.id !== npc.id);\n      \n      if (otherNPCs.length > 0) {\n        const otherNPC = this.random.choice(otherNPCs);\n        performSocialInteraction(this.state, npc.id, otherNPC.id, 'chat');\n\n        this.addReportLog(\n          `${npc.name} chatted with ${otherNPC.name} at the tavern.`\n        );\n        \n        // Satisfy social and fun needs\n        satisfyNeed(npc, 'social', 10);\n        satisfyNeed(npc, 'fun', 8);\n        satisfyNeed(otherNPC, 'social', 10);\n        satisfyNeed(otherNPC, 'fun', 8);\n      } else {\n        const encounters = [\n          `${npc.name} joined a party at the tavern.`,\n          `${npc.name} heard tales of distant lands.`,\n        ];\n        const encounter = this.random.choice(encounters);\n        this.addReportLog(encounter);\n        \n        // Satisfy needs even if alone\n        satisfyNeed(npc, 'social', 5);\n        satisfyNeed(npc, 'fun', 10);\n      }\n    } else {\n      const encounters = [\n        `${npc.name} found an old coin along the road.`,\n        `${npc.name} helped a lost traveler.`,\n        `${npc.name} witnessed a duel in the plaza.`,\n      ];\n      const encounter = this.random.choice(encounters);\n      this.addReportLog(encounter);\n      \n      // Small fun increase\n      satisfyNeed(npc, 'fun', 3);\n    }\n  }\n\n  private computeTagQuantity(poiId: PoiId, tag: string): number {\n    const stockpile = getPoiStockpile(this.stockpilesByPoi, poiId);\n    let total = 0;\n\n    for (const [itemId, qty] of Object.entries(stockpile)) {\n      const def = this.itemRegistry.getItem(itemId);\n      if (def?.tags?.includes(tag)) {\n        total += qty;\n      }\n    }\n\n    return total;\n  }\n\n  private computeLocalScarcity(poiId: PoiId, tag: string): number {\n    const qty = this.computeTagQuantity(poiId, tag);\n    const targetStock = 50;\n    const scarcity = 1 - qty / targetStock;\n    return Math.max(0, Math.min(1, scarcity));\n  }\n\n  private getPriceMultiplier(poiId: PoiId, tag: string): number {\n    const scarcity = this.computeLocalScarcity(poiId, tag);\n    return 1 + 1.5 * scarcity;\n  }\n\n  private actionMarketFluctuation(): void {\n    // Market fluctuations are meant to be a slow signal. Avoid spamming the log every action tick.\n    if (this.lastMarketFluctuationDay === this.state.day) return;\n    this.lastMarketFluctuationDay = this.state.day;\n    const anchorPoi = this.state.worldMap.getPOI('market')?.id ?? this.resolveDefaultPoiId();\n    const foodScarcity = this.computeLocalScarcity(anchorPoi, 'food');\n    const drinkScarcity = this.computeLocalScarcity(anchorPoi, 'drink');\n    const toolScarcity = this.computeLocalScarcity(anchorPoi, 'tool');\n    const materialScarcity = this.computeLocalScarcity(anchorPoi, 'material');\n\n    if (foodScarcity > 0.7) {\n      this.addReportLog('Food scarcity rumors impact the local market.');\n    } else if (foodScarcity < 0.2) {\n      this.addReportLog('An abundance of food pushed prices down this week.');\n    } else if (drinkScarcity > 0.7) {\n      this.addReportLog('Water and drinks are scarce and prices have risen.');\n    } else if (toolScarcity > 0.7) {\n      this.addReportLog('Tool demand increased while local stocks remain low.');\n    } else if (materialScarcity < 0.2) {\n      this.addReportLog('Refined materials are oversupplied; prices are falling.');\n    } else {\n      const changes = [\n        'Food prices ticked up slightly.',\n        'The weapons market is hot this week.',\n        'Potions are cheaper due to oversupply.',\n        'Demand for tools increased.',\n        'Scarcity rumors ripple through the market.',\n      ];\n      const change = this.random.choice(changes);\n      this.addReportLog(change);\n    }\n\n    // Simulate traders shifting stock between POIs when there is clear imbalance.\n    this.actionTraderFlow();\n  }\n\n  private actionTraderFlow(): void {\n    // TODO: replace instant transfers with caravans/pathfinding and per-storehouse routing.\n    const pois = this.state.worldMap.getPOIs();\n    if (pois.length < 2) return;\n\n    const tags = ['food', 'drink', 'tool', 'material'];\n    let chosen: { tag: string; from: POI; to: POI; scarcityDelta: number } | null = null;\n\n    for (const tag of tags) {\n      let richest: { poi: POI; scarcity: number } | null = null;\n      let poorest: { poi: POI; scarcity: number } | null = null;\n\n      for (const poi of pois) {\n        const scarcity = this.computeLocalScarcity(poi.id, tag);\n        if (!richest || scarcity < richest.scarcity) {\n          richest = { poi, scarcity };\n        }\n        if (!poorest || scarcity > poorest.scarcity) {\n          poorest = { poi, scarcity };\n        }\n      }\n\n      if (richest && poorest) {\n        const delta = poorest.scarcity - richest.scarcity;\n        if (delta > 0.3 && this.computeTagQuantity(richest.poi.id, tag) > 0) {\n          if (!chosen || delta > chosen.scarcityDelta) {\n            chosen = { tag, from: richest.poi, to: poorest.poi, scarcityDelta: delta };\n          }\n        }\n      }\n    }\n\n    if (!chosen) return;\n\n    const sourceStock = getPoiStockpile(this.stockpilesByPoi, chosen.from.id);\n    const destStock = getPoiStockpile(this.stockpilesByPoi, chosen.to.id);\n    const picked = stockPickByTag(sourceStock, this.itemRegistry, chosen.tag, this.random);\n    if (!picked) return;\n\n    const transferQty = Math.max(1, Math.min(3, Math.floor((this.computeTagQuantity(chosen.from.id, chosen.tag) || 1) / 4)));\n    const removed = stockRemove(sourceStock, picked.id, transferQty);\n    if (!removed) return;\n\n    stockAdd(destStock, picked.id, transferQty);\n    this.addReportLog(\n      `A trader carried ${transferQty}x ${picked.displayName ?? picked.name} from ${chosen.from.name} to ${chosen.to.name}.`,\n    );\n  }\n\n  /**\n   * Complete a quest\n   */\n  completeQuest(questId: string): boolean {\n    const quest = this.state.quests.find((q) => q.id === questId);\n    if (!quest || quest.completed) {\n      return false;\n    }\n\n    quest.completed = true;\n    \n    // Phase 3: Use transferGold for quest rewards (from guild to player)\n    // If guild doesn't have enough, use city treasury as fallback\n    let success = false;\n    if (this.state.guildTreasury !== undefined && this.state.guildTreasury >= quest.reward) {\n      success = transferGold(this.state, 'guild', 'player', quest.reward, 'quest reward');\n    } else {\n      success = transferGold(this.state, 'city', 'player', quest.reward, 'quest reward');\n    }\n    \n    if (!success) {\n      // Fallback: if transfer failed, just add the gold (emergency case)\n      this.state.player.gold += quest.reward;\n      console.warn('[Economy] Quest reward transfer failed, adding gold directly');\n    }\n    \n    this.state.player.experience += quest.reward;\n\n    // Level up logic\n    const expNeeded = this.state.player.level * 100;\n    if (this.state.player.experience >= expNeeded) {\n      this.state.player.level++;\n      this.state.player.experience -= expNeeded;\n    }\n\n    this.addReportLog(\n      `Quest \"${quest.title}\" completed! Reward: ${quest.reward} coins.`\n    );\n    this.notify();\n    return true;\n  }\n\n  /**\n   * Update game time and run simulation\n   */\n  update(deltaTime: number): void {\n    this.state.currentTime += deltaTime;\n\n    // Only advance simulation time if running\n    if (this.state.simRunning) {\n      const oldTimeOfDay = Math.floor(this.state.timeOfDaySec);\n\n      // Advance time of day\n      const deltaSeconds = deltaTime / 1000;\n      this.state.timeOfDaySec += deltaSeconds;\n\n      // Check if a day has passed\n      while (this.state.timeOfDaySec >= SECONDS_PER_DAY) {\n        this.state.timeOfDaySec -= SECONDS_PER_DAY;\n        this.state.day++;\n        this.addReportLog(`--- Day ${this.state.day} ---`);\n      }\n\n      // Notify on time changes (every second) to update the clock display\n      const newTimeOfDay = Math.floor(this.state.timeOfDaySec);\n      if (newTimeOfDay !== oldTimeOfDay) {\n        this.notify();\n      }\n\n      // Execute action tick every 2 seconds\n      if (this.state.currentTime - this.lastActionTick >= ACTION_TICK_INTERVAL) {\n        this.lastActionTick = this.state.currentTime;\n\n        // Chemistry tick informs needs instead of arbitrary decay\n        this.applyChemistryTick(ACTION_TICK_INTERVAL / 1000);\n\n        // World crafting tick: hook procedural item system into main loop\n        this.maybeSynthesizeProceduralItem(ACTION_TICK_INTERVAL);\n\n        this.executeWorldActions();\n        \n        // Phase 3: Validate economy invariants in development mode\n        const validation = validateEconomyInvariants(this.state, this.initialEconomyGold);\n        if (!validation.valid) {\n          console.error('[Economy] Invariant violation detected!', validation);\n        }\n      }\n    }\n  }\n  \n  /**\n   * Add gold to player\n   */\n  addGold(amount: number): void {\n    this.state.player.gold += amount;\n    this.notify();\n  }\n\n  /**\n   * Drive DNA/metabolism per-NPC and map macro chemistry signals back to needs.\n   */\n  private applyChemistryTick(dtSeconds: number): void {\n    for (const npc of this.state.npcs) {\n      const macro = tickNpcChemistry(npc, REACTIONS_BODY, dtSeconds);\n      syncNeedsFromMacro(npc, macro);\n    }\n  }\n\n  private pickCatalogItem(predicate?: (item: ItemDefinition) => boolean): ItemDefinition | undefined {\n    const catalog = this.itemRegistry.list();\n    const pool = predicate ? catalog.filter(predicate) : catalog;\n    if (pool.length === 0) return undefined;\n    return this.random.choice(pool);\n  }\n\n  private synthesizeProceduralItem(labelPrefix: string): ItemId | null {\n    const seed = this.pickCatalogItem();\n    if (!seed) return null;\n\n    const ambient: Mix = {\n      O2: 0.5 + 0.5 * this.random.next(),\n      H2O: 0.2 + 0.4 * this.random.next(),\n      TEMP: 0.5 + 0.5 * this.random.next(),\n    };\n\n    const reactedMix = runReactor(\n      mixMerge(seed.mix, ambient),\n      {\n        temperature: ambient.TEMP,\n        tags: { rainfall: ambient.H2O, trust: this.random.next() },\n        steps: 4,\n        dt: 0.5,\n      },\n      flattenReactions(REACTIONS_LIBRARY),\n    );\n\n    const labelBase = labelPrefix ? `Procedural ${labelPrefix}` : 'Procedural Item';\n    // Placeholder label; Analyzer will enrich procedural item names in a later pass.\n    const label = labelBase.trim();\n    return this.itemRegistry.spawnFromMix(label, reactedMix);\n  }\n\n  private ensureProceduralItemId(\n    labelPrefix: string,\n    predicate?: (item: ItemDefinition) => boolean,\n  ): ItemId {\n    const candidate = this.pickCatalogItem(predicate);\n    if (candidate) return candidate.id;\n\n    const synthesized = this.synthesizeProceduralItem(labelPrefix);\n    if (synthesized) return synthesized;\n\n    const fallbackMix: Mix = {\n      GLU: 0.1 + 0.4 * this.random.next(),\n      FRUCT: 0.05 * this.random.next(),\n      H2O: 0.2 + 0.6 * this.random.next(),\n    };\n    return this.itemRegistry.spawnFromMix(`${labelPrefix} fallback`, fallbackMix);\n  }\n\n  private isEdible(item: ItemDefinition): boolean {\n    if (!item.tags) return false;\n    const isConsumable = item.tags.some((tag) => tag === 'food' || tag === 'drink');\n    const clearlyInedible = item.tags.includes('ore') || item.tags.includes('metal') || item.tags.includes('stone');\n    return isConsumable && !clearlyInedible;\n  }\n\n  private describeItem(itemId: ItemId): string {\n    return this.itemRegistry.getItem(itemId)?.name ?? itemId;\n  }\n\n  /**\n   * Periodically generate a new procedurally-reacted item and place it into the world.\n   */\n  private maybeSynthesizeProceduralItem(dtMs: number): void {\n    this.timeSinceLastItemSynthesis += dtMs;\n\n    // Run synthesis roughly every 10 seconds of simulation time\n    if (this.timeSinceLastItemSynthesis < 10000 || this.state.npcs.length === 0) {\n      return;\n    }\n\n    this.timeSinceLastItemSynthesis = 0;\n    const newItemId = this.synthesizeProceduralItem('item');\n    if (!newItemId) return;\n    const carrier = this.random.choice(this.state.npcs);\n    inventoryAdd(carrier, newItemId, 1, this.indices);\n\n    // TODO: NPC learning could later look at tags/traits/signature to decide experiments or trades.\n    this.addReportLog(\n      `${carrier.name} acquired a new procedural item: ${this.describeItem(newItemId)}.`,\n    );\n  }\n\n  getItemMix(itemId: ItemId): Mix | undefined {\n    return this.itemRegistry.getMix(itemId);\n  }\n\n  spawnItemFromMix(name: string, mix: Mix): ItemId {\n    return this.itemRegistry.spawnFromMix(name, mix);\n  }\n}","/**\n * UI rendering and interaction module\n */\nimport type { GameState } from '../engine';\nimport { TileType } from '../engine/world/map';\n\nexport class GameUI {\n  private rootElement: HTMLElement;\n  private questCompleteHandler?: (questId: string) => void;\n  private lastRenderTime: number = 0;\n  private renderThrottleMs: number = 250;\n  private pendingRender: boolean = false;\n  private engineToggle?: () => void;\n\n  constructor(rootElement: HTMLElement) {\n    this.rootElement = rootElement;\n\n    this.rootElement.addEventListener('click', (e) => {\n      const target = e.target as HTMLElement;\n      if (target instanceof HTMLButtonElement) {\n        if (target.dataset.questId) {\n          this.questCompleteHandler?.(target.dataset.questId);\n        } else if (target.dataset.action === 'toggle-simulation') {\n          this.engineToggle?.();\n        }\n      }\n    });\n  }\n\n  render(\n    state: GameState,\n    onQuestComplete: (questId: string) => void,\n    onToggleSimulation?: () => void\n  ): void {\n    this.questCompleteHandler = onQuestComplete;\n    this.engineToggle = onToggleSimulation;\n\n    // Throttle rendering to avoid DOM churn\n    const now = performance.now();\n    const timeSinceLastRender = now - this.lastRenderTime;\n\n    if (timeSinceLastRender < this.renderThrottleMs) {\n      if (!this.pendingRender) {\n        this.pendingRender = true;\n        setTimeout(() => {\n          this.pendingRender = false;\n          this.render(state, onQuestComplete, onToggleSimulation);\n        }, this.renderThrottleMs - timeSinceLastRender);\n      }\n      return;\n    }\n\n    this.lastRenderTime = now;\n\n    // Format time of day as HH:MM\n    const hours = Math.floor(state.timeOfDaySec / 3600);\n    const minutes = Math.floor((state.timeOfDaySec % 3600) / 60);\n    const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;\n\n    // Button state for simulation toggle\n    const btnClass = state.simRunning\n      ? 'gm-action-btn gm-action-btn-active'\n      : 'gm-action-btn';\n    const btnTitle = state.simRunning ? 'Pause simulation' : 'Start simulation';\n    const asciiMap = this.renderAsciiMap(state);\n\n    this.rootElement.innerHTML = `\n      <div class=\"gm-stage\">\n        <div class=\"gm-layout\">\n          <!-- Left action bar -->\n          <aside class=\"gm-actions\" aria-label=\"Actions\">\n            <button class=\"${btnClass}\" data-action=\"toggle-simulation\" title=\"${btnTitle}\">🌞</button>\n            <button class=\"gm-action-btn\" data-action=\"quests\" title=\"Quests\">⚔️</button>\n            <button class=\"gm-action-btn\" data-action=\"tavern\" title=\"Tavern\">🍺</button>\n            <button class=\"gm-action-btn\" data-action=\"market\" title=\"Market\">🧺</button>\n            <button class=\"gm-action-btn\" data-action=\"settings\" title=\"Settings\">⚙️</button>\n          </aside>\n\n          <!-- Center room -->\n          <main class=\"gm-room\">\n            <div class=\"gm-hud\">\n              <div class=\"gm-hud-card\">\n                <div class=\"gm-hud-title\">Day</div>\n                <div class=\"gm-hud-value\">${state.day}</div>\n              </div>\n\n              <div class=\"gm-hud-card\">\n                <div class=\"gm-hud-title\">Time</div>\n                <div class=\"gm-hud-value\">${timeStr}</div>\n              </div>\n\n              <div class=\"gm-hud-card\">\n                <div class=\"gm-hud-title\">Gold</div>\n                <div class=\"gm-hud-value gm-hud-gold\">${state.player.gold} pix</div>\n              </div>\n\n              <div class=\"gm-hud-card\">\n                <div class=\"gm-hud-title\">Guildmaster</div>\n                <div class=\"gm-hud-value\">${state.player.name}</div>\n              </div>\n            </div>\n\n            <div class=\"gm-room-content\">\n              <section class=\"gm-card\">\n                <h2>Guild Hall Interior</h2>\n                <div class=\"gm-small\">\n                  The \"room\" here is just a panel for now — later NPCs can walk behind it on a canvas layer.\n                </div>\n                <div style=\"height: 10px\"></div>\n                <div class=\"gm-list\">\n                  <div class=\"gm-quest\">\n                    <div class=\"gm-quest-title\">\n                      <span>📌 Status</span>\n                      <span>Level ${state.player.level}</span>\n                    </div>\n                    <div class=\"gm-quest-desc\">\n                      Experience: ${state.player.experience} XP | NPCs: ${state.npcs.length} | ${state.simRunning ? '▶️ Running' : '⏸️ Paused'}\n                    </div>\n                  </div>\n\n                  <div class=\"gm-quest\">\n                    <div class=\"gm-quest-title\">\n                      <span>🏰 Goal</span>\n                      <span style=\"color: rgba(255,255,255,0.75)\">Rebuild the Guild</span>\n                    </div>\n                    <div class=\"gm-quest-desc\">\n                      Sponsor adventurers, organize quests, and control the flow of gold.\n                    </div>\n                  </div>\n                </div>\n              </section>\n\n              <section class=\"gm-card gm-map-card\">\n                <div class=\"gm-map-header\">\n                  <div>\n                    <h2>City Map (ASCII)</h2>\n                    <div class=\"gm-small\">\n                      NPCs wander between points of interest. Letters = NPC initials, capitals = POIs, > = someone en route, * = crowded tile.\n                    </div>\n                  </div>\n                  <div class=\"gm-map-legend gm-small\">\n                    <div><span class=\"gm-map-key gm-road\"></span> Road</div>\n                    <div><span class=\"gm-map-key gm-building\"></span> Building</div>\n                    <div><span class=\"gm-map-key gm-water\"></span> Water</div>\n                  </div>\n                </div>\n                <pre class=\"gm-ascii-map\" aria-label=\"ASCII city map\">${asciiMap}</pre>\n              </section>\n\n              <section class=\"gm-card\">\n                <h2>Quest Board</h2>\n                <div class=\"gm-scroll\" style=\"max-height: 100%;\">\n                  <div class=\"gm-list\">\n                    ${state.quests\n                      .slice()\n                      .reverse()\n                      .map((quest) => {\n                        const completed = quest.completed;\n                        const border = completed\n                          ? 'border-left-color: rgba(0, 255, 136, 0.7);'\n                          : '';\n                        return `\n                          <div class=\"gm-quest\" style=\"${border}\">\n                            <div class=\"gm-quest-title\">\n                              <span>${quest.title}${completed ? ' ✓' : ''}</span>\n                              <span class=\"gm-hud-gold\">${quest.reward}💰</span>\n                            </div>\n                            <div class=\"gm-quest-desc\">${quest.description}</div>\n                            ${\n                              !completed\n                                ? `<button class=\"gm-quest-btn\" data-quest-id=\"${quest.id}\">Complete</button>`\n                                : `<div class=\"gm-small\" style=\"margin-top:8px; color: rgba(0,255,136,0.9); font-weight: 900;\">✓ Completed</div>`\n                            }\n                          </div>\n                        `;\n                      })\n                      .join('')}\n                  </div>\n                </div>\n              </section>\n            </div>\n          </main>\n\n          <!-- Right panels -->\n          <aside class=\"gm-right\">\n            <section class=\"gm-card\">\n              <h2>Summary</h2>\n              <div class=\"gm-small\">\n                Day ${state.day}, ${timeStr}. The guild has ${state.npcs.length} NPCs working and living in the city.\n                ${state.simRunning ? 'The simulation is running.' : 'Click the ☀️ button to start the simulation.'}\n              </div>\n            </section>\n\n            <section class=\"gm-card\">\n              <h2>Journal</h2>\n              <div class=\"gm-scroll gm-small\" id=\"gm-log\">\n                ${state.reportLog\n                  .slice()\n                  .reverse()\n                  .map(\n                    (entry) =>\n                      `<div>• ${entry.message}</div>`\n                  )\n                  .join('')}\n              </div>\n            </section>\n          </aside>\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Build a downsampled ASCII map representing the city grid and NPC movement.\n   */\n  private renderAsciiMap(state: GameState): string {\n    const map = state.worldMap;\n\n    // Downsample to keep the ASCII map compact while remaining readable.\n    const stride = 2;\n    const bucketsX = Math.ceil(map.width / stride);\n    const bucketsY = Math.ceil(map.height / stride);\n\n    const npcBuckets = new Map<\n      string,\n      { count: number; label: string; hasTarget: boolean }\n    >();\n\n    state.npcs.forEach((npc) => {\n      const bx = Math.floor(npc.pos.x / stride);\n      const by = Math.floor(npc.pos.y / stride);\n      const key = `${bx},${by}`;\n      const existing = npcBuckets.get(key);\n      const baseLabel = npc.name.charAt(0).toUpperCase() || '@';\n      if (existing) {\n        npcBuckets.set(key, {\n          count: existing.count + 1,\n          label: existing.count + 1 > 1 ? '*' : existing.label,\n          hasTarget: existing.hasTarget || Boolean(npc.targetPos),\n        });\n      } else {\n        npcBuckets.set(key, {\n          count: 1,\n          label: baseLabel,\n          hasTarget: Boolean(npc.targetPos),\n        });\n      }\n    });\n\n    const poiBuckets = new Map<string, string>();\n    map.getPOIs().forEach((poi) => {\n      const bx = Math.floor(poi.pos.x / stride);\n      const by = Math.floor(poi.pos.y / stride);\n      const key = `${bx},${by}`;\n      poiBuckets.set(key, poi.name.charAt(0).toUpperCase());\n    });\n\n    const rows: string[] = [];\n\n    for (let by = 0; by < bucketsY; by++) {\n      let row = '';\n      for (let bx = 0; bx < bucketsX; bx++) {\n        const key = `${bx},${by}`;\n\n        const npcMarker = npcBuckets.get(key);\n        if (npcMarker) {\n          row += npcMarker.count > 1\n            ? '*'\n            : npcMarker.hasTarget\n              ? '>'\n              : npcMarker.label;\n          continue;\n        }\n\n        const poiMarker = poiBuckets.get(key);\n        if (poiMarker) {\n          row += poiMarker;\n          continue;\n        }\n\n        const tile = map.getTile(bx * stride, by * stride);\n        switch (tile?.type) {\n          case TileType.Road:\n            row += '·';\n            break;\n          case TileType.Building:\n            row += '#';\n            break;\n          case TileType.Water:\n            row += '~';\n            break;\n          default:\n            row += ' ';\n            break;\n        }\n      }\n      rows.push(row);\n    }\n\n    return rows.join('\\n');\n  }\n}\n","/**\n * Main entry point for GuildMaster game\n */\nimport './ui/styles.css';\n\nimport { GameEngine } from './engine';\nimport { GameUI } from './ui';\n\n// Initialize the game\nfunction initGame() {\n  const appElement = document.getElementById('app');\n\n  if (!appElement) {\n    console.error('App root element not found');\n    return;\n  }\n\n  // Create game engine and UI\n  const engine = new GameEngine();\n  const ui = new GameUI(appElement);\n\n  // Define quest completion handler\n  const handleQuestComplete = (questId: string) => {\n    const success = engine.completeQuest(questId);\n    if (success) {\n      console.log(`Quest ${questId} completed!`);\n    }\n  };\n\n  // Define simulation toggle handler\n  const handleToggleSimulation = () => {\n    engine.toggle();\n  };\n\n  // Render initial state\n  ui.render(engine.getState(), handleQuestComplete, handleToggleSimulation);\n\n  // Subscribe to state changes and re-render\n  engine.subscribe((state) => {\n    ui.render(state, handleQuestComplete, handleToggleSimulation);\n  });\n\n  // Game loop for time-based updates\n  let lastTime = performance.now();\n\n  function gameLoop(currentTime: number) {\n    const deltaTime = currentTime - lastTime;\n    lastTime = currentTime;\n\n    engine.update(deltaTime);\n    requestAnimationFrame(gameLoop);\n  }\n\n  requestAnimationFrame(gameLoop);\n\n  console.log('GuildMaster game initialized!');\n}\n\n// Start the game when DOM is ready\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', initGame);\n} else {\n  initGame();\n}\n"],"names":["TileType","WorldMap","width","height","__publicField","y","row","x","waterPositions","dx","dy","poi","_a","_b","type","walkable","tile","id","manhattanDistance","a","b","posEquals","posKey","pos","findPath","start","goal","map","openSet","closedSet","startNode","directions","current","lowestF","node","reconstructPath","currentKey","dir","neighborPos","neighborKey","tentativeG","existingNode","h","newNode","path","isPathValid","WorldIndices","mapWidth","cellId","entityId","entities","fromPos","toPos","center","radius","result","itemId","sellers","newQuantity","oldQuantity","poiId","totalCellEntities","totalItemSellers","totalPoiEntities","validateSpatialIndex","npcs","indices","errors","expectedCells","npc","indexCells","indexedEntities","expectedEntities","validateInventoryIndex","expectedSellers","quantity","expectedSet","indexedSet","indexedSellers","validateIndices","_map","spatialResult","inventoryResult","logValidationResults","error","transferGold","state","from","to","amount","_reason","fromBalance","getGoldBalance","toBalance","setGoldBalance","holder","n","calculateTotalGold","total","validateEconomyInvariants","expectedTotal","actualTotal","diff","valid","initializeEconomy","cityTreasuryMin","cityTreasuryMax","random","initializeNeeds","ensureNeeds","clampNeed","value","modifyNeed","needType","delta","needs","satisfyNeed","syncNeedsFromMacro","macro","hungerSatisfaction","socialSatisfaction","getRelation","entityId1","entityId2","mapKey","innerMap","otherId","setRelation","reverseMap","modifyRelation","currentValue","performSocialInteraction","npc1Id","npc2Id","interactionType","ensureInventory","entity","inventoryAdd","inventory","inventoryRemove","inventoryGet","inventoryHas","EPS","mixGet","mix","key","mixAdd","next","mixScale","scale","out","k","v","mixMerge","base","mixTotal","acc","clamp","lo","hi","ReactionRule","opts","ctx","dt","cond","limit","need","available","extent","tagThreshold","tag","threshold","slope","val","tickMetabolism","reactions","reaction","absorbedFraction","absorbed","deriveMacroStates","glu","atp","ser","water","o2","oxidativeStress","hydrationLoad","oxygenDebt","phStress","chelationStress","stressChems","socialBond","dopa","runReactor","itemMix","options","steps","i","deriveMacroSnapshot","body","REACTIONS_WORLD","REACTIONS_BODY","REACTIONS_SOCIAL","REACTIONS_LIBRARY","flattenReactions","library","ensureChemistry","_c","tickNpcChemistry","dtSeconds","chemistry","dnaNpc","TAG_THRESHOLD","relevantEntries","normalizeMix","filtered","normalized","mixSignature","parts","hasRelevant","predicate","proportion","keys","analyzeMix","tags","ore","metal","fiberShare","resinShare","wood","fiber","stone","hydration","food","drink","fuel","reactive","balancer","forgedMarker","refinedMarker","calories","bitterness","umami","mineralness","metalness","oxidizingPower","acidityPotential","basicityPotential","chelatingPower","bufferingPower","osmoticLoad","reactivity","traits","oreEntries","dominantOre","best","metalCandidates","dominantMetalEntry","dominantMetal","oreNameMap","metalNameMap","canonicalName","metalName","qualifiers","displayName","applyAnalysisToItem","item","analysis","ItemRegistry","seedItems","analyzed","name","createSeedItemRegistry","combineMixes","items","weights","normalizedWeights","weightSum","w","idx","weight","scaled","processOptions","process","craftOnce","itemRegistry","inputs","labelHint","combined","variation","reactedMix","label","simulateIngestion","before","working","after","essentialKeys","essentialDelta","notes","stockHas","stock","qty","stockAdd","stockRemove","stockPickByTag","candidates","getPoiStockpile","stockpilesByPoi","SECONDS_PER_DAY","ACTION_TICK_INTERVAL","MAX_REPORT_LOG_LINES","JOB_TALENTS","withUnique","talentsForJob","job","Random","seed","min","max","array","GameEngine","player","quests","worldMap","families","catalog","baseSeeds","poiSeeds","seeds","stockpile","count","surnames","rand","caste","roll","stats","firstNames","firstName","family","reputation","initialMoney","npcTraits","traitCount","j","trait","attempts","listener","debugInfo","entityIds","sellerIds","message","actionCount","nextPos","oldPos","targetPOI","pois","marketPOI","tavernPOI","tradePoi","buyer","desiredTags","attempt","seller","sellerCatalog","it","t","tagForPrice","price","selections","source","s","tagOptions","allowReuse","usedIds","matches","prioritized","pool","invPool","stockPool","requiredTags","optionalTags","targetStockpile","choice","duplicate","jobConfig","config","sourceStockpile","sourcePoiName","tagPool","picked","attemptedTags","described","flattened","signature","inv","intent","recipes","recipe","score","inputSignatures","input","existing","r","sig","requiredCount","emphasis","npcBodyMix","craftedItem","sim","energyGain","hungerRelief","thirstRelief","essentialPenalty","slagPenalty","stability","profile","requiredPOI","currentPoi","foodScarcity","drinkScarcity","toolScarcity","materialScarcity","learned","selection","craftedId","craftedDef","consumableCatalog","consumed","ownedConsumable","verb","availableInStock","scarcityTag","priceMultiplier","foodCost","purchasedFood","events","event","otherNPCs","otherNPC","encounters","encounter","def","scarcity","anchorPoi","changes","change","chosen","richest","poorest","sourceStock","destStock","transferQty","questId","quest","q","success","expNeeded","deltaTime","oldTimeOfDay","deltaSeconds","validation","labelPrefix","ambient","candidate","synthesized","fallbackMix","isConsumable","clearlyInedible","dtMs","newItemId","carrier","GameUI","rootElement","target","onQuestComplete","onToggleSimulation","now","timeSinceLastRender","hours","minutes","timeStr","btnClass","btnTitle","asciiMap","completed","entry","stride","bucketsX","bucketsY","npcBuckets","bx","by","baseLabel","poiBuckets","rows","npcMarker","poiMarker","initGame","appElement","engine","ui","handleQuestComplete","handleToggleSimulation","lastTime","gameLoop","currentTime"],"mappings":"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"}