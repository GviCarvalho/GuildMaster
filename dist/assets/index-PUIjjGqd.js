var Gt=Object.defineProperty;var Ut=(s,t,e)=>t in s?Gt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var p=(s,t,e)=>Ut(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();var H=(s=>(s.Road="road",s.Building="building",s.Water="water",s))(H||{});class zt{constructor(t,e){p(this,"width");p(this,"height");p(this,"tiles");p(this,"pois");this.width=t,this.height=e,this.tiles=[],this.pois=[],this.initializeGrid()}initializeGrid(){for(let t=0;t<this.height;t++){const e=[];for(let i=0;i<this.width;i++)e.push({type:"road",walkable:!0});this.tiles.push(e)}}generateCity(){for(let i=0;i<this.height;i++)for(let n=0;n<this.width;n++)n%8===0||i%8===0?this.setTile(n,i,"road",!0):n%8>1&&n%8<7&&i%8>1&&i%8<7&&(n*73+i*31)%10<7&&this.setTile(n,i,"building",!1);const e=[[2,3],[5,1],[1,6],[4,2],[6,5],[3,4],[7,0],[0,7],[2,1],[5,6]];for(const[i,n]of e)this.setTile(i,n,"water",!1),this.setTile(this.width-1-i,this.height-1-n,"water",!1);this.initializePOIs()}initializePOIs(){this.pois=[{id:"guild-hall",name:"Guild Hall",pos:{x:32,y:32},footprint:{x:2,y:2}},{id:"tavern",name:"Tavern",pos:{x:16,y:16},footprint:{x:2,y:2}},{id:"market",name:"Market",pos:{x:48,y:16},footprint:{x:3,y:3}},{id:"mine",name:"Mine",pos:{x:8,y:48},footprint:{x:2,y:2}},{id:"forest",name:"Forest",pos:{x:56,y:48},footprint:{x:3,y:3}}],this.pois.forEach(t=>{var n,o;const e=((n=t.footprint)==null?void 0:n.x)||1,i=((o=t.footprint)==null?void 0:o.y)||1;for(let r=0;r<i;r++)for(let a=0;a<e;a++)this.setTile(t.pos.x+a,t.pos.y+r,"road",!0)})}getTile(t,e){return this.isInBounds(t,e)?this.tiles[e][t]:null}setTile(t,e,i,n){this.isInBounds(t,e)&&(this.tiles[e][t]={type:i,walkable:n})}isWalkable(t,e){const i=this.getTile(t,e);return i!==null&&i.walkable}isInBounds(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height}getPOIs(){return[...this.pois]}getPOI(t){return this.pois.find(e=>e.id===t)}}function dt(s,t){return Math.abs(s.x-t.x)+Math.abs(s.y-t.y)}function St(s,t){return s.x===t.x&&s.y===t.y}function ht(s){return`${s.x},${s.y}`}function V(s,t,e){if(St(s,t))return[];if(!e.isWalkable(t.x,t.y))return[];const i=new Map,n=new Set,o={pos:s,parent:null,g:0,h:dt(s,t),f:dt(s,t)};i.set(ht(s),o);const r=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];for(;i.size>0;){let a=null,l=1/0;for(const d of i.values())d.f<l&&(l=d.f,a=d);if(!a)break;if(St(a.pos,t))return jt(a);const c=ht(a.pos);i.delete(c),n.add(c);for(const d of r){const u={x:a.pos.x+d.x,y:a.pos.y+d.y},h=ht(u);if(n.has(h)||!e.isWalkable(u.x,u.y))continue;const m=a.g+1,f=i.get(h);if(f)m<f.g&&(f.parent=a,f.g=m,f.f=m+f.h);else{const y=dt(u,t),I={pos:u,parent:a,g:m,h:y,f:m+y};i.set(h,I)}}}return[]}function jt(s){const t=[];let e=s;for(;e!==null;)t.unshift(e.pos),e=e.parent;return t.length>0&&t.shift(),t}function Wt(s,t){for(const e of s)if(!t.isWalkable(e.x,e.y))return!1;return!0}class Qt{constructor(t){p(this,"mapWidth");p(this,"entitiesByCell");p(this,"sellersByItem");p(this,"entitiesByPoi");this.mapWidth=t,this.entitiesByCell=new Map,this.sellersByItem=new Map,this.entitiesByPoi=new Map}getCellId(t,e){return t+e*this.mapWidth}getCellPos(t){return{x:t%this.mapWidth,y:Math.floor(t/this.mapWidth)}}addEntityToCell(t,e){const i=this.getCellId(e.x,e.y);let n=this.entitiesByCell.get(i);n||(n=new Set,this.entitiesByCell.set(i,n)),n.add(t)}removeEntityFromCell(t,e){const i=this.getCellId(e.x,e.y),n=this.entitiesByCell.get(i);n&&(n.delete(t),n.size===0&&this.entitiesByCell.delete(i))}moveEntity(t,e,i){e.x===i.x&&e.y===i.y||(this.removeEntityFromCell(t,e),this.addEntityToCell(t,i))}getEntitiesInCell(t){const e=this.getCellId(t.x,t.y);return this.entitiesByCell.get(e)||new Set}getEntitiesInRadius(t,e){const i=new Set;for(let n=-e;n<=e;n++)for(let o=-e;o<=e;o++){const r=t.x+o,a=t.y+n;Math.abs(o)+Math.abs(n)<=e&&this.getEntitiesInCell({x:r,y:a}).forEach(d=>i.add(d))}return i}addSeller(t,e){let i=this.sellersByItem.get(e);i||(i=new Set,this.sellersByItem.set(e,i)),i.add(t)}removeSeller(t,e){const i=this.sellersByItem.get(e);i&&(i.delete(t),i.size===0&&this.sellersByItem.delete(e))}getSellersOfItem(t){return this.sellersByItem.get(t)||new Set}updateSellerIndex(t,e,i,n){n===0&&i>0?this.addSeller(t,e):n>0&&i===0&&this.removeSeller(t,e)}addEntityToPOI(t,e){let i=this.entitiesByPoi.get(e);i||(i=new Set,this.entitiesByPoi.set(e,i)),i.add(t)}removeEntityFromPOI(t,e){const i=this.entitiesByPoi.get(e);i&&(i.delete(t),i.size===0&&this.entitiesByPoi.delete(e))}getEntitiesAtPOI(t){return this.entitiesByPoi.get(t)||new Set}clear(){this.entitiesByCell.clear(),this.sellersByItem.clear(),this.entitiesByPoi.clear()}getDebugInfo(){let t=0;this.entitiesByCell.forEach(n=>{t+=n.size});let e=0;this.sellersByItem.forEach(n=>{e+=n.size});let i=0;return this.entitiesByPoi.forEach(n=>{i+=n.size}),{cellCount:this.entitiesByCell.size,itemCount:this.sellersByItem.size,poiCount:this.entitiesByPoi.size,totalCellEntities:t,totalItemSellers:e,totalPoiEntities:i}}}function Xt(s,t){const e=[],i=new Map;for(const o of s){const r=t.getCellId(o.pos.x,o.pos.y);let a=i.get(r);a||(a=new Set,i.set(r,a)),a.add(o.id)}const n=new Set;for(const o of s){const r=t.getCellId(o.pos.x,o.pos.y);n.add(r);const a=t.getEntitiesInCell(o.pos),l=i.get(r)||new Set;for(const c of l)a.has(c)||e.push(`Spatial index missing entity ${c} at cell (${o.pos.x}, ${o.pos.y})`);for(const c of a)l.has(c)||e.push(`Spatial index has extra entity ${c} at cell (${o.pos.x}, ${o.pos.y})`)}return{valid:e.length===0,errors:e}}function Jt(s,t){const e=[],i=new Map;for(const n of s)if(n.inventory){for(const[o,r]of n.inventory.entries())if(r>0){let a=i.get(o);a||(a=new Set,i.set(o,a)),a.add(n.id)}}for(const[n,o]of i.entries()){const r=t.getSellersOfItem(n);for(const a of o)r.has(a)||e.push(`Inventory index missing seller ${a} for item ${n}`)}for(const n of s)if(n.inventory)for(const[o,r]of n.inventory.entries()){const a=t.getSellersOfItem(o);r>0&&!a.has(n.id)&&e.push(`Entity ${n.id} has item ${o} but is not in seller index`),r===0&&a.has(n.id)&&e.push(`Entity ${n.id} has 0 of item ${o} but is in seller index`)}return{valid:e.length===0,errors:e}}function Yt(s,t,e){const i=Xt(s,t),n=Jt(s,t);return{valid:i.valid&&n.valid,errors:[...i.errors,...n.errors]}}function Kt(s){s.valid?console.log("✓ All indices are valid"):(console.error("✗ Index validation failed:"),s.errors.forEach(t=>console.error(`  - ${t}`)))}function j(s,t,e,i,n){if(i<=0)return!0;const o=Rt(s,t),r=Rt(s,e);return o<i?!1:(wt(s,t,o-i),wt(s,e,r+i),!0)}function Rt(s,t){if(t==="city")return s.cityTreasury;if(t==="guild")return s.guildTreasury||0;if(t==="player")return s.player.gold;{const e=s.npcs.find(i=>i.id===t);return e?e.money:0}}function wt(s,t,e){if(t==="city")s.cityTreasury=e;else if(t==="guild")s.guildTreasury!==void 0&&(s.guildTreasury=e);else if(t==="player")s.player.gold=e;else{const i=s.npcs.find(n=>n.id===t);i&&(i.money=e)}}function bt(s){let t=s.cityTreasury;s.guildTreasury!==void 0&&(t+=s.guildTreasury),t+=s.player.gold;for(const e of s.npcs)t+=e.money;return t}function Zt(s,t){const e=bt(s),i=e-t,n=Math.abs(i)<.01;return n||console.error(`[Economy] Gold mismatch! Expected: ${t}, Actual: ${e}, Diff: ${i}`),{valid:n,actual:e,expected:t,diff:i}}function Vt(s,t,e,i){s.cityTreasury=i.nextInt(t,e),s.guildTreasury!==void 0&&(s.guildTreasury=0),console.log(`[Economy] Initialized with city treasury: ${s.cityTreasury} gold`),console.log(`[Economy] Total economy gold: ${bt(s)} gold`)}function te(s){s.needs||(s.needs={hunger:50,social:50,fun:50})}function Lt(s){return s.needs||te(s),s.needs}function nt(s){return Math.max(0,Math.min(100,s))}function W(s,t,e){const i=Lt(s);i[t]=nt(i[t]+e)}function E(s,t,e){W(s,t,e)}function ee(s,t){const e=Lt(s),i=1-t.hungerSignal,n=nt((.5*(1-t.stress)+.5*t.mood)*100);e.hunger=nt(i*100),e.fun=nt(t.mood*100),e.social=n}function ie(s,t,e){if(!s.relations)return 0;for(const[i,n]of s.relations.entries())if(i===t||i===e){const o=i===t?e:t;return n.get(o)||0}return 0}function se(s,t,e,i){i=Math.max(-100,Math.min(100,i)),s.relations||(s.relations=new Map);let n=s.relations.get(t);n||(n=new Map,s.relations.set(t,n)),n.set(e,i);let o=s.relations.get(e);o||(o=new Map,s.relations.set(e,o)),o.set(t,i)}function ne(s,t,e,i){const n=ie(s,t,e);se(s,t,e,n+i)}function Tt(s,t,e,i){let n=0;switch(i){case"chat":n=2;break;case"trade":n=5;break;case"conflict":n=-10;break;case"help":n=8;break}return n+=Math.random()*2-1,ne(s,t,e,n),n}function $t(s){return s.inventory||(s.inventory=new Map),s.inventory}function G(s,t,e,i){const n=$t(s),o=n.get(t)||0,r=o+e;n.set(t,r),i.updateSellerIndex(s.id,t,r,o)}function tt(s,t,e,i){const n=$t(s),o=n.get(t)||0;if(o<e)return!1;const r=o-e;return r===0?n.delete(t):n.set(t,r),i.updateSellerIndex(s.id,t,r,o),!0}function oe(s,t){return s.inventory&&s.inventory.get(t)||0}function et(s,t,e){return oe(s,t)>=e}const rt=1e-9;function g(s,t){return s[t]??0}function X(s,t,e){if(Math.abs(e)<1e-12)return;const i=(s[t]??0)+e;i<=rt?delete s[t]:s[t]=i}function gt(s,t){const e={};for(const[i,n]of Object.entries(s)){const o=n*t;o>rt&&(e[i]=o)}return e}function J(s,t){const e={...s};for(const[i,n]of Object.entries(t))X(e,i,n);return e}function re(s){return Object.values(s).reduce((t,e)=>t+e,0)}function R(s,t,e){return Math.max(t,Math.min(e,s))}class k{constructor(t){p(this,"inputs");p(this,"outputs");p(this,"rate");p(this,"condition");this.inputs=t.inputs,this.outputs=t.outputs,this.rate=t.rate,this.condition=t.condition??(()=>1)}apply(t,e){const i=R(this.condition(t),0,3);if(i<=0)return;let n=Number.POSITIVE_INFINITY;for(const[r,a]of Object.entries(this.inputs)){if(a<=0)continue;const l=g(t.mix,r);n=Math.min(n,l/a)}if(!Number.isFinite(n)||n<=0)return;const o=this.rate*e*i*n;if(!(o<=0)){for(const[r,a]of Object.entries(this.inputs))X(t.mix,r,-a*o);for(const[r,a]of Object.entries(this.outputs))X(t.mix,r,a*o)}}}function Nt(s,t,e=10){return i=>{var o;const n=((o=i.tags)==null?void 0:o[s])??0;return 1/(1+Math.exp(-e*(n-t)))}}function Ft(s,t,e){const i={mix:s.stomach??{},temperature:g(s.body,"TEMP"),pH:g(s.body,"PH"),catalysts:Object.fromEntries(Object.entries(s.body).filter(([r])=>r.startsWith("ENZ_")))};for(const r of t)r.apply(i,e);s.stomach=i.mix;const n=R(.1*e,0,.5),o=gt(s.stomach,n);s.stomach=J(s.stomach,gt(o,-1)),s.body=J(s.body,o),ae(s,e)}function ae(s,t){const e=g(s.body,"GLU"),i=g(s.body,"ATP"),n=g(s.body,"SER"),o=g(s.body,"H2O"),r=g(s.body,"O2"),a=g(s.body,"OX_STRESS")+.5*g(s.body,"OXIDIZER"),l=Math.max(0,.3-o)+g(s.body,"DEHYDRATION_SIGNAL"),c=Math.max(0,.3-r),d=Math.max(0,g(s.body,"PH_ACID")+g(s.body,"PH_BASE")+g(s.body,"PH_SHIFT")-g(s.body,"PH_BUFFER")),u=g(s.body,"CHELATED_METAL"),h=g(s.body,"STRESS")+g(s.body,"CORT")+g(s.body,"ADREN")+a+d+l+u,m=g(s.body,"SOCIAL_BOND"),f=g(s.body,"DOPA");s.energy=R((s.energy??.5)+(.05*i+.02*e-.04*c-.04*d-.03*l)*t,0,1),s.pain=R((s.pain??0)+(.05*a+.04*d+.04*l+.02*u)*t,0,1),s.mood=R((s.mood??.5)+(.04*n-.02*h-.03*d-.02*l)*t,0,1),s.focus=R((s.focus??.5)+(.04*f-.03*h)*t,0,1),s.hunger=R((s.hunger??.5)+(.03-.05*e-.04*i)*t,0,1),s.thirst=R((s.thirst??.5)+(.03+.05*l-.08*o)*t,0,1),s.social=R((s.social??.5)+(.04*m-.02*h)*t,0,1)}function Bt(s,t,e){const i={mix:{...s},temperature:t.temperature,catalysts:t.catalysts,tags:t.tags},n=t.steps??10,o=t.dt??1;for(let r=0;r<n;r++)for(const a of e)a.apply(i,o);return i.mix}function pt(s){const t=g(s,"GLU"),e=g(s,"ATP"),i=g(s,"SER"),n=g(s,"H2O"),o=g(s,"O2"),r=g(s,"OX_STRESS")+.5*g(s,"OXIDIZER"),a=Math.max(0,.3-n)+g(s,"DEHYDRATION_SIGNAL"),l=Math.max(0,.3-o),c=Math.max(0,g(s,"PH_ACID")+g(s,"PH_BASE")+g(s,"PH_SHIFT")-g(s,"PH_BUFFER")),d=g(s,"CHELATED_METAL"),u=g(s,"STRESS")+g(s,"CORT")+g(s,"ADREN")+r+c+a+d,h=g(s,"DOPA");return{energy:R(.5+(.05*e+.02*t-.04*l-.04*c-.03*a),0,1),pain:R(.05*r+.04*c+.04*a+.02*d,0,1),mood:R(.5+(.04*i-.02*u-.03*c-.02*a),0,1),focus:R(.5+(.04*h-.03*u),0,1),hungerSignal:R(.5+(.03-.05*t-.04*e),0,1),thirstSignal:R(.5+(.03+.05*a-.08*n),0,1),stress:R(u,0,1)}}const ce=[new k({inputs:{H2O:.5},outputs:{HUMIDADE:.5},rate:.05,condition:Nt("rainfall",.6)}),new k({inputs:{MINERAL_DUST:1,H2O:.2},outputs:{SALT:.3},rate:.05})],vt=[new k({inputs:{GLU:1,O2:1},outputs:{ATP:1,CO2:1},rate:.2}),new k({inputs:{FRUCT:1,O2:1},outputs:{ATP:.8,CO2:1},rate:.18}),new k({inputs:{ATP:1},outputs:{TEMP:.02},rate:.1}),new k({inputs:{ATP:1,OXIDIZER:.4},outputs:{OX_STRESS:.6,CO2:.4},rate:.12}),new k({inputs:{IRON:.3,CHELATOR:.4},outputs:{CHELATED_METAL:.6},rate:.08}),new k({inputs:{H2O:1,SALT:.4},outputs:{DEHYDRATION_SIGNAL:.6},rate:.1}),new k({inputs:{PH:.1,PH_ACID:.5},outputs:{PH_SHIFT:.5},rate:.1}),new k({inputs:{PH:.1,PH_BASE:.5},outputs:{PH_SHIFT:.5},rate:.1}),new k({inputs:{PH_SHIFT:.5,PH_BUFFER:.5},outputs:{},rate:.6}),new k({inputs:{OXIDIZER:.4,PH_BUFFER:.4},outputs:{OX_STRESS:.2},rate:.2})],le=[new k({inputs:{SER:.2,DOPA:.2},outputs:{SOCIAL_BOND:.4},rate:.08,condition:Nt("trust",.5)})],ut={REACTIONS_WORLD:ce,REACTIONS_BODY:vt,REACTIONS_SOCIAL:le};function mt(s){return[...s.REACTIONS_WORLD,...s.REACTIONS_BODY,...s.REACTIONS_SOCIAL]}[...vt];function de(s){var t,e,i;return s.chemistry||(s.chemistry={body:{GLU:.5,H2O:.5,O2:.5,TEMP:.5,PH:.5},stomach:{},blood:{}}),(t=s.chemistry).body??(t.body={GLU:.5,H2O:.5,O2:.5,TEMP:.5,PH:.5}),(e=s.chemistry).stomach??(e.stomach={}),(i=s.chemistry).blood??(i.blood={}),s.chemistry}function he(s,t,e){const i=de(s),n={name:s.name,body:i.body,stomach:i.stomach,blood:i.blood};Ft(n,t,e),i.body=n.body,i.stomach=n.stomach??i.stomach,i.blood=n.blood??i.blood;const o=pt(i.body);return i.lastMacro=o,o}const M=.05;function Ht(s){return Object.entries(s).filter(([,t])=>t>rt)}function It(s){const t={};for(const[n,o]of Ht(s))t[n]=o;const e=re(t);if(e<=rt)return{};const i={};for(const[n,o]of Object.entries(t))i[n]=o/e;return i}function yt(s){const t=It(s),e=Object.entries(t).sort(([i],[n])=>i.localeCompare(n)).map(([i,n])=>`${i}:${(Math.round(n*1e3)/1e3).toFixed(3)}`);return e.length?e.join("|"):"empty"}function N(s,t){return Ht(s).some(t)}function T(s,t){const e=It(s);return t.reduce((i,n)=>i+(e[n]??0),0)}function ue(s){const t=It(s),e=[],i=N(t,([v,S])=>v.startsWith("ORE_")&&S>M),n=N(t,([v,S])=>["IRON","FE","CU","SN","AU"].includes(v)&&S>M),o=T(t,["FIBER"]),r=T(t,["RESIN"]),a=r>.1||o>.25&&r>.05,l=o>M,c=!i&&N(t,([v,S])=>["SILICA","MINERAL_DUST"].includes(v)&&S>M),d=T(t,["H2O"]),u=N(t,([v,S])=>["GLU","FRUCT","UMAMI","FAT","PROTEIN"].includes(v)&&S>M),h=d>.2,m=N(t,([v,S])=>["CARBON","COAL","ORE_COAL"].includes(v)&&S>M),f=N(t,([v,S])=>["OXIDIZER","PH_ACID","PH_BASE","CHELATOR"].includes(v)&&S>M),y=N(t,([v,S])=>v==="PH_BUFFER"&&S>M),I=t.FORGED??0,b=t.REFINED??0;i&&e.push("ore"),n&&e.push("metal"),a?e.push("wood"):l&&e.push("fiber"),c&&e.push("stone"),u&&e.push("food"),h&&e.push("drink"),m&&e.push("fuel"),f&&e.push("reactive"),y&&e.push("balancing"),(u||a)&&e.push("organic"),(i||c||n)&&e.push("inorganic"),I>M&&(e.push("forged"),e.includes("tool")||e.push("tool")),b>M&&(e.push("refined"),e.includes("material")||e.push("material"));const w=T(t,["GLU","FRUCT","FAT","PROTEIN"]),O=T(t,["AMARGO"]),P=T(t,["UMAMI"]),x=T(t,["SILICA","MINERAL_DUST","SALT","SLAG"]),Y=T(t,["IRON","FE","CU","SN","AU","ORE_FE","ORE_CU","ORE_SN","ORE_AU","ORE_COAL"]),$=T(t,["OXIDIZER"]),D=T(t,["PH_ACID"]),K=T(t,["PH_BASE"]),at=T(t,["CHELATOR"]),U=T(t,["PH_BUFFER"]),ct=T(t,["SALT"]),_=$+D+K+at+ct,A={hydration:d,calories:w,bitterness:O,umami:P,mineralness:x,metalness:Y,oxidizingPower:$,acidityPotential:D,basicityPotential:K,chelatingPower:at,bufferingPower:U,osmoticLoad:ct,reactivity:_},Z=Object.entries(t).filter(([v])=>v.startsWith("ORE_")),Pt=Z.length?Z.reduce((v,S)=>S[1]>v[1]?S:v)[0]:void 0,Dt=["FE","IRON","CU","SN","AU","ORE_FE","ORE_CU","ORE_SN","ORE_AU"],lt=Object.entries(t).filter(([v])=>Dt.includes(v)).reduce((v,S)=>!v||S[1]>v[1]?S:v,null),z=lt==null?void 0:lt[0],_t={ORE_FE:"Iron Ore",ORE_CU:"Copper Ore",ORE_SN:"Tin Ore",ORE_AU:"Gold Ore"},xt={FE:"Iron",IRON:"Iron",CU:"Copper",SN:"Tin",AU:"Gold",ORE_FE:"Iron",ORE_CU:"Copper",ORE_SN:"Tin",ORE_AU:"Gold"};let C="Material";if(I>M&&(e.includes("metal")||e.includes("ore")))C=`${z?xt[z]??"Metal":"Metal"} Tool`;else if(b>M&&(e.includes("ore")||e.includes("metal"))){const v=z?xt[z]??"Metal":"Metal";C=z?`${v} Ingot`:"Refined Metal"}else e.includes("ore")?C=Pt?_t[Pt]??"Ore":"Ore":e.includes("wood")?C="Wood":e.includes("stone")?C="Stone":e.includes("drink")?C=A.hydration>.7&&(t.H2O??0)>.7?"Water":"Drink":e.includes("food")?C="Food":e.includes("fuel")&&(C="Fuel");const q=[];A.mineralness>.35&&e.includes("drink")&&q.push("brackish"),A.mineralness>.35&&(e.includes("ore")||e.includes("metal"))&&q.push("impure"),A.calories>.45&&e.includes("food")&&q.push("nutritious"),A.reactivity>.35&&q.push("reactive");const qt=q.length?`${C} (${q.join(", ")})`:C;return{tags:e,traits:A,canonicalName:C,displayName:qt,signature:yt(s)}}function Ot(s){const t=ue(s.mix);return{...s,...t,name:t.displayName}}class me{constructor(t){p(this,"items",new Map);p(this,"counter",0);t==null||t.forEach(e=>{const i=Ot(e);this.items.set(i.id,{...i,mix:{...i.mix}})})}register(t,e,i){const n=Ot({id:t,name:e,mix:i});return this.items.set(t,{...n,mix:{...n.mix}}),t}spawnFromMix(t,e){this.counter+=1;const i=`${t.toLowerCase().replace(/\s+/g,"-")}-${this.counter}`;return this.register(i,t,e)}getItem(t){const e=this.items.get(t);return e?{...e,mix:{...e.mix}}:void 0}getMix(t){const e=this.items.get(t);return e?{...e.mix}:void 0}mergeItemMix(t,e){const i=this.items.get(t);i&&(i.mix=J(i.mix,e))}list(){return Array.from(this.items.values()).map(t=>({...t,mix:{...t.mix}}))}}function fe(){const s=[{id:"berry-red",name:"Red Berry",mix:{GLU:.6,FRUCT:.4,DOCE:.2,H2O:.5}},{id:"ore-iron",name:"Iron Ore",mix:{ORE_FE:1,MINERAL_DUST:.1}},{id:"ore-copper",name:"Copper Ore",mix:{ORE_CU:1,MINERAL_DUST:.1}},{id:"water-flask",name:"Canteen",mix:{H2O:1}},{id:"raw-wood",name:"Wood",mix:{FIBER:.6,RESIN:.3,H2O:.2}},{id:"raw-stone",name:"Stone",mix:{SILICA:.5,MINERAL_DUST:.4}},{id:"raw-coal",name:"Coal",mix:{CARBON:.5,ORE_COAL:.5,COAL:.3}},{id:"raw-salt",name:"Salt",mix:{SALT:.8}},{id:"raw-water",name:"Water",mix:{H2O:1}},{id:"raw-wool",name:"Raw Wool",mix:{FIBER:.7,PROTEIN:.2,H2O:.1}},{id:"raw-cotton",name:"Cotton Bale",mix:{FIBER:.8,H2O:.15}},{id:"raw-leather",name:"Raw Leather",mix:{PROTEIN:.6,FAT:.2,FIBER:.1,H2O:.1}},{id:"raw-herb",name:"Aromatic Herbs",mix:{GLU:.2,H2O:.4,PH_BUFFER:.1,UMAMI:.1}},{id:"raw-grain",name:"Grains",mix:{GLU:.5,FIBER:.3,H2O:.1}}];return new me(s)}function ge(s,t){if(s.length===0)return{};const e=t&&t.length===s.length?t:new Array(s.length).fill(1),i=e.reduce((n,o)=>n+Math.max(o,0),0)||s.length;return s.reduce((n,o,r)=>{const a=Math.max(e[r]??1,0)/i,l=gt(o.mix,a);return J(n,l)},{})}function pe(s){switch(s){case"forge":return{temperature:.9,tags:{heat:1},steps:8,dt:.8};case"cook":return{temperature:.65,tags:{heat:.6,wet:.2},steps:6,dt:.6};case"brew":return{temperature:.55,tags:{wet:1},steps:10,dt:.5};case"refine":return{temperature:.75,tags:{heat:.8,oxidize:.5},steps:7,dt:.7};default:return{}}}function ye(s,t,e,i,n,o,r){const a=ge(i,r);n==="forge"?X(a,"FORGED",.1):n==="refine"&&X(a,"REFINED",.1);const l=pe(n),c=typeof(s==null?void 0:s.choice)=="function"&&"next"in s?s.next():Math.random(),d=Bt(a,{...l,tags:{...l.tags??{},variation:c}},e),u=o||`${n} craft`;return t.spawnFromMix(u,d)}function be(s,t,e,i=5,n=.5){const o=pt(s),r={body:{...s},stomach:{...t}};for(let u=0;u<i;u++)Ft(r,e,n);const a=pt(r.body),l=["ATP","H2O","O2","GLU","PH","TEMP"],c={};for(const u of l)c[u]=(r.body[u]??0)-(s[u]??0);const d=[];return c.H2O>.05&&d.push("positive hydration"),c.H2O<-.05&&d.push("reduced hydration"),c.ATP>.05&&d.push("increased potential energy"),c.O2<-.05&&d.push("oxygen consumed"),c.PH<-.05&&d.push("acidifying tendency"),c.PH>.05&&d.push("alkalizing tendency"),{before:o,after:a,essentialDelta:c,notes:d}}function Q(s,t,e){return(s[t]??0)>=e}function it(s,t,e){e<=0||(s[t]=(s[t]??0)+e)}function F(s,t,e){if(!Q(s,t,e))return!1;const i=(s[t]??0)-e;return i<=0?delete s[t]:s[t]=i,!0}function st(s,t,e,i){const n=t.list().filter(o=>{var r;return((r=o.tags)==null?void 0:r.includes(e))&&Q(s,o.id,1)});return n.length===0?null:i.choice(n)}function L(s,t){return s[t]||(s[t]={}),s[t]}const kt=1200,ft=2e3,Et=500,ve={Blacksmith:["forge"],Artisan:["craft"],Tailor:["tailor"],Builder:["build"],Weaver:["weave"],Lumberjack:["harvest_wood"],Farmer:["grow_food"],Rancher:["raise_animals"],Fisher:["fish"],Hunter:["hunt"],Miner:["mine_ore"],Alchemist:["alchemy"],Herbalist:["alchemy"],Merchant:["trade"],Guard:["security"],Soldier:["security"],Aristocrat:["influence"],Politician:["influence"],Patron:["influence"]};function Mt(s){return Array.from(new Set(s))}function Ie(s){return ve[s]??[]}class Pe{constructor(t=Date.now()){p(this,"seed");this.seed=t}next(){return this.seed=(this.seed*9301+49297)%233280,this.seed/233280}nextInt(t,e){return Math.floor(this.next()*(e-t+1))+t}choice(t){if(t.length===0)throw new Error("Cannot choose from empty array");return t[Math.floor(this.next()*t.length)]}}class xe{constructor(){p(this,"state");p(this,"listeners",new Set);p(this,"lastActionTick",0);p(this,"random");p(this,"indices");p(this,"initialEconomyGold",0);p(this,"itemRegistry");p(this,"timeSinceLastItemSynthesis",0);p(this,"lastMarketFluctuationDay",-1);p(this,"stockpilesByPoi");this.random=new Pe,this.itemRegistry=fe(),this.stockpilesByPoi={},this.state=this.createInitialState(),this.initializeStockpiles(),this.indices=new Qt(this.state.worldMap.width),this.rebuildIndices(),Vt(this.state,5e3,1e4,this.random),this.initialEconomyGold=bt(this.state),console.log(`[GameEngine] Economy initialized with ${this.initialEconomyGold} total gold`)}createInitialState(){const t={name:"Guild Master",gold:100,level:1,experience:0},e=[{id:"quest-1",title:"Welcome to the Guild",description:"Complete your first quest to begin your journey.",reward:50,completed:!1},{id:"quest-2",title:"Gather Resources",description:"Collect resources to expand your guild.",reward:100,completed:!1}],i=new zt(64,64);i.generateCity();const n=this.generateFamilies(20),o=this.generateInitialNPCs(100,i,n);return{player:t,quests:e,currentTime:0,day:1,timeOfDaySec:0,simRunning:!1,reportLog:[{timestamp:0,message:"Welcome to ProjectGM. The guild is ready to begin."}],families:n,npcs:o,worldMap:i,cityTreasury:0,relations:new Map,guildTreasury:0}}initializeStockpiles(){const t=this.itemRegistry.list(),e={wood:30,stone:30,ore:18,fuel:16,drink:40,food:34,organic:14,fiber:20,balancing:8,metal:12},i={"guild-hall":{...e},market:{...e,fiber:26},mine:{...e,ore:40,metal:20,stone:42,fuel:24},forest:{...e,wood:55,drink:30,organic:40,fiber:35},tavern:{...e,food:50,drink:60,wood:12,stone:10,fiber:18}};for(const[n,o]of Object.entries(i)){const r=L(this.stockpilesByPoi,n);for(const a of t)if(a.tags)for(const l of a.tags){const c=o[l];c&&it(r,a.id,c)}}}generateFamilies(t){const e=["Silva","Cavalcanti","Lins","Holanda","Barros","Melo","Albuquerque","Santos","Oliveira","Souza","Costa","Ferreira","Rodrigues","Nascimento","Lima"],i=[];for(let n=0;n<t;n++){const o=this.random.next();let r="commoner";o>.9?r="noble":o>.75?r="merchant":o>.6&&(r="artisan"),i.push({id:`fam-${n}`,surname:this.random.choice(e),caste:r})}return i}generateStats(t){const e=()=>this.random.nextInt(3,10),i={strength:e(),vitality:e(),dexterity:e(),wisdom:e(),intelligence:e(),charisma:e()};switch(t){case"noble":i.charisma+=3,i.intelligence+=2;break;case"artisan":i.dexterity+=3,i.wisdom+=1;break;case"commoner":i.strength+=2,i.vitality+=2;break;case"merchant":i.charisma+=2,i.wisdom+=2;break}return i}generateInitialNPCs(t,e,i){const n=["John","Mary","Peter","Anna","Charles","Beatrice","Luke","Julia","Raphael","Camille","Fernando","Isabella","Gabriel","Larissa","Matthew","Sophie","Bruno","Amanda","Diego","Leticia"],o=["Brave","Cautious","Greedy","Generous","Skilled","Lucky","Hardworking","Lazy","Clever","Naive"],r=[];for(let a=0;a<t;a++){const l=this.random.choice(n),c=this.random.choice(i),d=this.generateStats(c.caste),u=c.caste==="noble"?50:0;let h="Unemployed";c.caste==="noble"?h=this.random.choice(["Aristocrat","Politician","Patron"]):c.caste==="artisan"||d.dexterity>7?h=this.random.choice(["Blacksmith","Artisan","Tailor","Builder","Weaver"]):c.caste==="merchant"||d.charisma>7?h="Merchant":d.strength>7?h=this.random.choice(["Guard","Soldier","Lumberjack"]):d.wisdom>7?h=this.random.choice(["Alchemist","Herbalist"]):d.dexterity>7?h=this.random.choice(["Hunter","Lumberjack"]):h=this.random.choice(["Farmer","Rancher","Fisher","Miner"]);let m=0;switch(c.caste){case"noble":m=this.random.nextInt(300,800);break;case"merchant":m=this.random.nextInt(100,400);break;case"artisan":m=this.random.nextInt(50,150);break;default:m=this.random.nextInt(5,50);break}const f=[],y=this.random.nextInt(1,3);for(let O=0;O<y;O++){const P=this.random.choice(o);f.includes(P)||f.push(P)}let I=this.random.nextInt(0,e.width-1),b=this.random.nextInt(0,e.height-1),w=0;for(;!e.isWalkable(I,b)&&w<100;)I=this.random.nextInt(0,e.width-1),b=this.random.nextInt(0,e.height-1),w++;e.isWalkable(I,b)||(I=0,b=0),r.push({id:`npc-${a+1}`,name:`${l} ${c.surname}`,familyId:c.id,caste:c.caste,reputation:u,stats:d,talents:Mt([...Ie(h),...d.strength>8?["harvest_wood"]:[],...d.wisdom>8?["alchemy"]:[],...d.dexterity>8?["craft"]:[]]),pos:{x:I,y:b},money:m,job:h,traits:f,needs:{hunger:this.random.nextInt(40,60),social:this.random.nextInt(40,60),fun:this.random.nextInt(40,60)}})}return r}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t(this.state))}getState(){return{...this.state}}rebuildIndices(){this.indices.clear();for(const e of this.state.npcs)this.indices.addEntityToCell(e.id,e.pos);for(const e of this.state.npcs)if(e.inventory)for(const[i,n]of e.inventory.entries())n>0&&this.indices.addSeller(e.id,i);const t=this.indices.getDebugInfo();console.log("[Phase 2] Indices rebuilt:",t)}validateIndices(){const t=Yt(this.state.npcs,this.indices,this.state.worldMap);Kt(t)}getEntitiesNearPosition(t,e,i){const n=this.indices.getEntitiesInRadius({x:t,y:e},i);return this.state.npcs.filter(o=>n.has(o.id))}getSellersOfItem(t){const e=this.indices.getSellersOfItem(t);return this.state.npcs.filter(i=>e.has(i.id))}start(){this.state.simRunning||(this.state.simRunning=!0,this.addReportLog("Simulation started."),this.notify())}stop(){this.state.simRunning&&(this.state.simRunning=!1,this.addReportLog("Simulation paused."),this.notify())}toggle(){this.state.simRunning?this.stop():this.start()}addReportLog(t){this.state.reportLog.push({timestamp:this.state.currentTime,message:t}),this.state.reportLog.length>Et&&(this.state.reportLog=this.state.reportLog.slice(-Et)),this.notify()}executeWorldActions(){const t=this.random.nextInt(1,8);for(let e=0;e<t;e++)this.executeRandomAction()}executeRandomAction(){switch(this.random.nextInt(0,5)){case 0:this.actionNPCMovement();break;case 1:this.actionNPCTrade();break;case 2:this.actionNPCWork();break;case 3:this.actionNPCEat();break;case 4:this.random.next()<.5?this.actionRandomEncounter():this.actionGuildEvent();break;case 5:this.actionMarketFluctuation();break}}isNPCAtPOI(t,e){var o,r;const i=((o=e.footprint)==null?void 0:o.x)||1,n=((r=e.footprint)==null?void 0:r.y)||1;return t.pos.x>=e.pos.x&&t.pos.x<e.pos.x+i&&t.pos.y>=e.pos.y&&t.pos.y<e.pos.y+n}getPOIForPosition(t){return this.state.worldMap.getPOIs().find(e=>{var o,r;const i=((o=e.footprint)==null?void 0:o.x)||1,n=((r=e.footprint)==null?void 0:r.y)||1;return t.x>=e.pos.x&&t.x<e.pos.x+i&&t.y>=e.pos.y&&t.y<e.pos.y+n})}resolveDefaultPoiId(){var t,e,i;return((t=this.state.worldMap.getPOI("market"))==null?void 0:t.id)||((e=this.state.worldMap.getPOI("guild-hall"))==null?void 0:e.id)||((i=this.state.worldMap.getPOIs()[0])==null?void 0:i.id)||"guild-hall"}getNpcPoi(t){return this.getPOIForPosition(t.pos)}getNpcStockpile(t){const e=this.getNpcPoi(t),i=(e==null?void 0:e.id)??this.resolveDefaultPoiId();return{stockpile:L(this.stockpilesByPoi,i),poiId:i}}actionNPCMovement(){if(this.state.npcs.length===0)return;const t=this.random.choice(this.state.npcs);if(t.currentPath&&t.currentPath.length>0){const e=t.currentPath[0];if(!Wt(t.currentPath,this.state.worldMap)){t.currentPath=void 0;return}const i={x:t.pos.x,y:t.pos.y};if(t.pos={x:e.x,y:e.y},t.currentPath.shift(),this.indices.moveEntity(t.id,i,t.pos),t.currentPath.length===0&&t.targetPos){const o=this.state.worldMap.getPOIs().find(r=>r.pos.x===t.targetPos.x&&r.pos.y===t.targetPos.y);o&&this.addReportLog(`${t.name} arrived at ${o.name}.`),t.targetPos=void 0,t.currentPath=void 0}}else if(this.random.next()<.3){const e=this.state.worldMap.getPOIs(),i=this.random.choice(e);if(!this.isNPCAtPOI(t,i)){t.targetPos={x:i.pos.x,y:i.pos.y};const n=V(t.pos,t.targetPos,this.state.worldMap);n.length>0?t.currentPath=n:t.targetPos=void 0}}}actionNPCTrade(){var b,w,O;if(this.state.npcs.length<2)return;const t=this.state.worldMap.getPOI("market"),e=this.state.worldMap.getPOI("tavern"),i=t??e;if(!i)return;const n=this.random.choice(this.state.npcs);if(!this.isNPCAtPOI(n,i)){if(this.random.next()<.4&&!n.targetPos){n.targetPos={x:i.pos.x,y:i.pos.y};const P=V(n.pos,n.targetPos,this.state.worldMap);n.currentPath=P.length>0?P:void 0,n.currentPath||(n.targetPos=void 0)}return}const a=(((b=n.needs)==null?void 0:b.hunger)??50)<55?["food","drink"]:this.random.next()<.6?["tool"]:["material"],l=this.state.npcs.filter(P=>P.id!==n.id&&this.isNPCAtPOI(P,i));if(l.length===0)return;for(let P=0;P<6;P++){const x=this.random.choice(l),Y=this.itemRegistry.list().filter(_=>{var A;return((A=_.tags)==null?void 0:A.some(Z=>a.includes(Z)))&&et(x,_.id,1)});if(Y.length===0)continue;const $=this.random.choice(Y),D=((w=$.tags)==null?void 0:w.find(_=>a.includes(_)))??a[0],K=i.id,U=Math.max(1,Math.round((D==="tool"?25:D==="material"?15:10)*this.getPriceMultiplier(K,D)));if(!(n.money<U||!j(this.state,n.id,x.id,U))){tt(x,$.id,1,this.indices),G(n,$.id,1,this.indices),this.addReportLog(`${n.name} bought ${$.name} from ${x.name} for ${U} coins.`),Tt(this.state,n.id,x.id,"trade"),E(n,"hunger",a.includes("food")||a.includes("drink")?8:2);return}}const c=i.id,d=L(this.stockpilesByPoi,c),u=a.map(P=>st(d,this.itemRegistry,P,this.random)).filter(P=>!!P);if(u.length===0)return;const h=this.random.choice(u),m=((O=h.tags)==null?void 0:O.find(P=>a.includes(P)))??a[0],y=Math.max(1,Math.round((m==="tool"?25:m==="material"?15:10)*this.getPriceMultiplier(c,m)));n.money<y||!j(this.state,n.id,"city",y)||(F(d,h.id,1),G(n,h.id,1,this.indices),this.addReportLog(`${n.name} purchased ${h.name} at ${i.name} for ${y} coins.`),E(n,"hunger",a.includes("food")||a.includes("drink")?6:1))}getCraftProfileForJob(t){switch(t){case"Blacksmith":return{requiredTalent:"forge",intent:this.random.next()>.6?"weapon":"tool",process:"forge",requiredTags:[["metal","ore"],["fuel"],["wood","organic","fiber"]],optionalTags:[["metal","ore"],["wood","organic"]]};case"Artisan":return{requiredTalent:"craft",intent:this.random.next()>.55?"tool":"material",process:"refine",requiredTags:[["wood","fiber","organic"],["wood","fiber","organic"],["stone","wood"]],optionalTags:[["fuel"],["organic","fiber"]]};case"Tailor":return{requiredTalent:"tailor",intent:"material",process:"cook",requiredTags:[["fiber"],["fiber","organic"]],optionalTags:[["organic","material"],["fiber"]]};case"Builder":return{requiredTalent:"build",intent:this.random.next()>.4?"material":"tool",process:"refine",requiredTags:[["stone"],["wood","organic"],["wood","fiber","organic"]],optionalTags:[["fuel"],["stone","wood"]]};case"Weaver":return{requiredTalent:"weave",intent:"material",process:"cook",requiredTags:[["fiber"],["fiber","organic"]],optionalTags:[["organic","fiber"]]};case"Lumberjack":return{requiredTalent:"harvest_wood",intent:"material",process:"refine",requiredTags:[["wood"],["wood","organic"]],optionalTags:[["fuel","wood"],["organic"]]};case"Farmer":return{requiredTalent:"grow_food",intent:"food",process:"cook",requiredTags:[["food","organic"],["drink"]],optionalTags:[["food","organic"],["drink","organic"]]};case"Rancher":return{requiredTalent:"raise_animals",intent:this.random.next()>.5?"food":"drink",process:this.random.next()>.4?"cook":"brew",requiredTags:[["food","organic"],["drink"],["fiber","organic"]],optionalTags:[["organic"],["fiber","organic"]]};case"Alchemist":case"Herbalist":return{requiredTalent:"alchemy",intent:this.random.next()>.5?"medicine":"drink",process:"brew",requiredTags:[["organic"],["balancing","drink","medicine","organic"]],optionalTags:[["drink","medicine","organic"],["balancing","organic"]]};case"Miner":return{requiredTalent:"mine_ore",intent:"material",process:"refine",requiredTags:[["ore","stone"],["stone"]],optionalTags:[["fuel"]]};case"Hunter":return{requiredTalent:"hunt",intent:this.random.next()>.4?"food":"material",process:"cook",requiredTags:[["organic"],["food","organic"]],optionalTags:[["fiber"],["drink","organic"]]};case"Fisher":return{requiredTalent:"fish",intent:"food",process:"cook",requiredTags:[["food","drink","organic"],["food","organic"]],optionalTags:[["drink","organic"]]};default:return null}}countSelection(t,e,i){return t.filter(n=>n.definition.id===e&&n.source===i).length}pickIngredient(t,e,i,n,o=!1){const r=this.itemRegistry.list(),a=o?[]:i.map(f=>f.definition.id),l=r.filter(f=>{var y;return((y=f.tags)==null?void 0:y.some(I=>e.includes(I)))&&!a.includes(f.id)}),d=e.includes("stone")&&!e.includes("ore")?l.filter(f=>{var y;return!((y=f.tags)!=null&&y.includes("ore"))}):l,u=d.length>0?d:l,h=u.filter(f=>et(t,f.id,1+this.countSelection(i,f.id,"inventory")));if(h.length>0)return{definition:this.random.choice(h),source:"inventory"};const m=u.filter(f=>Q(n,f.id,1+this.countSelection(i,f.id,"stockpile")));return m.length>0?{definition:this.random.choice(m),source:"stockpile"}:null}acquireInputs(t,e,i=[],n){const o=[],r=n??this.getNpcStockpile(t).stockpile;for(const a of e){const l=this.pickIngredient(t,a,o,r);if(!l)return null;o.push(l)}for(const a of i){if(o.length>=3)break;const l=this.pickIngredient(t,a,o,r);l&&o.push(l)}if(o.length<2)for(const a of e){const l=this.pickIngredient(t,a,o,r,!0);if(l){o.push(l);break}}return o.length>=2?o:null}performGatheringJob(t,e,i){var h;const n={Miner:{sourcePoi:"mine",tags:[["ore","metal","stone","fuel"]],activity:"hauled resources from"},Lumberjack:{sourcePoi:"forest",tags:[["wood"]],activity:"felled timber in"},Farmer:{sourcePoi:"market",tags:[["food","organic"],["drink"]],activity:"collected produce at"},Rancher:{sourcePoi:"market",tags:[["fiber","food","organic"]],activity:"brought ranch goods from"},Fisher:{sourcePoi:"tavern",tags:[["food","drink","organic"]],activity:"hauled a catch from"},Hunter:{sourcePoi:"forest",tags:[["organic","food","fiber"]],activity:"returned with game from"}},o=t.job?n[t.job]:void 0;if(!o)return!1;const r=L(this.stockpilesByPoi,o.sourcePoi),a=((h=this.state.worldMap.getPOI(o.sourcePoi))==null?void 0:h.name)??o.sourcePoi,l=Mt(o.tags.flat());let c=null;const d=new Set;for(;d.size<l.length&&!c;){const m=this.random.choice(l.filter(f=>!d.has(f)));d.add(m),c=st(r,this.itemRegistry,m,this.random)}if(!c)return!1;F(r,c.id,1),it(e,c.id,1);const u=c.displayName??c.name??c.id;return this.addReportLog(`${t.name} ${o.activity} ${a} and stocked ${u} at ${i}.`),W(t,"hunger",-5),W(t,"fun",-2),!0}collectFromStockpile(t,e,i,n){const o=e.flat(),r=this.random.choice(o),a=st(i,this.itemRegistry,r,this.random);a&&(F(i,a.id,1),G(t,a.id,1,this.indices),this.addReportLog(`${t.name} collected ${a.displayName??a.name} from the local stockpile (${n}).`))}matchItemBySignature(t,e,i,n){const o=this.itemRegistry.list().filter(l=>l.signature===e||yt(l.mix)===e),r=o.filter(l=>et(t,l.id,1+this.countSelection(i,l.id,"inventory")));if(r.length>0)return{definition:this.random.choice(r),source:"inventory"};const a=o.filter(l=>Q(n,l.id,1+this.countSelection(i,l.id,"stockpile")));return a.length>0?{definition:this.random.choice(a),source:"stockpile"}:null}pickLearnedRecipe(t,e,i,n){const o=(t.learnedRecipes??[]).filter(r=>r.intent===e&&r.process===i).sort((r,a)=>a.score-r.score);for(const r of o){const a=[];let l=!0;for(const c of r.inputSignatures){const d=this.matchItemBySignature(t,c,a,n);if(!d){l=!1;break}a.push(d)}if(l&&a.length>=2)return{inputs:a,weights:r.weights}}return null}rememberRecipe(t,e,i,n,o,r){const a=n.map(c=>c.signature??yt(c.mix));t.learnedRecipes??(t.learnedRecipes=[]);const l=t.learnedRecipes.find(c=>c.intent===e&&c.process===i&&c.inputSignatures.length===a.length&&c.inputSignatures.every((d,u)=>d===a[u]));if(l){r>l.score&&(l.score=r,l.weights=o??l.weights);return}t.learnedRecipes.push({intent:e,process:i,inputSignatures:a,weights:o,score:r})}chooseWeights(t,e){const i=[];for(let n=0;n<t;n++){const o=n<e?.5+.4*this.random.next():.1+.4*this.random.next();i.push(Number(o.toFixed(3)))}return i}scoreResult(t,e,i){if(t==="food"||t==="drink"||t==="medicine"){const c=be(e,i.mix,mt(ut),20,1),d=c.after.energy-c.before.energy,u=c.before.hungerSignal-c.after.hungerSignal,h=c.before.thirstSignal-c.after.thirstSignal,m=Math.max(0,-c.essentialDelta.ATP)+Math.max(0,-c.essentialDelta.H2O)+Math.max(0,Math.abs(c.essentialDelta.PH)-.05)+Math.max(0,c.essentialDelta.O2<-.05?-c.essentialDelta.O2:0);return d*2+u+h-m}const n=i.traits??{},o=(i.mix.SLAG??0)+(i.mix.MINERAL_DUST??0),r=1-(n.reactivity??0),a=n.metalness??0,l=n.mineralness??0;return t==="weapon"||t==="tool"?1.2*a+.8*r-.5*o:l+.5*r-.4*o}actionNPCWork(){var w,O,P;if(this.state.npcs.length===0)return;const t=this.random.choice(this.state.npcs);let e=this.getCraftProfileForJob(t.job);if(e!=null&&e.requiredTalent&&!((w=t.talents)!=null&&w.includes(e.requiredTalent))||!e)return;let i;t.job==="Miner"?i=this.state.worldMap.getPOI("mine"):t.job==="Hunter"||t.job==="Fisher"||t.job==="Farmer"||t.job==="Rancher"||t.job==="Lumberjack"?i=this.state.worldMap.getPOI("forest"):t.job==="Merchant"&&(i=this.state.worldMap.getPOI("market"));const n=this.getNpcPoi(t)??this.state.worldMap.getPOI("market"),o=((O=i??n)==null?void 0:O.id)??this.resolveDefaultPoiId(),r=L(this.stockpilesByPoi,o),a=this.computeLocalScarcity(o,"food"),l=this.computeLocalScarcity(o,"drink"),c=this.computeLocalScarcity(o,"tool"),d=this.computeLocalScarcity(o,"material");if(e.intent==="weapon"&&c>.6?e={...e,intent:"tool"}:e.intent==="tool"||e.intent==="material"?c>d+.2?e={...e,intent:"tool",process:e.process}:d>c+.2&&(e={...e,intent:"material",process:e.process}):e.intent==="food"&&l>.65&&l>a&&(e={...e,intent:"drink",process:"brew",requiredTags:[["drink"]]}),i&&!this.isNPCAtPOI(t,i)){if(!t.targetPos){t.targetPos={x:i.pos.x,y:i.pos.y};const x=V(t.pos,t.targetPos,this.state.worldMap);x.length>0?t.currentPath=x:t.targetPos=void 0}return}const u=this.pickLearnedRecipe(t,e.intent,e.process,r);let h=(u==null?void 0:u.inputs)??null,m=u==null?void 0:u.weights;if(h||(h=this.acquireInputs(t,e.requiredTags,e.optionalTags??[],r),h&&(m=this.chooseWeights(h.length,e.requiredTags.length))),!h){if(this.performGatheringJob(t,r,o))return;this.collectFromStockpile(t,e.requiredTags,r,o);return}const f=h.map(x=>x.definition);if(f.length<2){if(this.performGatheringJob(t,r,o))return;this.collectFromStockpile(t,e.requiredTags,r,o);return}for(const x of h)x.source==="inventory"?tt(t,x.definition.id,1,this.indices):F(r,x.definition.id,1);const y=ye(this.random,this.itemRegistry,mt(ut),f,e.process,e.process==="forge"?"Forge product":e.process==="refine"?"Refined material":`${e.intent} ${e.process}`,m);it(r,y,1),this.random.next()>.7&&(F(r,y,1),G(t,y,1,this.indices));const b=this.itemRegistry.getItem(y);if(b){const x=this.scoreResult(e.intent,((P=t.chemistry)==null?void 0:P.body)??{},b);x>.2&&this.rememberRecipe(t,e.intent,e.process,f,m,x),this.addReportLog(`${t.name} worked as a ${t.job} and produced ${b.displayName??b.name}, storing it at ${o}.`)}W(t,"hunger",-5),W(t,"fun",-2)}actionNPCEat(){var a,l;if(this.state.npcs.length===0)return;const t=this.random.choice(this.state.npcs),e=this.itemRegistry.list().filter(c=>this.isEdible(c));let i=!1;const{stockpile:n,poiId:o}=this.getNpcStockpile(t),r=e.find(c=>et(t,c.id,1));if(r){const d=((a=r.tags)==null?void 0:a.includes("drink"))?"drank":"ate";tt(t,r.id,1,this.indices),E(t,"hunger",30),this.addReportLog(`${t.name} ${d} ${this.describeItem(r.id)}.`),i=!0}else{const c=e.filter(d=>Q(n,d.id,1));if(c.length>0){const d=this.random.choice(c),h=((l=d.tags)==null?void 0:l.includes("drink"))?"drank":"ate";F(n,d.id,1),E(t,"hunger",25),this.addReportLog(`${t.name} ${h} ${this.describeItem(d.id)} at ${o}.`),i=!0}else{const d=this.state.worldMap.getPOI("market");if(d&&this.isNPCAtPOI(t,d)){const u=this.random.next()>.5?"food":"drink",h=this.getPriceMultiplier(o,u),m=Math.round(this.random.nextInt(5,15)*h);if(j(this.state,t.id,"city",m)){const y=this.ensureProceduralItemId("food",I=>e.includes(I));G(t,y,1,this.indices),this.addReportLog(`${t.name} bought ${this.describeItem(y)} for ${m} coins.`),tt(t,y,1,this.indices),E(t,"hunger",25),i=!0}}else if(d&&!t.targetPos){t.targetPos={x:d.pos.x,y:d.pos.y};const u=V(t.pos,t.targetPos,this.state.worldMap);u.length>0?t.currentPath=u:t.targetPos=void 0}}}i||this.addReportLog(`${t.name} could not find food or drink.`)}actionGuildEvent(){const t=["A new adventurer arrived at the guild.","The guild received an anonymous donation.","A rumor of distant treasures spreads through the tavern.","The guild council met to discuss new contracts.","Local merchants report increased sales."],e=this.random.choice(t);this.addReportLog(e)}actionRandomEncounter(){if(this.state.npcs.length===0)return;const t=this.random.choice(this.state.npcs),e=this.state.worldMap.getPOI("tavern");if(e&&this.isNPCAtPOI(t,e)){const n=this.getEntitiesNearPosition(t.pos.x,t.pos.y,3).filter(o=>o.id!==t.id);if(n.length>0){const o=this.random.choice(n);Tt(this.state,t.id,o.id,"chat"),this.addReportLog(`${t.name} chatted with ${o.name} at the tavern.`),E(t,"social",10),E(t,"fun",8),E(o,"social",10),E(o,"fun",8)}else{const o=[`${t.name} joined a party at the tavern.`,`${t.name} heard tales of distant lands.`],r=this.random.choice(o);this.addReportLog(r),E(t,"social",5),E(t,"fun",10)}}else{const i=[`${t.name} found an old coin along the road.`,`${t.name} helped a lost traveler.`,`${t.name} witnessed a duel in the plaza.`],n=this.random.choice(i);this.addReportLog(n),E(t,"fun",3)}}computeTagQuantity(t,e){var o;const i=L(this.stockpilesByPoi,t);let n=0;for(const[r,a]of Object.entries(i)){const l=this.itemRegistry.getItem(r);(o=l==null?void 0:l.tags)!=null&&o.includes(e)&&(n+=a)}return n}computeLocalScarcity(t,e){const o=1-this.computeTagQuantity(t,e)/50;return Math.max(0,Math.min(1,o))}getPriceMultiplier(t,e){return 1+1.5*this.computeLocalScarcity(t,e)}actionMarketFluctuation(){var r;if(this.lastMarketFluctuationDay===this.state.day)return;this.lastMarketFluctuationDay=this.state.day;const t=((r=this.state.worldMap.getPOI("market"))==null?void 0:r.id)??this.resolveDefaultPoiId(),e=this.computeLocalScarcity(t,"food"),i=this.computeLocalScarcity(t,"drink"),n=this.computeLocalScarcity(t,"tool"),o=this.computeLocalScarcity(t,"material");if(e>.7)this.addReportLog("Food scarcity rumors impact the local market.");else if(e<.2)this.addReportLog("An abundance of food pushed prices down this week.");else if(i>.7)this.addReportLog("Water and drinks are scarce and prices have risen.");else if(n>.7)this.addReportLog("Tool demand increased while local stocks remain low.");else if(o<.2)this.addReportLog("Refined materials are oversupplied; prices are falling.");else{const a=["Food prices ticked up slightly.","The weapons market is hot this week.","Potions are cheaper due to oversupply.","Demand for tools increased.","Scarcity rumors ripple through the market."],l=this.random.choice(a);this.addReportLog(l)}this.actionTraderFlow()}actionTraderFlow(){const t=this.state.worldMap.getPOIs();if(t.length<2)return;const e=["food","drink","tool","material"];let i=null;for(const c of e){let d=null,u=null;for(const h of t){const m=this.computeLocalScarcity(h.id,c);(!d||m<d.scarcity)&&(d={poi:h,scarcity:m}),(!u||m>u.scarcity)&&(u={poi:h,scarcity:m})}if(d&&u){const h=u.scarcity-d.scarcity;h>.3&&this.computeTagQuantity(d.poi.id,c)>0&&(!i||h>i.scarcityDelta)&&(i={tag:c,from:d.poi,to:u.poi,scarcityDelta:h})}}if(!i)return;const n=L(this.stockpilesByPoi,i.from.id),o=L(this.stockpilesByPoi,i.to.id),r=st(n,this.itemRegistry,i.tag,this.random);if(!r)return;const a=Math.max(1,Math.min(3,Math.floor((this.computeTagQuantity(i.from.id,i.tag)||1)/4)));F(n,r.id,a)&&(it(o,r.id,a),this.addReportLog(`A trader carried ${a}x ${r.displayName??r.name} from ${i.from.name} to ${i.to.name}.`))}completeQuest(t){const e=this.state.quests.find(o=>o.id===t);if(!e||e.completed)return!1;e.completed=!0;let i=!1;this.state.guildTreasury!==void 0&&this.state.guildTreasury>=e.reward?i=j(this.state,"guild","player",e.reward):i=j(this.state,"city","player",e.reward),i||(this.state.player.gold+=e.reward,console.warn("[Economy] Quest reward transfer failed, adding gold directly")),this.state.player.experience+=e.reward;const n=this.state.player.level*100;return this.state.player.experience>=n&&(this.state.player.level++,this.state.player.experience-=n),this.addReportLog(`Quest "${e.title}" completed! Reward: ${e.reward} coins.`),this.notify(),!0}update(t){if(this.state.currentTime+=t,this.state.simRunning){const e=Math.floor(this.state.timeOfDaySec),i=t/1e3;for(this.state.timeOfDaySec+=i;this.state.timeOfDaySec>=kt;)this.state.timeOfDaySec-=kt,this.state.day++,this.addReportLog(`--- Day ${this.state.day} ---`);if(Math.floor(this.state.timeOfDaySec)!==e&&this.notify(),this.state.currentTime-this.lastActionTick>=ft){this.lastActionTick=this.state.currentTime,this.applyChemistryTick(ft/1e3),this.maybeSynthesizeProceduralItem(ft),this.executeWorldActions();const o=Zt(this.state,this.initialEconomyGold);o.valid||console.error("[Economy] Invariant violation detected!",o)}}}addGold(t){this.state.player.gold+=t,this.notify()}applyChemistryTick(t){for(const e of this.state.npcs){const i=he(e,vt,t);ee(e,i)}}pickCatalogItem(t){const e=this.itemRegistry.list(),i=t?e.filter(t):e;if(i.length!==0)return this.random.choice(i)}synthesizeProceduralItem(t){const e=this.pickCatalogItem();if(!e)return null;const i={O2:.5+.5*this.random.next(),H2O:.2+.4*this.random.next(),TEMP:.5+.5*this.random.next()},n=Bt(J(e.mix,i),{temperature:i.TEMP,tags:{rainfall:i.H2O,trust:this.random.next()},steps:4,dt:.5},mt(ut)),r=(t?`Procedural ${t}`:"Procedural Item").trim();return this.itemRegistry.spawnFromMix(r,n)}ensureProceduralItemId(t,e){const i=this.pickCatalogItem(e);if(i)return i.id;const n=this.synthesizeProceduralItem(t);if(n)return n;const o={GLU:.1+.4*this.random.next(),FRUCT:.05*this.random.next(),H2O:.2+.6*this.random.next()};return this.itemRegistry.spawnFromMix(`${t} fallback`,o)}isEdible(t){if(!t.tags)return!1;const e=t.tags.some(n=>n==="food"||n==="drink"),i=t.tags.includes("ore")||t.tags.includes("metal")||t.tags.includes("stone");return e&&!i}describeItem(t){var e;return((e=this.itemRegistry.getItem(t))==null?void 0:e.name)??t}maybeSynthesizeProceduralItem(t){if(this.timeSinceLastItemSynthesis+=t,this.timeSinceLastItemSynthesis<1e4||this.state.npcs.length===0)return;this.timeSinceLastItemSynthesis=0;const e=this.synthesizeProceduralItem("item");if(!e)return;const i=this.random.choice(this.state.npcs);G(i,e,1,this.indices),this.addReportLog(`${i.name} acquired a new procedural item: ${this.describeItem(e)}.`)}getItemMix(t){return this.itemRegistry.getMix(t)}spawnItemFromMix(t,e){return this.itemRegistry.spawnFromMix(t,e)}}const ot={[H.Road]:{glyph:"╫",name:"Cobbled road"},[H.Building]:{glyph:"▓",name:"Dense buildings"},[H.Water]:{glyph:"≈",name:"Waterfront"}},B={topLeft:"╔",topRight:"╗",bottomLeft:"╚",bottomRight:"╝",horizontal:"═",vertical:"║"},Ct=[{label:"Road",glyph:ot[H.Road].glyph},{label:"Building",glyph:ot[H.Building].glyph},{label:"Water",glyph:ot[H.Water].glyph},{label:"POI",glyph:"◎"},{label:"NPC",glyph:"@"},{label:"En route",glyph:">"},{label:"Crowd",glyph:"*"}];class Se{constructor(t){p(this,"rootElement");p(this,"questCompleteHandler");p(this,"lastRenderTime",0);p(this,"renderThrottleMs",250);p(this,"pendingRender",!1);p(this,"engineToggle");p(this,"latestAsciiMap","");p(this,"activeTab","dashboard");p(this,"lastState");this.rootElement=t,this.rootElement.addEventListener("click",e=>{var n,o;const i=e.target;if(i instanceof HTMLButtonElement){if(i.dataset.questId)(n=this.questCompleteHandler)==null||n.call(this,i.dataset.questId);else if(i.dataset.action==="toggle-simulation")(o=this.engineToggle)==null||o.call(this);else if(i.dataset.tab){const r=i.dataset.tab;r!==this.activeTab&&(this.activeTab=r,this.lastState&&this.questCompleteHandler&&this.render(this.lastState,this.questCompleteHandler,this.engineToggle))}}})}render(t,e,i){this.lastState=t,this.questCompleteHandler=e,this.engineToggle=i;const n=performance.now(),o=n-this.lastRenderTime;if(o<this.renderThrottleMs){this.pendingRender||(this.pendingRender=!0,setTimeout(()=>{this.pendingRender=!1,this.render(t,e,i)},this.renderThrottleMs-o));return}this.lastRenderTime=n;const r=Math.floor(t.timeOfDaySec/3600),a=Math.floor(t.timeOfDaySec%3600/60),l=`${r.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`,c=t.simRunning?"gm-action-btn gm-action-btn-active":"gm-action-btn",d=t.simRunning?"Pause simulation":"Start simulation",u=this.renderAsciiMap(t);this.latestAsciiMap=u,this.rootElement.innerHTML=`
      <div class="gm-stage">
        <div class="gm-layout">
          <!-- Left action bar -->
          <aside class="gm-actions" aria-label="Actions">
            <button class="${c}" data-action="toggle-simulation" title="${d}">🌞</button>
            <button class="gm-action-btn" data-action="quests" title="Quests">⚔️</button>
            <button class="gm-action-btn" data-action="tavern" title="Tavern">🍺</button>
            <button class="gm-action-btn" data-action="market" title="Market">🧺</button>
            <button class="gm-action-btn" data-action="settings" title="Settings">⚙️</button>
          </aside>

          <!-- Center room -->
          <main class="gm-room">
            <div class="gm-tabs" role="tablist" aria-label="Views">
              <button class="gm-tab-btn ${this.activeTab==="dashboard"?"gm-tab-btn-active":""}" data-tab="dashboard" role="tab" aria-selected="${this.activeTab==="dashboard"}">Dashboard</button>
              <button class="gm-tab-btn ${this.activeTab==="map"?"gm-tab-btn-active":""}" data-tab="map" role="tab" aria-selected="${this.activeTab==="map"}">Full map</button>
            </div>

            <div class="gm-tab-panel ${this.activeTab==="dashboard"?"gm-tab-panel-active":""}" role="tabpanel" aria-hidden="${this.activeTab!=="dashboard"}">
            <div class="gm-hud">
              <div class="gm-hud-card">
                <div class="gm-hud-title">Day</div>
                <div class="gm-hud-value">${t.day}</div>
              </div>

              <div class="gm-hud-card">
                <div class="gm-hud-title">Time</div>
                <div class="gm-hud-value">${l}</div>
              </div>

              <div class="gm-hud-card">
                <div class="gm-hud-title">Gold</div>
                <div class="gm-hud-value gm-hud-gold">${t.player.gold} pix</div>
              </div>

              <div class="gm-hud-card">
                <div class="gm-hud-title">Guildmaster</div>
                <div class="gm-hud-value">${t.player.name}</div>
              </div>
            </div>

            <div class="gm-room-content">
              <section class="gm-card">
                <h2>Guild Hall Interior</h2>
                <div class="gm-small">
                  The "room" here is just a panel for now — later NPCs can walk behind it on a canvas layer.
                </div>
                <div style="height: 10px"></div>
                <div class="gm-list">
                  <div class="gm-quest">
                    <div class="gm-quest-title">
                      <span>📌 Status</span>
                      <span>Level ${t.player.level}</span>
                    </div>
                    <div class="gm-quest-desc">
                      Experience: ${t.player.experience} XP | NPCs: ${t.npcs.length} | ${t.simRunning?"▶️ Running":"⏸️ Paused"}
                    </div>
                  </div>

                  <div class="gm-quest">
                    <div class="gm-quest-title">
                      <span>🏰 Goal</span>
                      <span style="color: rgba(255,255,255,0.75)">Rebuild the Guild</span>
                    </div>
                    <div class="gm-quest-desc">
                      Sponsor adventurers, organize quests, and control the flow of gold.
                    </div>
                  </div>
                </div>
              </section>

              <section class="gm-card gm-map-card">
                <div class="gm-map-header">
                  <div>
                    <h2>City Map (ASCII)</h2>
                <div class="gm-small">
                  NPCs wander between points of interest. ◎ marks POIs, NPC initials overlay the cobbled paths (╫), > shows travellers, and * highlights crowded tiles.
                </div>
              </div>
              <div class="gm-map-legend gm-small">
                ${Ct.map(h=>`<div class="gm-map-chip"><span class="gm-map-glyph">${h.glyph}</span>${h.label}</div>`).join("")}
              </div>
            </div>
            <pre class="gm-ascii-map" aria-label="ASCII city map">${u}</pre>
          </section>

              <section class="gm-card">
                <h2>Quest Board</h2>
                <div class="gm-scroll" style="max-height: 100%;">
                  <div class="gm-list">
                    ${t.quests.slice().reverse().map(h=>{const m=h.completed;return`
                          <div class="gm-quest" style="${m?"border-left-color: rgba(0, 255, 136, 0.7);":""}">
                            <div class="gm-quest-title">
                              <span>${h.title}${m?" ✓":""}</span>
                              <span class="gm-hud-gold">${h.reward}💰</span>
                            </div>
                            <div class="gm-quest-desc">${h.description}</div>
                            ${m?'<div class="gm-small" style="margin-top:8px; color: rgba(0,255,136,0.9); font-weight: 900;">✓ Completed</div>':`<button class="gm-quest-btn" data-quest-id="${h.id}">Complete</button>`}
                          </div>
                        `}).join("")}
                  </div>
                </div>
              </section>
            </div>
            </div>

            <div class="gm-tab-panel ${this.activeTab==="map"?"gm-tab-panel-active":""}" role="tabpanel" aria-hidden="${this.activeTab!=="map"}">
              <section class="gm-card gm-full-map-card">
                <div class="gm-map-header">
                  <div>
                    <h2>City Map (full)</h2>
                    <div class="gm-small">Live ASCII view without scrolling the main dashboard.</div>
                  </div>
                  <div class="gm-map-legend gm-small">
                    ${Ct.map(h=>`<div class="gm-map-chip"><span class="gm-map-glyph">${h.glyph}</span>${h.label}</div>`).join("")}
                  </div>
                </div>
                <pre class="gm-ascii-map gm-ascii-map-full" aria-label="Full ASCII city map">${u}</pre>
              </section>
            </div>
          </main>

          <!-- Right panels -->
          <aside class="gm-right">
            <section class="gm-card">
              <h2>Summary</h2>
              <div class="gm-small">
                Day ${t.day}, ${l}. The guild has ${t.npcs.length} NPCs working and living in the city.
                ${t.simRunning?"The simulation is running.":"Click the ☀️ button to start the simulation."}
              </div>
            </section>

            <section class="gm-card">
              <h2>Journal</h2>
              <div class="gm-scroll gm-small" id="gm-log">
                ${t.reportLog.slice().reverse().map(h=>`<div>• ${h.message}</div>`).join("")}
              </div>
            </section>
          </aside>
        </div>
      </div>
    `}renderAsciiMap(t){const e=t.worldMap,i=2,n=Math.ceil(e.width/i),o=Math.ceil(e.height/i),r=new Map;t.npcs.forEach(m=>{const f=Math.floor(m.pos.x/i),y=Math.floor(m.pos.y/i),I=`${f},${y}`,b=r.get(I),w=m.name.charAt(0).toUpperCase()||"@";b?r.set(I,{count:b.count+1,label:b.count+1>1?"*":b.label,hasTarget:b.hasTarget||!!m.targetPos}):r.set(I,{count:1,label:w,hasTarget:!!m.targetPos})});const a=new Map;e.getPOIs().forEach(m=>{const f=Math.floor(m.pos.x/i),y=Math.floor(m.pos.y/i),I=`${f},${y}`;a.set(I,m.name.charAt(0).toUpperCase())});const l=[];for(let m=0;m<o;m++){let f="";for(let y=0;y<n;y++){const I=`${y},${m}`,b=r.get(I);if(b){f+=b.count>1?"*":b.hasTarget?">":b.label;continue}const w=a.get(I);if(w){f+=w;continue}const O=e.getTile(y*i,m*i);O?f+=ot[O.type].glyph:f+=" "}l.push(f)}const c=B.horizontal.repeat(n),d=`${B.topLeft}${c}${B.topRight}`,u=`${B.bottomLeft}${c}${B.bottomRight}`,h=l.map(m=>`${B.vertical}${m}${B.vertical}`);return[d,...h,u].join(`
`)}}function At(){const s=document.getElementById("app");if(!s){console.error("App root element not found");return}const t=new xe,e=new Se(s),i=a=>{t.completeQuest(a)&&console.log(`Quest ${a} completed!`)},n=()=>{t.toggle()};e.render(t.getState(),i,n),t.subscribe(a=>{e.render(a,i,n)});let o=performance.now();function r(a){const l=a-o;o=a,t.update(l),requestAnimationFrame(r)}requestAnimationFrame(r),console.log("GuildMaster game initialized!")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",At):At();
//# sourceMappingURL=index-PUIjjGqd.js.map
